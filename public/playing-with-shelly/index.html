

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Playing with Shelly - Zoltán&#39;s Blog</title>
  <meta name="description" content="Finally I can turn on the lights from CLI">
  <meta name="author" content="Zoltán Balogh"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Zoltán\u0027s Blog",
    
    "url": "https:\/\/bzoltan1.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/bzoltan1.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/bzoltan1.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/bzoltan1.github.io\/playing-with-shelly\/",
          "name": "Playing with shelly"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Playing with Shelly",
  "description" : "For xmass I got few Shelly lamps to play with. Shelly lamps are simple IoT devices. Super easy to install, configure and use. The Youtube is full with instructions on what can be done with these smart lamps. Naturally my main motivation was to figure out how to hack these devices and how ready my openSUSE servers are with tools and services (spoiler: they are ready)\nLook daddy no cloud Needless to say that like most smart home automation devices the Shelly lamps can be operated via the Shelly cloud.",
  "inLanguage" : "en",
  "wordCount":  741 ,
  "datePublished" : "2021-12-28T10:35:50\u002b03:00",
  "dateModified" : "2021-12-28T10:35:50\u002b03:00",
  "image" : "https:\/\/bzoltan1.github.io\/avatar.png",
  "keywords" : [ "mqtt, shelly, iot, mosquitto, opensuse" ],
  "mainEntityOfPage" : "https:\/\/bzoltan1.github.io\/playing-with-shelly\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/bzoltan1.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/bzoltan1.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Playing with Shelly" />
<meta property="og:description" content="Finally I can turn on the lights from CLI">
<meta property="og:image" content="https://bzoltan1.github.io/avatar.png" />
<meta property="og:url" content="https://bzoltan1.github.io/playing-with-shelly/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Zoltán&#39;s Blog" />

  <meta name="twitter:title" content="Playing with Shelly" />
  <meta name="twitter:description" content="Finally I can turn on the lights from CLI">
  <meta name="twitter:image" content="https://bzoltan1.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://bzoltan1.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://bzoltan1.github.io/index.xml" type="application/rss+xml" title="Zoltán&#39;s Blog"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://bzoltan1.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://bzoltan1.github.io/css/syntax.css" /><link rel="stylesheet" href="https://bzoltan1.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://bzoltan1.github.io/">Zoltán&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="https://bzoltan1.github.io/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://bzoltan1.github.io/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="Home" href="https://bzoltan1.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://bzoltan1.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Zoltán&#39;s Blog" href="https://bzoltan1.github.io/">
            <img class="avatar-img" src="https://bzoltan1.github.io/avatar.png" alt="Zoltán&#39;s Blog" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Playing with Shelly</h1>
              
              
              
                
                  <h2 class="post-subheading">Finally I can turn on the lights from CLI</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on December 28, 2021
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>For xmass I got few Shelly lamps to play with. Shelly lamps are simple IoT devices. Super easy to install, configure and use. The Youtube is full with instructions on what can be done with these smart lamps.
Naturally my main motivation was to figure out how to hack these devices and how ready my openSUSE servers are with tools and services (spoiler: they are ready)</p>
<h3 id="look-daddy-no-cloud">Look daddy no cloud</h3>
<p>Needless to say that like most smart home automation devices the Shelly lamps can be operated via the Shelly cloud. I may cover that area in the next post. But now I am interested in what can be done without the cloud. After all, one big selling point of the Shelly devices is that they are fully operable and functional even without Internet connection just on a WiFi LAN. It means that if I am concerned about the security of my home infrastructure I have an option not to expose my smart devices.</p>
<h3 id="here-is-what-i-have-done">Here is what I have done</h3>
<p>So I plugged in the lamp in my study, configured it to connect to my WiFi network and enabled the MQTT.</p>
<p>MQTT (Message Queue Telemetry Transport), is a lightweight communication protocol based on the publisher/subscriber concep and widely used in the Internet of Things. MQTT is often used for receiving parameters measured by sensors and to send simple commands to IoT devices like my lamp.</p>
<p>In order to use MQTT protocol I need a broker server in my network.</p>
<p>The mosquitto package is available in openSUSE and it is a widely used message broker that implements the MQ Telemetry Transport protocol versions 3.1 and 3.1.1.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># zypper install mosquitto</span>
</code></pre></div><p>On my openSUSE Tumbleweed it installs  libcjson1 libmosquitto1 libwebsockets12 mosquitto.  I enable and start the mosquitto server:</p>
<p>The mosquitto server can be configured to require client authentication (username and password). The credentials are transmitted in clear text, so it is not very secure without proper transport encryption. However using username and password authentication does provide some level of security and as I am playing on my reasonable well guarded LAN I am fine with this level of security.
First I created password file for the server:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># mosquitto_passwd -c /etc/mosquitto/passwd shelly</span>
</code></pre></div><p>Where shelly is the username. This command will ask for password and create the /etc/mosquitto/passwd file. Naturally the mosquitto server need to be configured to use authentication based on the content of this file. I added few extra options to the  /etc/mosquito/mosquitto.conf :</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>...<span class="o">]</span>
listener <span class="m">1883</span>
allow_anonymous <span class="nb">true</span>
per_listener_settings <span class="nb">true</span>
password_file /etc/mosquitto/passwd
</code></pre></div><p>Finally I starter and enabled the service:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># systemctl start mosquitto</span>
<span class="c1"># systemctl enable mosquitto</span>
</code></pre></div><p>I also need to install the client applications. Note that it does not need to be used on the mqtt server. I use it on my laptop.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># zypper install  mosquitto-clients</span>
</code></pre></div><p>Now I need to discover my MQTT enabled Shelly device(s) on my LAN. I love single purpose oneliners:</p>
<pre><code>for IP in $(arp-scan 192.168.1.0/24 --plain|awk '{print $1}'); do curl -s http://$IP/status |python -m json.tool 2&gt;&amp;1|grep -v No|egrep &quot;\&quot;ip|\&quot;mqtt\&quot;&quot; -A1|egrep -v &quot;\-\-|rssi&quot;; done
</code></pre><p>Once I found the IP address of my Shelly lamp I can ask it for the settings details:</p>
<pre><code>curl -s http://192.168.1.122/settings|python -m json.tool
</code></pre><p>It tells me for example that the mqtt id of my lamp is ShellyBulbDuo-E8DB84A9E51B.</p>
<p>Now I have all the services, tools and information to adjust my Shelly lamp from command line.</p>
<p>First I need to set few variables</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">export</span> <span class="nv">MQTT_SERVER</span><span class="o">=</span><span class="s2">&#34;192.168.1.123&#34;</span>
$ <span class="nb">export</span> <span class="nv">MQTT_PORT</span><span class="o">=</span><span class="m">1883</span>
$ <span class="nb">export</span> <span class="nv">MQTT_USER</span><span class="o">=</span><span class="s2">&#34;shelly&#34;</span>
$ <span class="nb">export</span> <span class="nv">MQTT_PW</span><span class="o">=</span><span class="s2">&#34;shelly&#34;</span>
$ <span class="nb">export</span> <span class="nv">DEVICE_ID</span><span class="o">=</span><span class="s2">&#34;ShellyBulbDuo-E8DB84A9E51B&#34;</span>
</code></pre></div><pre><code>mosquitto_pub -h ${MQTT_SERVER} -p ${MQTT_PORT} -u ${MQTT_USER} -P ${MQTT_PW} -t shellies/${DEVICE_ID}/light/0/set  -m '{&quot;brightness&quot;:33, &quot;white&quot;: 0, &quot;temp&quot;: 2700, &quot;turn&quot;: &quot;on&quot;, &quot;transition&quot;: 2000 }'
</code></pre><p>One handy command I have learned about is to subscribe to all announcements and figure out more about the mqtt devices, topics and properties.</p>
<pre><code>mosquitto_sub -h ${MQTT_SERVER} -p ${MQTT_PORT} -u ${MQTT_USER} -P ${MQTT_PW} -t '#' -v
</code></pre><h3 id="summary">Summary</h3>
<p>All in all it was a really easy and fast kick start. Playing with mqtt is fun and after installing few extra packages I could operate my Shelly lamp from my openSUSE. I could set up cron jobs to turn off or on the lamp. I could trigger blinking when something happens on my server. I set up bash aliases to change the ambiance of my study room.
And what is really cool that I could do it without exposing my smart device to a 3rd party cloud provided and without opening up security holes on my network.</p>


        
          <div class="blog-tags">
            
              
              <a href="https://bzoltan1.github.io/tags/mqtt/">mqtt</a>&nbsp;
            
              
              <a href="https://bzoltan1.github.io/tags/shelly/">shelly</a>&nbsp;
            
              
              <a href="https://bzoltan1.github.io/tags/iot/">iot</a>&nbsp;
            
              
              <a href="https://bzoltan1.github.io/tags/mosquitto/">mosquitto</a>&nbsp;
            
              
              <a href="https://bzoltan1.github.io/tags/opensuse/">opensuse</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://bzoltan1.github.io/measuring-web-traffic-with-matomo/" data-toggle="tooltip" data-placement="top" title="Measuring web traffic with Matomo">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://bzoltan1.github.io/contributing-to-sle/opensuse/" data-toggle="tooltip" data-placement="top" title="Contributing to SLE/openSUSE">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2021
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://bzoltan1.github.io/">Zoltán&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://bzoltan1.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://bzoltan1.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

